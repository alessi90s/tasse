<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Forfettario 2025 â€¢ INPS Commercianti/Artigiani</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#ecf2fc; --card:#fff; --text:#0f172a; --muted:#64748b; --border:#e6e6eb;
  --primary:#7586fe; --accent:#b491ff; --sun:#ffd791; --rose:#ff9696; --tanger:#fe795b;
  --shadow:0 14px 28px rgba(2,6,23,.08); --radius:14px;
}
*{box-sizing:border-box} html{font-size:17px}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased}
.wrap{max-width:920px;margin:28px auto;padding:0 14px}
header{text-align:center;margin-bottom:12px}
h1{margin:0 0 10px;font-size:1.9rem;line-height:1.2;font-weight:900;letter-spacing:-.01em}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;background:var(--sun);border:1px solid #f3d07e;font-weight:900}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
.pad{padding:18px}

/* form */
.form-vertical{display:flex;flex-direction:column;row-gap:18px;max-width:760px;margin:0 auto}
label{display:block;margin:0 0 6px;font-weight:900;text-decoration:underline;text-underline-offset:3px}
input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:1rem}
input:focus,select:focus,.chip:focus-visible,.btn:focus-visible,.tab-btn:focus-visible{outline:none;border-color:#c7d2fe;box-shadow:0 0 0 3px #e0e7ff}
.field-hint{color:var(--muted);font-size:.92rem;margin-top:6px}

/* chips */
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.chip{height:40px;padding:0 14px;display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:9999px;background:#fff;cursor:pointer;font-weight:900}
.chip:hover{border-color:#bcd0ff}
.chip.active{background:#111827;color:#fff;border-color:#111827}

/* actions */
.actions{display:flex;flex-direction:column;gap:10px;align-items:center;margin-top:6px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:0;border-radius:10px;font-weight:900;cursor:pointer;transition:transform .05s}
.btn:active{transform:translateY(1px)}
.btn.primary{background:var(--primary);color:#fff;height:50px;padding:0 18px;max-width:420px;width:100%}
.btn.secondary{background:#fff;border:1px solid var(--border);height:38px;padding:0 12px}
.btn.print{background:#fff;border:1px solid var(--border);height:38px;padding:0 12px}
.sub-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}

/* advanced */
details.adv>summary{
  cursor:pointer;list-style:none;padding:10px 14px;border:1px solid var(--border);border-radius:12px;
  background:#fff;display:flex;align-items:center;gap:10px;font-weight:900
}
details.adv>summary::before{content:"";width:10px;height:10px;border:2px solid #111827;border-left:0;border-top:0;transform:rotate(45deg);transition:.2s}
details.adv[open]>summary::before{transform:rotate(-135deg)}
details.adv[open]>summary{background:#111827;color:#fff;border-color:#111827}
.adv-panel{margin-top:12px;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 24px rgba(2,6,23,.06);padding:16px}
.adv-grid{display:grid;gap:16px}
.ibox{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 6px 16px rgba(2,6,23,.04)}
.ibox .bar{display:flex;align-items:center;gap:8px;margin:-4px -4px 12px;padding:8px 10px;border-radius:8px;background:#0F1D40;color:#fff;font-weight:900}
.grid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.radio-row{display:flex;gap:10px;flex-wrap:wrap}
.tag{display:inline-block;padding:2px 8px;border-radius:9999px;background:#eef2ff;border:1px solid #c7d2fe;font-weight:800;font-size:.85em}

/* tabs */
.tabbar-wrap{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px}
.tab-bar{position:relative;display:flex;gap:8px;overflow:auto hidden}
.tab-btn{position:relative;border:1px solid var(--border);background:var(--sun);border-radius:9999px;padding:6px 12px;height:34px;cursor:pointer;font-weight:900;white-space:nowrap}
.tab-btn.active{background:#ffe6b3;border-color:#f3d07e}
.inkbar{position:absolute;height:2px;background:#1d4ed8;border-radius:2px;bottom:-6px;left:0;width:0;transition:all .25s}
.tab{display:none}.tab.active{display:block}

/* view toggle */
.viewctrl{display:flex;align-items:center;gap:8px}
#viewLabel{font-weight:800;color:#475569}
.switch{position:relative;display:inline-block;width:44px;height:24px}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#e5e7eb;border-radius:999px;transition:.2s}
.slider:before{content:"";position:absolute;height:18px;width:18px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 2px rgba(0,0,0,.3)}
.switch input:checked + .slider{background:#60a5fa}
.switch input:checked + .slider:before{transform:translateX(20px)}

/* kpi & tables */
.kpis{display:grid;gap:12px;margin-top:8px}
@media(min-width:640px){.kpis{grid-template-columns:repeat(2,1fr)}}
@media(min-width:920px){.kpis{grid-template-columns:repeat(3,1fr)}}
.kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;box-shadow:0 6px 16px rgba(2,6,23,.04);display:flex;flex-direction:column;justify-content:center;min-height:120px}
.kpi h3{margin:0 0 6px;font-size:.78rem;color:#64748b;text-transform:uppercase;font-weight:800}
.kpi .big{font-size:1.35rem;font-weight:900;font-variant-numeric:tabular-nums}
table{width:100%;border-collapse:collapse;margin-top:6px;font-size:.98rem;background:#fff;border:1px solid var(--border);box-shadow:0 6px 16px rgba(2,6,23,.04);page-break-inside:avoid}
th,td{border:1px solid var(--border);padding:12px 8px}
th{background:#f7f7fb;color:#475569;font-weight:800}
tfoot tr th{background:#f1f5f9;font-weight:800}
tr:hover{background:#f8faff}
.right{text-align:right;font-variant-numeric:tabular-nums}

/* sections + copy */
.section{position:relative;border-left:4px solid #e5e7eb;padding:14px;margin:12px 0 8px;border-radius:10px;background:#fff;border:1px solid var(--border);box-shadow:0 6px 16px rgba(2,6,23,.04)}
.section.inps{border-left-color:#7586fe}
.section.imp{border-left-color:#fe795b}
.section h3{margin:0 0 6px;font-size:1.05rem;font-weight:800}
.copy-btn{position:absolute;right:-10px;top:-10px;padding:6px 10px;font-size:.75rem;font-weight:900;border:0;border-radius:999px;background:#111827;color:#fff;box-shadow:0 6px 14px rgba(2,6,23,.18);cursor:pointer;opacity:0;transition:opacity .15s,transform .15s;transform:translateY(2px)}
.section:hover .copy-btn{opacity:1;transform:none}
@media (max-width:900px){.copy-btn{display:none}}
.explanation .line{line-height:30px;margin:0;font-weight:500}
.note{color:#6b7280;font-size:.95rem;margin-top:8px}

/* rates */
details.rates>summary{list-style:none;cursor:pointer;display:flex;align-items:center;gap:8px;font-weight:900;color:#111827;padding:8px 0}
details.rates>summary::before{content:"";width:8px;height:8px;border:2px solid #111827;border-left:0;border-top:0;transform:rotate(45deg);transition:.2s}
details.rates[open]>summary::before{transform:rotate(-135deg)}

/* a11y & print */
.sr-only{position:absolute!important;width:1px!important;height:1px!important;padding:0!important;margin:-1px!important;overflow:hidden!important;clip:rect(0,0,0,0)!important;white-space:nowrap;border:0!important}
@media print{
  header,#inputCard,.tabbar-wrap .viewctrl,.copy-btn{display:none!important}
  .wrap{max-width:1000px;margin:0;padding:0}
  #results{margin-top:0!important;border:none;box-shadow:none}
  .tabbar-wrap{display:none!important}
  .print-head{display:block !important; border-bottom:1px solid #ddd; padding:6px 0; margin-bottom:8px}
  .print-title{display:block !important; font-size:1.15rem; font-weight:800; margin:6px 0}
  .tab{display:block !important; page-break-inside:avoid}
  table,tr,td,th{page-break-inside:avoid}
  @page{size:A4;margin:12mm}
}
.print-head,.print-title{display:none}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Simulatore Forfettario</h1>
    <div class="badge">INPS Commercianti / Artigiani â€¢ 2025</div>
  </header>

  <!-- FORM -->
  <section id="inputCard" class="card">
    <div class="pad">
      <div class="form-vertical">
        <div class="field">
          <label>Anno di riferimento</label>
          <input type="text" value="2025" disabled aria-disabled="true">
        </div>

        <div class="field">
          <label for="incassato">Incassato annuo (â‚¬)</label>
          <input id="incassato" type="text" inputmode="numeric" placeholder="es. 30000">
          <div class="chips" id="incChips">
            <button class="chip" data-val-num="10000">10.000</button>
            <button class="chip" data-val-num="20000">20.000</button>
            <button class="chip" data-val-num="30000">30.000</button>
            <button class="chip" data-val-num="50000">50.000</button>
            <button class="chip" data-val-num="65000">65.000</button>
            <button class="chip" data-val-num="85000">85.000</button>
          </div>
        </div>

        <div class="field">
          <label>Coefficiente di redditivitÃ </label>
          <div class="chips" id="coeffChips">
            <button class="chip active" data-coeff="78">78%</button>
            <button class="chip" data-coeff="86">86%</button>
            <button class="chip" data-coeff="67">67%</button>
          </div>
          <div class="field-hint">Puoi inserire un coefficiente personalizzato in Opzioni avanzate.</div>
        </div>

        <div class="field">
          <label for="aliqImp">Percentuale Imposta sostitutiva</label>
          <select id="aliqImp">
            <option value="0.05" selected>5% (agevolata)</option>
            <option value="0.15">15% (ordinaria)</option>
          </select>
        </div>

        <!-- Opzioni avanzate -->
        <details class="adv" id="advBox">
          <summary>ðŸ”§ Opzioni avanzate</summary>
          <div class="adv-panel">
            <div class="adv-grid">
              <div class="ibox">
                <div class="bar">Profilo INPS</div>
                <div class="radio-row">
                  <label><input type="radio" name="tipo" value="artigiano" checked> Artigiano</label>
                  <label><input type="radio" name="tipo" value="commerciante"> Commerciante</label>
                </div>
                <div class="grid2">
                  <div>
                    <label for="minimale">Reddito minimale 2025 (â‚¬)</label>
                    <input id="minimale" type="text" inputmode="decimal" value="18555">
                    <div class="field-hint">Base su cui si pagano i contributi fissi.</div>
                  </div>
                  <div>
                    <label for="fissoAnnuo">Quota fissa annua (â‚¬)</label>
                    <input id="fissoAnnuo" type="text" inputmode="decimal" value="4460.64">
                    <div class="field-hint"><span class="tag">Artigiani 4.460,64â‚¬</span> <span class="tag">Commercianti 4.549,70â‚¬</span></div>
                  </div>
                  <div>
                    <label for="aliqIvs">Aliquota IVS su eccedenza (%)</label>
                    <input id="aliqIvs" type="text" inputmode="decimal" value="24">
                  </div>
                  <div>
                    <label for="ridPerc">Riduzione contributiva (%)</label>
                    <input id="ridPerc" type="text" inputmode="decimal" value="35">
                    <div class="field-hint">Es. 35% forfettari. Imposta 0 se non vuoi riduzione.</div>
                  </div>
                  <div>
                    <label for="coeffCustom">Coeff. personalizzato (%)</label>
                    <input id="coeffCustom" type="text" inputmode="numeric" maxlength="2" placeholder="2 cifre">
                  </div>
                </div>
              </div>

              <div class="ibox">
                <div class="bar">Acconti versati lâ€™anno precedente</div>
                <div class="grid2">
                  <div><label for="accImpPrev">Acconti IMPOSTA versati (â‚¬)</label><input id="accImpPrev" type="text" inputmode="decimal" value="0"></div>
                  <div><label for="accInpsPrev">Acconti INPS versati (â‚¬)</label><input id="accInpsPrev" type="text" inputmode="decimal" value="0"></div>
                </div>
              </div>

              <div class="ibox">
                <div class="bar">Contributi deducibili</div>
                <label for="deducibili">Contributi previdenziali versati nellâ€™anno (â‚¬) â€“ deducibili per lâ€™imposta</label>
                <input id="deducibili" type="text" inputmode="decimal" value="0">
              </div>

              <div class="ibox">
                <div class="bar">Calcolo inverso (netto â†’ incassato)</div>
                <div class="grid2" style="align-items:end">
                  <div>
                    <label for="nettoTarget">Netto annuo desiderato (â‚¬)</label>
                    <input id="nettoTarget" type="text" inputmode="decimal" placeholder="es. 20000">
                    <div class="field-hint">Il netto considera <b>saldi + acconti</b>.</div>
                  </div>
                  <button id="btnInverti" class="btn primary">Calcola incassato necessario</button>
                </div>
                <div id="invOut" class="field-hint" style="margin-top:8px"></div>
              </div>
            </div>
          </div>
        </details>

        <div class="actions">
          <button id="btnCalc" class="btn primary">Calcola</button>
          <div class="sub-actions">
            <button id="btnPrint" class="btn print">Stampa PDF</button>
            <button id="btnReset" class="btn secondary">Reset</button>
          </div>
        </div>

        <div id="err" class="field-hint" style="color:#b91c1c;display:none"></div>
        <div id="live" class="sr-only" aria-live="polite"></div>
      </div>
    </div>
  </section>

  <!-- RISULTATI -->
  <section id="results" class="card" style="display:none;margin-top:14px">
    <div class="print-head" id="printHead"></div>

    <div class="tabbar-wrap">
      <div class="tab-bar" id="tabBar">
        <button class="tab-btn active" data-tab="tab1">Come si calcolano</button>
        <button class="tab-btn" data-tab="tab2">Risultati Tasse da pagare</button>
        <button class="tab-btn" data-tab="tab3">Scadenze da pagare</button>
        <span class="inkbar" id="inkbar"></span>
      </div>
      <div class="viewctrl">
        <span id="viewLabel">Vista Dettagliata</span>
        <label class="switch"><input type="checkbox" id="simpToggle"><span class="slider"></span></label>
      </div>
    </div>

    <div id="tab1" class="tab active">
      <h2 class="print-title">Come si calcolano</h2>
      <div class="pad"><div id="explanation" class="explanation"></div></div>
    </div>

    <div id="tab2" class="tab">
      <h2 class="print-title">Risultati Tasse da pagare</h2>
      <div class="pad">
        <div class="kpis">
          <div class="kpi"><h3>Reddito imponibile</h3><div class="big" id="kImpon">â‚¬ 0</div><div class="muted">Incassato Ã— coefficiente</div></div>
          <div class="kpi"><h3>Contributi INPS (totali)</h3><div class="big" id="kInps">â‚¬ 0</div><div class="muted">Fisso + eccedenza (ridotti)</div></div>
          <div class="kpi"><h3>Imposta sostitutiva</h3><div class="big" id="kImp">â‚¬ 0</div><div class="muted">Su imponibile âˆ’ deducibili</div></div>
        </div>
        <div class="kpis" style="margin-top:6px">
          <div class="kpi"><h3>Saldo da versare ora</h3><div class="big" id="kSaldo">â‚¬ 0</div></div>
          <div class="kpi"><h3>Acconti netti</h3><div class="big" id="kAcc">â‚¬ 0</div></div>
          <div class="kpi"><h3>Totale anno (saldi+acconti)</h3><div class="big" id="kTot">â‚¬ 0</div></div>
        </div>

        <h3 style="margin:14px 0 6px">Dettaglio voci</h3>
        <table>
          <tbody id="tblDet"></tbody>
          <tfoot><tr><th style="text-align:right">Totale</th><th id="detTot" class="right"></th></tr></tfoot>
        </table>
      </div>
    </div>

    <div id="tab3" class="tab">
      <h2 class="print-title">Scadenze da pagare</h2>
      <div class="pad">
        <table>
          <tbody id="tblScad"></tbody>
          <tfoot><tr><th style="text-align:right">Totale anno</th><th id="scadTot" class="right"></th></tr></tfoot>
        </table>

        <details class="rates" id="ratesAcc" style="margin-top:12px" open>
          <summary>Dettaglio rate di giugno (5 rate) + riga di novembre</summary>
          <table>
            <thead><tr><th>#</th><th>Scadenza</th><th>Quota capitale</th><th>Interessi %</th><th>Interessi â‚¬</th><th>Rata</th></tr></thead>
            <tbody id="rateBody"></tbody>
            <tfoot>
              <tr><th colspan="4" class="right">Totale interessi giugno</th><th id="rateIntTot" class="right">â‚¬ 0</th><th id="rateTot" class="right">â‚¬ 0</th></tr>
              <tr><th colspan="5" class="right">Totale complessivo (giugno + novembre)</th><th id="rateTotAll" class="right">â‚¬ 0</th></tr>
            </tfoot>
          </table>
        </details>
        <div class="note">Nota: percentuali/rate possono variare di anno in anno (anche la rateizzazione dei secondi acconti).</div>
      </div>
    </div>
  </section>
</div>

<script>
(function(){
  /* utils */
  const fmt = n => {
    const r = Math.round(+n || 0);
    try{
      return new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR',minimumFractionDigits:0,maximumFractionDigits:0}).format(r);
    }catch{ return 'â‚¬ '+r.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.'); }
  };
  const num = s => {
    if(s==null) return 0;
    let t = String(s).trim().replace(/\s+/g,'');
    t = t.replace(/\./g,'').replace(',', '.');
    const n = parseFloat(t);
    return isNaN(n) ? 0 : n;
  };
  const set = (id,html)=>{const el=document.getElementById(id); if(el) el.innerHTML=html;};

  /* chips incassato */
  const inc = document.getElementById('incassato');
  document.getElementById('incChips').addEventListener('click',e=>{
    const c=e.target.closest('.chip'); if(!c) return;
    [...document.querySelectorAll('#incChips .chip')].forEach(x=>x.classList.remove('active'));
    c.classList.add('active');
    inc.value = String(c.dataset.valNum||'').replace(/\D/g,'');
    inc.focus();
    try{inc.setSelectionRange(inc.value.length,inc.value.length);}catch{}
  });
  inc.addEventListener('input',()=>{[...document.querySelectorAll('#incChips .chip')].forEach(x=>x.classList.remove('active'));});

  /* coeff */
  let coeffCh=78;
  document.getElementById('coeffChips').addEventListener('click',e=>{
    const c=e.target.closest('.chip'); if(!c) return;
    [...document.querySelectorAll('#coeffChips .chip')].forEach(x=>x.classList.remove('active'));
    c.classList.add('active'); coeffCh = parseInt(c.dataset.coeff,10)||78;
    document.getElementById('coeffCustom').value='';
  });

  /* tipo profilo updates */
  function syncTipo(){
    const tipo = document.querySelector('input[name="tipo"]:checked').value;
    if(tipo==='artigiano'){
      document.getElementById('fissoAnnuo').value='4460.64';
      document.getElementById('aliqIvs').value='24';
    }else{
      document.getElementById('fissoAnnuo').value='4549.70';
      document.getElementById('aliqIvs').value='24.48';
    }
  }
  document.querySelectorAll('input[name="tipo"]').forEach(r=>r.addEventListener('change',syncTipo));
  syncTipo();

  /* tab underline */
  const ink = document.getElementById('inkbar');
  function moveInk(b){ if(!b) return; ink.style.width=b.offsetWidth+'px'; ink.style.left=b.offsetLeft+'px'; }
  document.getElementById('tabBar').addEventListener('click',e=>{
    const b=e.target.closest('.tab-btn'); if(!b) return;
    document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active'); document.getElementById(b.dataset.tab).classList.add('active'); moveInk(b);
  });
  window.addEventListener('resize',()=>moveInk(document.querySelector('.tab-btn.active')));
  setTimeout(()=>moveInk(document.querySelector('.tab-btn.active')),0);

  /* copy */
  document.addEventListener('click',async e=>{
    const btn=e.target.closest('.copy-btn'); if(!btn) return;
    const box=btn.closest('.section'); const payload=(box.querySelector('.copy-content')||box).innerText.trim();
    try{await navigator.clipboard.writeText(payload);const t=btn.textContent;btn.textContent='Copiato!';setTimeout(()=>btn.textContent=t,1200);}catch{}
  });

  /* view */
  const simp = document.getElementById('simpToggle'), viewLabel=document.getElementById('viewLabel');
  simp.addEventListener('change',()=>{viewLabel.textContent = simp.checked ? 'Vista Semplificata' : 'Vista Dettagliata'; buildExplanation();});

  /* core compute */
  let memo=null, giugno=0, novembre=0;
  function compute(){
    const err = document.getElementById('err'); err.style.display='none'; err.textContent='';

    const incassato = num(document.getElementById('incassato').value);
    if(incassato<=0){ err.style.display='block'; err.textContent='Inserisci un incassato annuo valido (> 0).'; document.getElementById('results').style.display='none'; return; }

    const coeffCustom = num(document.getElementById('coeffCustom').value);
    const coeffPerc = coeffCustom>0?coeffCustom:coeffCh;
    const coeff = coeffPerc/100;

    const aliqImp = parseFloat(document.getElementById('aliqImp').value)||0.05;

    const minimale = num(document.getElementById('minimale').value)||18555;
    const fissoAnnuo = num(document.getElementById('fissoAnnuo').value)||0;
    const aliqIvs = (num(document.getElementById('aliqIvs').value)||24)/100;
    const ridPerc = (num(document.getElementById('ridPerc').value)||0)/100;

    const accImpPrev = num(document.getElementById('accImpPrev').value)||0;
    const accInpsPrev = num(document.getElementById('accInpsPrev').value)||0;
    const deducibili = num(document.getElementById('deducibili').value)||0;

    /* imponibile forfettario */
    const impon = incassato*coeff;

    /* INPS Com/Art: fisso + eccedenza */
    const ecc = Math.max(0, impon - minimale);
    let inps = fissoAnnuo + (ecc * aliqIvs);
    if(ridPerc>0) inps = inps * (1 - ridPerc); // riduzione (es. 35%)

    /* Imposta sostitutiva (deducibilitÃ  contributi VERSATI) */
    const baseImp = Math.max(0, impon - Math.max(0,deducibili));
    const imp = baseImp * aliqImp;

    /* Saldi (scalando acconti anno precedente) */
    const saldoImp = Math.max(0, imp - accImpPrev);
    const saldoInps = Math.max(0, inps - accInpsPrev);
    const saldoTot = saldoImp + saldoInps;

    /* Crediti anno precedente */
    const credImp = Math.max(0, accImpPrev - imp);
    const credInps = Math.max(0, accInpsPrev - inps);

    /* Acconti anno successivo (metodo storico) â€“ per Com/Art 100% = 50% + 50% */
    const accImpLord = imp;
    const accInpsLord = inps;

    const accImpNet = Math.max(0, accImpLord - credImp);
    const accInpsNet = Math.max(0, accInpsLord - credInps);

    const accImp1 = accImpNet * 0.50, accImp2 = accImpNet * 0.50;
    const accInps1 = accInpsNet * 0.50, accInps2 = accInpsNet * 0.50;

    const accontiTot = accImpNet + accInpsNet;

    /* Scadenze */
    giugno = saldoTot + accImp1 + accInps1;
    novembre = accImp2 + accInps2;
    const totaleAnno = saldoTot + accontiTot;

    /* Netto in tasca (dopo saldi+acconti) */
    const netto = incassato - (saldoTot + accontiTot);

    /* KPI */
    set('kImpon',fmt(impon));
    set('kInps',fmt(inps));
    set('kImp',fmt(imp));
    set('kSaldo',fmt(saldoTot));
    set('kAcc',fmt(accontiTot));
    set('kTot',fmt(totaleAnno));

    /* Dettaglio */
    let det='';
    det+=row('<b>Incassato</b>',fmt(incassato));
    det+=row('Coefficiente', coeffPerc+'%');
    det+=row('<b>Imponibile</b>', fmt(impon));
    det+=row('Minimale 2025', fmt(minimale));
    det+=row('INPS fisso annuo', fmt(fissoAnnuo));
    det+=row('Eccedenza imponibile', fmt(ecc));
    det+=row('Aliquota IVS eccedenza', (aliqIvs*100).toFixed(2)+'%');
    if(ridPerc>0) det+=row('Riduzione INPS applicata', (ridPerc*100).toFixed(0)+'%');
    det+=row('<b>INPS dovuto</b>', fmt(inps));
    det+=row('Contributi deducibili usati per imposta', 'âˆ’ '+fmt(deducibili));
    det+=row('Base per imposta', fmt(baseImp));
    det+=row('Aliquota imposta', Math.round(aliqImp*100)+'%');
    det+=row('<b>Imposta dovuta</b>', fmt(imp));
    det+=row('Acconti imposta anno precedente', 'âˆ’ '+fmt(accImpPrev));
    if(credImp>0) det+=row('Credito imposta anno prec.', fmt(credImp));
    det+=row('<b>Saldo imposta</b>', fmt(saldoImp));
    det+=row('Acconti INPS anno precedente', 'âˆ’ '+fmt(accInpsPrev));
    if(credInps>0) det+=row('Credito INPS anno prec.', fmt(credInps));
    det+=row('<b>Saldo INPS</b>', fmt(saldoInps));
    det+=row('<b>Saldo totale (imposta+INPS)</b>', fmt(saldoTot));
    det+='<tr><th colspan="2">Acconti per lâ€™anno successivo (netti di crediti)</th></tr>';
    det+=row('Imposta â€“ totale acconti', fmt(accImpNet));
    det+=row('INPS â€“ totale acconti', fmt(accInpsNet));
    det+=row('Imposta â€“ 1Â° acconto (50%)', fmt(accImp1));
    det+=row('Imposta â€“ 2Â° acconto (50%)', fmt(accImp2));
    det+=row('INPS â€“ 1Â° acconto (50%)', fmt(accInps1));
    det+=row('INPS â€“ 2Â° acconto (50%)', fmt(accInps2));
    det+=row('<b>Netto in tasca (dopo saldi+acconti)</b>', fmt(netto));
    set('tblDet',det); set('detTot','');

    /* Scadenze sintetiche */
    let sc=''; sc+=row('<span class="tag">Giugno</span> â€” Saldo (imp.+INPS) + 1Â° acconti', fmt(giugno), true);
    sc+=row('<span class="tag">Novembre</span> â€” 2Â° acconti', fmt(novembre), true);
    set('tblScad',sc); set('scadTot',fmt(giugno+novembre));

    /* rate giugno (5) + novembre */
    buildRates();

    /* spiegazione */
    memo={incassato,coeffPerc,impon,inps,imp,baseImp,minimale,fissoAnnuo,ecc,aliqIvs,aliqImp,ridPerc,
          accImpPrev,accInpsPrev,credImp,credInps,
          saldoImp,saldoInps,saldoTot,accImpNet,accInpsNet,accImp1,accImp2,accInps1,accInps2,
          giugno,novembre,totaleAnno,netto};
    buildExplanation();

    document.getElementById('results').style.display='';
    set('live', 'Calcolo aggiornato');
    set('printHead', `<div><strong>Forfettario 2025 â€“ INPS Com/Art</strong></div>
      <div style="font-size:12px;color:#6b7280;margin-top:2px">Stampa generata il ${new Intl.DateTimeFormat('it-IT',{dateStyle:'medium',timeStyle:'short'}).format(new Date())}</div>`);
  }

  const row = (a,b,right)=>`<tr><td>${a}</td><td class="${right?'right':''}">${b}</td></tr>`;

  function buildExplanation(){
    if(!memo) return;
    const s=memo, simple=document.getElementById('simpToggle').checked;
    document.getElementById('viewLabel').textContent = simple ? 'Vista Semplificata' : 'Vista Dettagliata';

    const P=t=>`<p class="line">${t}</p>`;
    const wrap=(tit,inner,cls)=>`<div class="section ${cls||''}">
      <button type="button" class="copy-btn">Copia</button>
      <div class="copy-content">${tit?`<h3>${tit}</h3>`:''}${inner}</div></div>`;

    let html='';
    // Intro richiesta: frase iniziale sintetica
    const intro = P(`Nel regime forfettario paghi tasse e contributi non sullâ€™intero incassato, ma sullâ€™<b>incassato Ã— coefficiente di redditivitÃ </b> (qui <b>${s.coeffPerc}%</b>). Lâ€™imposta Ã¨ <b>${Math.round(s.aliqImp*100)}%</b> e i contributi INPS Com/Art sono composti da una <b>quota fissa sul minimale</b> piÃ¹ una <b>percentuale sullâ€™eccedenza</b>.`);
    const imponibile = P(`Hai incassato <b>${fmt(s.incassato)}</b>. Con coefficiente <b>${s.coeffPerc}%</b> il reddito imponibile diventa: <span class="line mono">${fmt(s.incassato)} Ã— ${s.coeffPerc}% = ${fmt(s.impon)}</span>`);

    let inps = P(`Il minimale 2025 Ã¨ <b>${fmt(s.minimale)}</b>. La quota <b>fissa annua</b> Ã¨ <b>${fmt(s.fissoAnnuo)}</b>. Sulla parte che eccede il minimale (<b>eccedenza</b> = ${fmt(s.ecc)}) si applica il <b>${(s.aliqIvs*100).toFixed(2)}%</b>.`) +
                 (s.ridPerc>0 ? P(`Ãˆ attiva una <b>riduzione contributiva</b> del <b>${(s.ridPerc*100).toFixed(0)}%</b> sullâ€™INPS complessivo.`) : '') +
                 P(`Con questi dati, i contributi INPS dovuti per lâ€™anno sono <b>${fmt(s.inps)}</b>.`) +
                 (s.accInpsPrev>0 ? (s.credInps>0
                  ? P(`Avevi giÃ  versato acconti INPS per ${fmt(s.accInpsPrev)}: superano il dovuto, quindi <b>saldo INPS = 0â‚¬</b> e resta un <b>credito</b> di <b>${fmt(s.credInps)}</b> che riduce i nuovi acconti.`)
                  : P(`Acconti INPS giÃ  versati: ${fmt(s.accInpsPrev)}. Quindi saldo INPS: <span class="mono">${fmt(s.inps)} âˆ’ ${fmt(s.accInpsPrev)} = ${fmt(s.saldoInps)}</span>.`))
                  : P(`Saldo INPS da versare ora: <b>${fmt(s.saldoInps)}</b>.`)
                 );

    let imp = (s.baseImp < s.impon
                ? P(`Per lâ€™imposta, prima si tolgono i <b>contributi deducibili versati</b> (${fmt(s.deducibili)}): <span class="mono">${fmt(s.impon)} âˆ’ ${fmt(s.deducibili)} = ${fmt(s.baseImp)}</span>.`)
                : P(`Base per lâ€™imposta: <b>${fmt(s.baseImp)}</b>.`)) +
              P(`Aliquota <b>${Math.round(s.aliqImp*100)}%</b>: <span class="mono">${fmt(s.baseImp)} Ã— ${Math.round(s.aliqImp*100)}% = ${fmt(s.imp)}</span>.`) +
              (s.accImpPrev>0 ? (s.credImp>0
                ? P(`Avevi acconti imposta per ${fmt(s.accImpPrev)}: superano il dovuto, quindi <b>saldo imposta = 0â‚¬</b> e resta un <b>credito</b> di <b>${fmt(s.credImp)}</b> per i nuovi acconti.`)
                : P(`Acconti imposta giÃ  versati: ${fmt(s.accImpPrev)} â‡’ saldo imposta: <span class="mono">${fmt(s.imp)} âˆ’ ${fmt(s.accImpPrev)} = ${fmt(s.saldoImp)}</span>.`))
                : P(`Saldo imposta da versare ora: <b>${fmt(s.saldoImp)}</b>.`));

    const saldi = P(`I saldi da versare ora sono: <span class="mono"><b>${fmt(s.saldoInps)}</b> (INPS) + <b>${fmt(s.saldoImp)}</b> (imposta) = <b>${fmt(s.saldoTot)}</b></span>.`);

    const acc = P(`Per lâ€™anno successivo gli acconti, calcolati con metodo storico, sono pari al <b>100%</b> sia per lâ€™imposta che per lâ€™INPS e si pagano <b>50% a giugno</b> e <b>50% a novembre</b>. Eventuali crediti riducono automaticamente gli acconti.`) +
                 P(`Con i tuoi dati: <b>imposta</b> ${fmt(s.accImpNet)} (50%+50%), <b>INPS</b> ${fmt(s.accInpsNet)} (50%+50%).`);

    const scad = P(`<b>Giugno</b> pagherai saldi + primi acconti = <b>${fmt(s.giugno)}</b>. <b>Novembre</b> pagherai i secondi acconti = <b>${fmt(s.novembre)}</b>. Totale anno (saldi+acconti) = <b>${fmt(s.totaleAnno)}</b>.`);

    const tot = P(`Riepilogo finale: <span class="mono"><b>Saldi</b> ${fmt(s.saldoTot)} â€¢ <b>Acconti</b> ${fmt(s.accImpNet+s.accInpsNet)} â€¢ <b>Totale</b> ${fmt(s.totaleAnno)}</span>. Incidenza: saldi <b>${perc(s.saldoTot,s.incassato)}</b>; acconti <b>${perc(s.accImpNet+s.accInpsNet,s.incassato)}</b>; totale <b>${perc(s.totaleAnno,s.incassato)}</b>.`);

    if(!simple){
      html += wrap('', intro + imponibile, '');
      html += wrap('Contributi INPS (Com/Art)', inps, 'inps');
      html += wrap('Imposta sostitutiva', imp, 'imp');
      html += wrap('Saldi', saldi, '');
      html += wrap('Acconti', acc, '');
      html += wrap('Scadenze e totale', scad + tot, '');
    }else{
      html += wrap('Sintesi', P(`Imponibile: <b>${fmt(s.impon)}</b>. INPS dovuto: <b>${fmt(s.inps)}</b>. Imposta: <b>${fmt(s.imp)}</b>. Saldi ora: <b>${fmt(s.saldoTot)}</b>. Acconti (tot): <b>${fmt(s.accImpNet+s.accInpsNet)}</b>. Totale anno (saldi+acconti): <b>${fmt(s.totaleAnno)}</b>.`), '');
    }
    set('explanation', html);
  }

  function perc(n,b){return b>0?(Math.round((n/b*100))+'%'):'0%';}

  function buildRates(){
    const totGiu = giugno, quota = totGiu/5;
    const PERC=[0.00,0.18,0.51,0.84,1.17]; // % interessi
    const DATE=["30 giugno","16 luglio","20 agosto","16 settembre","16 ottobre"];
    let tbody='',sumInt=0,sumGiu=0;
    for(let i=0;i<5;i++){
      const p=PERC[i]/100, int=totGiu*p, rata=quota+int;
      sumInt+=int; sumGiu+=rata;
      tbody+=`<tr><td>${i+1}</td><td>${DATE[i]}</td><td class="right">${fmt(quota)}</td><td class="right">${PERC[i].toFixed(2)}%</td><td class="right">${fmt(int)}</td><td class="right"><b>${fmt(rata)}</b></td></tr>`;
    }
    tbody+=`<tr><td>6</td><td><b>Novembre â€” 2Â° acconti</b></td><td class="right">${fmt(novembre)}</td><td>â€”</td><td>â€”</td><td class="right"><b>${fmt(novembre)}</b></td></tr>`;
    set('rateBody',tbody); set('rateIntTot',fmt(sumInt)); set('rateTot',fmt(sumGiu)); set('rateTotAll',fmt(sumGiu+novembre));
  }

  /* netto target â†’ incassato (inclusi saldi+acconti) */
  function netAfterAll(incassatoGuess){
    const coeffCustom = num(document.getElementById('coeffCustom').value);
    const coeffPerc = coeffCustom>0?coeffCustom: (document.querySelector('#coeffChips .chip.active')?.dataset.coeff?parseInt(document.querySelector('#coeffChips .chip.active').dataset.coeff,10):78);
    const coeff = coeffPerc/100;
    const aliqImp = parseFloat(document.getElementById('aliqImp').value)||0.05;
    const minimale = num(document.getElementById('minimale').value)||18555;
    const fissoAnnuo = num(document.getElementById('fissoAnnuo').value)||0;
    const aliqIvs = (num(document.getElementById('aliqIvs').value)||24)/100;
    const ridPerc = (num(document.getElementById('ridPerc').value)||0)/100;
    const accImpPrev = num(document.getElementById('accImpPrev').value)||0;
    const accInpsPrev = num(document.getElementById('accInpsPrev').value)||0;
    const deducibili = num(document.getElementById('deducibili').value)||0;

    const impon = incassatoGuess*coeff;
    let inps = fissoAnnuo + Math.max(0, impon - minimale)*aliqIvs;
    if(ridPerc>0) inps*= (1-ridPerc);
    const imp = Math.max(0, impon - deducibili)*aliqImp;

    const saldoImp = Math.max(0, imp - accImpPrev);
    const saldoInps = Math.max(0, inps - accInpsPrev);
    const credImp = Math.max(0, accImpPrev - imp);
    const credInps = Math.max(0, accInpsPrev - inps);

    const accImpNet = Math.max(0, imp - credImp);
    const accInpsNet = Math.max(0, inps - credInps);

    const totalToPay = (saldoImp+saldoInps) + (accImpNet+accInpsNet);
    return incassatoGuess - totalToPay;
  }

  function findIncForNet(target){
    target=Math.max(0,target||0);
    let lo=0, hi=Math.max(20000, target*3+10000);
    for(let i=0;i<40 && netAfterAll(hi)<target;i++) hi*=1.6;
    for(let k=0;k<64;k++){
      const mid=(lo+hi)/2;
      if(netAfterAll(mid)>=target) hi=mid; else lo=mid;
    }
    return Math.round(hi);
  }

  /* handlers */
  document.getElementById('btnCalc').addEventListener('click', compute);
  document.getElementById('btnPrint').addEventListener('click',()=>{
    const vis=document.getElementById('results').style.display!=='none';
    if(!vis){alert('Prima clicca su CALCOLA.');return;}
    window.print();
  });
  document.getElementById('btnReset').addEventListener('click',()=>{
    ['incassato','accImpPrev','accInpsPrev','deducibili','coeffCustom','nettoTarget'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
    document.getElementById('aliqImp').value='0.05';
    document.querySelector('input[name="tipo"][value="artigiano"]').checked=true; syncTipo();
    document.getElementById('minimale').value='18555';
    document.getElementById('ridPerc').value='35';
    document.querySelectorAll('#coeffChips .chip').forEach(x=>x.classList.remove('active'));
    document.querySelector('#coeffChips .chip[data-coeff="78"]').classList.add('active'); coeffCh=78;
    document.getElementById('simpToggle').checked=false; document.getElementById('viewLabel').textContent='Vista Dettagliata';
    document.getElementById('results').style.display='none';
  });
  document.getElementById('btnInverti').addEventListener('click',()=>{
    const target = num(document.getElementById('nettoTarget').value);
    if(target<=0){document.getElementById('invOut').textContent='Inserisci un netto valido.';return;}
    const incNeed = findIncForNet(target);
    document.getElementById('incassato').value = String(incNeed);
    [...document.querySelectorAll('#incChips .chip')].forEach(c=>c.classList.remove('active'));
    document.getElementById('invOut').innerHTML = `Per avere circa <b>${fmt(target)}</b> netti (dopo saldi + acconti) ti servono ~ <b>${fmt(incNeed)}</b> di incassi.`;
    compute();
    window.scrollTo({top:0,behavior:'smooth'});
  });

  // enter to compute
  ['incassato','accImpPrev','accInpsPrev','deducibili','coeffCustom','nettoTarget','minimale','fissoAnnuo','aliqIvs','ridPerc']
    .forEach(id=>{const el=document.getElementById(id); if(el) el.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault(); compute();}});});
})();
</script>
</body>
</html>
