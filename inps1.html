<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulatore Forfettario • INPS Commercianti / Artigiani 2025</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#ecf2fc; --card:#fff; --text:#0f172a; --muted:#64748b; --border:#e6e6eb;
  --accent:#7586fe; --accent-dark:#5e6ff4; --ink:#fe795b;
  --pill:#ffd791; --pill-border:#f1c364; --pill-active:#f6c96a;
  --c1:#7586fe; --c2:#b491ff; --c3:#ffd791; --c4:#ff9696; --c5:#fe795b;
  --radius:14px; --shadow:0 14px 28px rgba(2,6,23,.08);
}
*{box-sizing:border-box}
html{font-size:17px}
body{
  margin:0;color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;background:var(--bg);
}
.wrap{max-width:860px;margin:32px auto;padding:0 14px}

/* Header */
header{text-align:center;margin-bottom:16px}
h1{margin:0;font-size:2rem;font-weight:900;letter-spacing:-.01em;line-height:1.2}
.hl{background:transparent;border:none;text-decoration:underline;text-decoration-thickness:2px;text-underline-offset:3px}

/* Cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
.pad{padding:20px}

/* Form */
.form-vertical{display:flex;flex-direction:column;row-gap:22px}
.field{width:100%}
label{display:block;margin:0 0 6px;font-weight:800}
input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:1rem}
input:disabled{background:#f8fafc;color:#334155}
input:focus,select:focus,.chip:focus-visible,.pill:focus-visible,.btn:focus-visible{outline:none;border-color:#c7d2fe;box-shadow:0 0 0 3px #e0e7ff}

/* Chips */
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.chip{height:40px;padding:0 14px;display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:9999px;background:#fff;cursor:pointer;font-weight:900}
.chip:hover{border-color:#bcd0ff}
.chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.coeff-wrap{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.coeff-input{width:86px}

/* Pulsanti */
.actions{display:flex;flex-direction:column;gap:10px;align-items:center;margin-top:8px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:0;border-radius:10px;font-weight:900;cursor:pointer;transition:transform .05s}
.btn:active{transform:translateY(1px)}
.btn.primary{background:var(--accent);color:#fff;height:46px;padding:0 18px;max-width:380px;width:100%}
.btn.primary:hover{background:var(--accent-dark)}
.sub-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.btn.print{background:#fff;border:1px solid var(--border);color:#111827;height:38px;padding:0 12px}
.btn.secondary{background:#fff;border:1px solid var(--border);height:38px;padding:0 12px}

/* Opzioni avanzate */
details.adv{display:block;width:100%}
details.adv>summary{cursor:pointer;list-style:none;padding:10px 14px;border:1px solid var(--border);border-radius:12px;font-weight:900;background:#fff;display:flex;align-items:center;gap:10px}
details.adv>summary::before{content:"";width:10px;height:10px;border:2px solid #111827;border-left:0;border-top:0;transform:rotate(45deg);transition:.2s}
details.adv[open]>summary::before{transform:rotate(-135deg)}
details.adv[open]>summary{background:#111827;color:#fff;border-color:#111827}
.adv-panel{display:none;margin-top:12px;width:100%;background:#fff;border:1px solid #E6E6E6;border-radius:16px;box-shadow:0 12px 24px rgba(2,6,23,.06);padding:16px}
details.adv[open] .adv-panel{display:block}
.adv-grid{display:grid;row-gap:20px}
.subgrid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.ibox{background:#fff;border:1px solid #E6E6E6;border-radius:12px;padding:16px;box-shadow:0 6px 16px rgba(2,6,23,.04)}
.ibox .bar{display:flex;align-items:center;gap:8px;margin:-4px -4px 12px;padding:8px 10px;border-radius:8px;color:#fff;font-weight:900}
.bar.theme-1{background:var(--c1)}
.bar.theme-2{background:var(--c2)}
.bar.theme-3{background:var(--c4)}
.bar.theme-4{background:var(--c5)}
.desc{font-size:12px;color:#6b7280;margin-top:6px}

/* Toggle pill Manuale/Stima & inverse */
.pill-toggle{display:flex;justify-content:center;gap:8px;margin:8px 0 14px}
.pill{height:34px;padding:0 14px;border-radius:9999px;border:1px solid var(--border);background:#fff;font-weight:900;cursor:pointer}
.pill.active{background:var(--c2);color:#fff;border-color:var(--c2)}

/* Tabs */
.tabbar-wrap{padding:10px 12px}
.tab-bar{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.tab-btn{border:1px solid var(--pill-border);background:var(--pill);border-radius:10px;padding:10px 12px;height:40px;cursor:pointer;font-weight:900;white-space:nowrap;text-align:center;box-shadow:inset 0 -2px 0 rgba(0,0,0,0)}
.tab-btn.active{background:var(--pill-active);box-shadow:inset 0 -2px 0 var(--ink);border-color:var(--pill-border)}
.inkbar{display:none}
.tab{display:none}.tab.active{display:block}

/* Vista (sotto a destra) */
.viewctrl{display:flex;align-items:center;gap:8px;justify-content:flex-end;padding:0 12px 12px}
#viewLabel{font-weight:800;color:#475569}
.switch{position:relative;display:inline-block;width:44px;height:24px}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#e5e7eb;border-radius:999px;transition:.2s}
.slider:before{content:"";position:absolute;height:18px;width:18px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 2px rgba(0,0,0,.3)}
.switch input:checked + .slider{background:var(--c2)}
.switch input:checked + .slider:before{transform:translateX(20px)}

/* KPI & tabelle */
.kpis{display:grid;gap:12px;margin-top:8px}
@media(min-width:640px){.kpis{grid-template-columns:repeat(2,1fr)}}
@media(min-width:860px){.kpis{grid-template-columns:repeat(3,1fr)}}
.kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;box-shadow:0 6px 16px rgba(2,6,23,.04);display:flex;flex-direction:column;justify-content:center;min-height:120px}
.kpi h3{margin:0 0 6px;font-size:.78rem;color:#64748b;text-transform:uppercase;font-weight:800}
.kpi .big{font-size:1.35rem;font-weight:900;font-variant-numeric:tabular-nums}
table{width:100%;border-collapse:collapse;margin-top:6px;font-size:.98rem;background:#fff;border:1px solid var(--border);box-shadow:0 6px 16px rgba(2,6,23,.04);page-break-inside:avoid}
th,td{border:1px solid var(--border);padding:12px 8px}
th{background:#f7f7fb;color:#475569;font-weight:800}
tr:hover{background:#f8faff}
tfoot tr th{background:#f1f5f9;font-weight:800}
#tblScadenze td:nth-child(2),#tblFissi td:nth-child(2),#rateBody td:nth-child(3),#rateBody td:nth-child(5),#rateBody td:nth-child(6),#scadTot,#fissiTot,#scadVarTot{text-align:right;font-variant-numeric:tabular-nums}
.badge-month{display:inline-block;padding:2px 8px;border-radius:9999px;background:var(--pill);border:1px solid var(--pill-border);font-weight:800;font-size:.85em}

/* Sezioni spiegazione + Copy */
.section{position:relative;border-left:4px solid #e5e7eb;padding:14px;margin:12px 0 8px;border-radius:10px;background:#fff;border:1px solid var(--border);box-shadow:0 6px 16px rgba(2,6,23,.04)}
.section.inps{border-left-color:var(--c1)}
.section.imp{border-left-color:#16a34a}
.section h3{margin:0 0 6px;font-size:1.05rem;font-weight:800}
.copy-btn{position:absolute;right:-10px;top:-10px;padding:6px 10px;font-size:.75rem;font-weight:900;border:0;border-radius:999px;background:var(--c4);color:#fff;box-shadow:0 6px 14px rgba(2,6,23,.18);cursor:pointer;opacity:0;transition:opacity .15s,transform .15s;transform:translateY(2px)}
.section:hover .copy-btn{opacity:1;transform:none}
@media (max-width:900px){.copy-btn{display:none}}
.explanation{max-width:820px;margin:0 auto;text-align:left}
.explanation .line{line-height:30px;margin:0;font-weight:500}
.muted{color:var(--muted)}
.mono{font-variant-numeric:tabular-nums}
.error{margin-top:10px;padding:10px;border-left:4px solid #ef4444;background:#fdecec;border-radius:10px;color:#7f1d1d}

/* Avvisi/Note locali */
.form-note{font-size:.9rem;margin-top:.25rem;opacity:.95}
.form-note.warning{background:#fff3cd;border:1px solid #ffe69c;padding:.4rem .6rem;border-radius:.6rem}
.hidden{display:none !important}

/* Accordion rate */
details.rates>summary{list-style:none;cursor:pointer;display:flex;align-items:center;gap:8px;font-weight:900;color:#111827;padding:8px 0}
details.rates>summary::before{content:"";width:8px;height:8px;border:2px solid #111827;border-left:0;border-top:0;transform:rotate(45deg);transition:.2s}
details.rates[open]>summary::before{transform:rotate(-135deg)}

/* ARIA only */
.sr-only{position:absolute!important;width:1px!important;height:1px!important;padding:0!important;margin:-1px!important;overflow:hidden!important;clip:rect(0,0,0,0)!important;white-space:nowrap;border:0!important}

/* Print */
@media print{
  body{background:#fff}
  header,#inputCard,.viewctrl,.copy-btn{display:none!important}
  .wrap{max-width:1000px;margin:0;padding:0}
  #resultsBox{margin-top:0!important;border:none;box-shadow:none}
  .print-head{display:block !important; border-bottom:1px solid #ddd; padding:6px 0; margin-bottom:8px}
  .print-title{display:block !important; font-size:1.15rem; font-weight:800; margin:6px 0}
  .tab{display:block !important; page-break-inside:avoid}
  table,tr,td,th{page-break-inside:avoid}
  @page{size:A4;margin:12mm}
}
.print-head,.print-title{display:none}
</style>
</head>
<body>
<div class="wrap">
  <!-- TITOLO -->
  <header>
    <h1>Simulatore Forfettario per<br><u><span class="hl">INPS Commercianti / Artigiani 2025</span></u></h1>
  </header>

  <!-- FORM -->
  <section class="card" id="inputCard" style="margin-top:14px">
    <div class="pad">
      <div class="form-vertical" style="max-width:720px;margin:0 auto">

        <div class="field">
          <label for="anno">Anno di riferimento <span class="hl">2025</span></label>
          <input id="anno" type="text" value="2025" disabled aria-disabled="true"/>
        </div>

        <div class="field">
          <label for="gestione">Gestione INPS</label>
          <select id="gestione">
            <option value="commercianti" selected>Commercianti</option>
            <option value="artigiani">Artigiani</option>
          </select>
        </div>

        <div class="field">
          <label for="incassato">Incassato annuo (€) <span class="hl">importo incassato dell’anno</span></label>
          <input id="incassato" type="text" inputmode="numeric" placeholder="es. 50000" value="">
          <div class="chips" id="incChips" aria-label="Importi rapidi">
            <button class="chip" data-val="10.000" data-val-num="10000">10.000</button>
            <button class="chip" data-val="20.000" data-val-num="20000">20.000</button>
            <button class="chip" data-val="30.000" data-val-num="30000">30.000</button>
            <button class="chip" data-val="50.000" data-val-num="50000">50.000</button>
            <button class="chip" data-val="85.000" data-val-num="85000">85.000</button>
          </div>
        </div>

        <div class="field">
          <label>Coefficiente di <span class="hl">redditività</span></label>
          <div class="coeff-wrap">
            <div class="chips" id="coeffChips">
              <button class="chip active" data-coeff="78">78%</button>
              <button class="chip" data-coeff="86">86%</button>
              <button class="chip" data-coeff="67">67%</button>
            </div>
            <input id="coeffCustom" class="coeff-input" maxlength="2" inputmode="numeric" pattern="[0-9]*" placeholder="%" title="2 cifre"/>
            <span class="muted" style="font-size:.9rem">personalizzato</span>
          </div>
        </div>

        <div class="field">
          <label for="imposta">Percentuale <span class="hl">Imposta sostitutiva</span></label>
          <select id="imposta">
            <option value="0.05" selected>5% (primi 5 anni)</option>
            <option value="0.15">15% (ordinaria)</option>
          </select>
        </div>

        <div class="field">
          <label>Agevolazione contributiva</label>
          <div class="chips" id="agevChips">
            <button class="chip active" data-agev="nessuna">Nessuna</button>
            <button class="chip" data-agev="esenzione">Esenzione (lavoro dipendente)</button>
            <button class="chip" data-agev="rid35">Riduzione 35%</button>
            <button class="chip" data-agev="rid50">Riduzione 50%</button>
          </div>
        </div>

        <div class="field">
          <label>Apertura Partita IVA</label>
          <div class="chips" id="pivaChips">
            <button class="chip active" data-mode="pre">Aperta prima del 2025</button>
            <button class="chip" data-mode="2025">Aperta nel 2025</button>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="dataApertura" type="date" min="2025-01-01" max="2025-12-31" disabled>
            <small class="form-note" id="pivaNote">
              Se selezioni “Aperta nel 2025”, indica la data: i contributi minimi saranno ricalcolati pro-rata, con
              <b>prima rata utile a 0 €</b>, rata successiva ridotta e ultime due quanto più possibile piene.
            </small>
          </div>
        </div>

        <div id="gestInfoBox" class="form-note" style="background:#f8fafc;border:1px solid var(--border);padding:10px;border-radius:10px;margin-top:-8px">
          <!-- compilato via JS -->
        </div>

        <!-- Opzioni avanzate -->
        <details class="adv" style="margin-top:4px" id="advBox">
          <summary>⚙️ Opzioni avanzate</summary>
          <div class="adv-panel">
            <div class="adv-grid">

              <div class="ibox">
                <div class="bar theme-1">Acconti dell’anno in corso</div>
                <div class="subgrid">
                  <div><label>Acconti IMPOSTA 2025 (%)</label><input id="percAccImp" type="text" inputmode="decimal" value="100"></div>
                  <div><label>Acconti INPS 2025 (%)</label><input id="percAccInps" type="text" inputmode="decimal" value="100"></div>
                </div>
                <div class="desc">Di default gli acconti sono al <b>100%</b> del dovuto (50% a giugno e 50% a novembre).</div>
              </div>

              <div class="ibox">
                <div class="bar theme-2">Acconti versati l’anno precedente</div>
                <div class="pill-toggle" role="tablist" aria-label="Modalità inserimento acconti">
                  <button type="button" class="pill active" id="pillManuale" aria-pressed="true">Manuale</button>
                  <button type="button" class="pill" id="pillStima" aria-pressed="false">Stima automatica da incasso 2024</button>
                </div>

                <div class="subgrid" id="accManual">
                  <div><label>Acconti IMPOSTA 2024 (€)</label><input id="accImpPrev" type="text" inputmode="decimal" value="0"></div>
                  <div><label>Acconti INPS 2024 (€)</label><input id="accInpsPrev" type="text" inputmode="decimal" value="0"></div>
                </div>

                <div id="accStima" style="display:none">
                  <div class="subgrid">
                    <div><label>Incassato 2024 (€)</label><input id="incasso2024" type="text" inputmode="decimal" value="0"></div>
                    <div><label>Imposta 2024</label>
                      <select id="imp2024"><option value="0.05" selected>5%</option><option value="0.15">15%</option></select>
                    </div>
                    <div><label>Coeff. 2024 (%)</label><input id="coeff2024" type="text" class="coeff-input" maxlength="2" inputmode="numeric" pattern="[0-9]*" value="78"></div>
                  </div>
                  <div class="desc">Stima veloce: nessuna deduzione; acconti ≈ imposta 2024 e INPS <b>variabile</b> 2024 calcolati sul tuo incassato 2024.</div>
                </div>
              </div>

              <div class="ibox">
                <div class="bar theme-3">Contributi deducibili (per l’imposta)</div>
                <div class="subgrid">
                  <div style="grid-column:1/-1">
                    <label for="deducibili">Contributi previdenziali già versati nell’anno (€) — deducibili solo per l’imposta</label>
                    <input id="deducibili" type="text" inputmode="decimal" value="0"/>
                    <small id="deducibiliNotice" class="form-note warning hidden" aria-live="polite">
                      Attenzione: i contributi sono deducibili solo se realmente versati nell’anno
                    </small>
                  </div>
                </div>
              </div>

              <div class="ibox">
                <div class="bar theme-4">Calcolo inverso (netto → incassato)</div>

                <div class="pill-toggle" id="invModeToggle" role="tablist" aria-label="Tipo di calcolo inverso">
                  <button type="button" class="pill active" id="pillInvTotale" aria-pressed="true">Netto annuo totale</button>
                  <button type="button" class="pill" id="pillInvLavoro" aria-pressed="false">Netto in più su nuovo lavoro</button>
                </div>

                <div class="subgrid" id="invTotaleBox" style="align-items:end">
                  <div>
                    <label for="nettoTargetTot">Netto annuo desiderato (€)</label>
                    <input id="nettoTargetTot" type="text" inputmode="decimal" placeholder="es. 20000" value="">
                  </div>
                  <div>
                    <button type="button" id="btnInverti" class="btn primary" style="width:100%">Calcola incassato necessario</button>
                  </div>
                </div>

                <div class="subgrid" id="invLavoroBox" style="align-items:end;display:none;margin-top:4px">
                  <div>
                    <label for="incassoAttuale">Incassato già realizzato nell’anno (€)</label>
                    <input id="incassoAttuale" type="text" inputmode="decimal" placeholder="es. 40000" value="">
                  </div>
                  <div>
                    <label for="nettoLavoro">Netto desiderato da questo lavoro (€)</label>
                    <input id="nettoLavoro" type="text" inputmode="decimal" placeholder="es. 2000" value="">
                  </div>
                  <div>
                    <button type="button" id="btnInvJob" class="btn primary" style="width:100%">Calcola compenso necessario</button>
                  </div>
                </div>

                <div id="invOut" class="desc" style="margin-top:8px"></div>
                <div class="desc">In entrambe le modalità il simulatore considera <b>minimi + imposta + acconti</b>.</div>
              </div>

            </div>
          </div>
        </details>

        <div class="actions">
          <button class="btn primary" id="btnCalc">Calcola</button>
          <div class="sub-actions">
            <button class="btn print" id="btnPrint">Stampa PDF</button>
            <button class="btn secondary" id="btnReset">Reset</button>
          </div>
        </div>

      </div>

      <div id="err" class="error" style="display:none"></div>
      <div id="liveResult" class="sr-only" aria-live="polite"></div>
    </div>
  </section>

  <!-- RISULTATI -->
  <section id="resultsBox" class="card" style="margin-top:14px;display:none" aria-live="polite">
    <div class="print-head" id="printHead"></div>

    <div class="tabbar-wrap">
      <div class="tab-bar" id="tabBar">
        <button class="tab-btn active" data-tab="tab1">Come si calcolano</button>
        <button class="tab-btn" data-tab="tab2">Risultati Tasse da pagare</button>
        <button class="tab-btn" data-tab="tab3">Scadenze da pagare</button>
        <span class="inkbar" id="inkbar"></span>
      </div>
    </div>

    <div class="viewctrl">
      <span id="viewLabel">Vista Dettagliata</span>
      <label class="switch" title="Cambia vista">
        <input type="checkbox" id="simpToggle"><span class="slider"></span>
      </label>
    </div>

    <div id="tab1" class="tab active">
      <h2 class="print-title">Come si calcolano</h2>
      <div class="pad"><div id="explanation" class="explanation"></div></div>
    </div>

    <div id="tab2" class="tab">
      <h2 class="print-title">Risultati Tasse da pagare</h2>
      <div class="pad">
        <div class="kpis">
          <div class="kpi"><h3>Reddito imponibile</h3><div class="big" id="outImponibile">€ 0</div><div class="muted" style="font-size:.85rem">Incassato × coefficiente</div></div>
          <div class="kpi"><h3>Contributi INPS (fissi + variabile)</h3><div class="big" id="outInps">€ 0</div><div class="muted" style="font-size:.85rem">Minimi + contributi sul reddito</div></div>
          <div class="kpi"><h3>Imposta sostitutiva</h3><div class="big" id="outImposta">€ 0</div><div class="muted" style="font-size:.85rem">Su (imponibile − deducibili)</div></div>
        </div>
        <div class="kpis" style="margin-top:6px">
          <div class="kpi"><h3>Saldo da versare ora</h3><div class="big" id="outSaldo">€ 0</div><div class="muted" style="font-size:.85rem">Solo imposta + INPS variabile</div></div>
          <div class="kpi"><h3>Acconti netti</h3><div class="big" id="outAcconti">€ 0</div></div>
          <div class="kpi"><h3>Totale anno</h3><div class="big" id="outTotale">€ 0</div><div class="muted" style="font-size:.85rem">Minimi + saldi + acconti</div></div>
        </div>
        <div class="hr" style="height:1px;background:var(--border);margin:14px 0"></div>
        <div id="warnings" style="text-align:center"></div>
        <h3 style="margin:6px 0">Dettaglio</h3>
        <table><tbody id="tblDettaglio"></tbody><tfoot><tr><th style="text-align:right" colspan="1">Totale</th><th id="detTot" style="text-align:center"></th></tr></tfoot></table>
      </div>
    </div>

    <div id="tab3" class="tab">
      <h2 class="print-title">Scadenze da pagare</h2>
      <div class="pad">
        <h3 style="margin:0 0 6px">Contributi fissi (minimi)</h3>
        <table>
          <tbody id="tblFissi"></tbody>
          <tfoot><tr><th style="text-align:right" colspan="1">Totale minimi</th><th id="fissiTot" style="text-align:right"></th></tr></tfoot>
        </table>

        <h3 style="margin:18px 0 6px">Saldi + acconti (INPS variabile + imposta)</h3>
        <table>
          <tbody id="tblScadenze"></tbody>
          <tfoot><tr><th style="text-align:right" colspan="1">Totale anno (solo saldi + acconti)</th><th id="scadVarTot" style="text-align:right"></th></tr></tfoot>
        </table>

        <details class="rates" id="ratesAcc" style="margin-top:12px" open>
          <summary>Mostra dettaglio rate di giugno (5 rate con interessi) + riga di novembre</summary>
          <div id="rateBlock" style="margin-top:8px">
            <table>
              <thead><tr><th>#</th><th>Scadenza</th><th>Quota capitale</th><th>Interessi %</th><th>Interessi €</th><th>Rata</th></tr></thead>
              <tbody id="rateBody"></tbody>
              <tfoot>
                <tr><th colspan="4" style="text-align:right">Totale interessi giugno</th><th id="rateIntTot">€ 0</th><th id="rateTot">€ 0</th></tr>
                <tr><th colspan="5" style="text-align:right">Totale complessivo (giugno + novembre)</th><th id="rateTotAll">€ 0</th></tr>
              </tfoot>
            </table>
          </div>
        </details>

        <div class="desc" style="margin-top:10px">
          <b>Avvertenza:</b> le <b>percentuali</b> (aliquote e interessi di rateazione) possono variare di anno in anno.
          Anche la possibilità di <b>rateizzare i secondi acconti</b> può cambiare in base alla normativa vigente.
        </div>
      </div>
    </div>
  </section>
</div>

<script>
(function(){
  /* --- Utils --- */
  function euro(n){
    const r = Math.round(n || 0);
    try{
      return new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR',minimumFractionDigits:0,maximumFractionDigits:0}).format(r);
    }catch(e){
      return '€ ' + r.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');
    }
  }
  function parseNum(s){
    if(s==null) return 0;
    let t = String(s).trim().replace(/\s+/g,'');
    t = t.replace(/\./g,'').replace(",", '.');
    const n = parseFloat(t);
    return isNaN(n) ? 0 : n;
  }
  function val(id){return parseNum(document.getElementById(id).value)}
  function setHTML(id,html){const el=document.getElementById(id);if(el)el.innerHTML=html}
  function tr(a,b,right=false){return '<tr><td>'+a+'</td><td style="text-align:'+(right?'right':'center')+';font-variant-numeric:tabular-nums">'+b+'</td></tr>'}
  function perc(n,b){return b>0?(Math.round((n/b*100))+'%'):'0%'}

  /* --- Stato --- */
  let coeffFromChips=78;
  let lastState=null,cacheGiugno=0,cacheNov=0,cacheFissiTot=0,cacheFissiQ=[0,0,0,0];

  /* Tabs */
  document.addEventListener('click',e=>{
    const b=e.target.closest('.tab-btn'); if(!b) return;
    document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active'); document.getElementById(b.dataset.tab).classList.add('active');
  });

  /* Gestione info */
  function updateGestioneInfo(){
    const sel=document.getElementById('gestione');
    if(!sel) return;
    const g=sel.value||'commercianti';
    const baseFissi = g==='artigiani'?4460.64:4549.70;
    const aliq1 = g==='artigiani'?24:24.48;
    const aliq2 = g==='artigiani'?25:25.48;
    const label = g==='artigiani'?'Artigiani':'Commercianti';
    const text = `Gestione <b>${label}</b>: contributi fissi annui <b>${euro(baseFissi)}</b> (prima di eventuali riduzioni) + contributi variabili sul reddito imponibile <b>${aliq1}%</b> tra <b>18.555 €</b> e <b>55.448 €</b> e <b>${aliq2}%</b> oltre <b>55.448 €</b>.`;
    setHTML('gestInfoBox', text);
  }

  document.getElementById('gestione').addEventListener('change',updateGestioneInfo);

  /* Incassato */
  const incInput=document.getElementById('incassato');
  const incChips=document.getElementById('incChips');

  incInput.addEventListener('input', () => {
    incChips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  });

  incChips.addEventListener('click', (e) => {
    const chip=e.target.closest('.chip'); if(!chip) return;
    incChips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    const raw = chip.dataset.valNum || chip.dataset.val || chip.textContent;
    const clean = String(raw).replace(/\./g,'').replace(/\s/g,'');
    incInput.value = clean;
    incInput.focus();
    try{incInput.setSelectionRange(incInput.value.length,incInput.value.length);}catch{}
  });

  /* Coefficiente */
  document.getElementById('coeffChips').addEventListener('click',e=>{
    const c=e.target.closest('.chip'); if(!c) return;
    document.querySelectorAll('#coeffChips .chip').forEach(x=>x.classList.remove('active'));
    c.classList.add('active'); coeffFromChips=parseInt(c.dataset.coeff,10)||78;
    document.getElementById('coeffCustom').value='';
  });
  document.getElementById('coeffCustom').addEventListener('input',function(){
    this.value=this.value.replace(/\D/g,'').slice(0,2);
    document.querySelectorAll('#coeffChips .chip').forEach(x=>x.classList.remove('active'));
  });

  /* Agevolazione chips */
  const agevChips=document.getElementById('agevChips');
  agevChips.addEventListener('click',e=>{
    const chip=e.target.closest('.chip'); if(!chip) return;
    agevChips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
  });

  /* Apertura P.IVA */
  const pivaChips=document.getElementById('pivaChips');
  const dataApertura=document.getElementById('dataApertura');

  pivaChips.addEventListener('click',e=>{
    const chip=e.target.closest('.chip'); if(!chip) return;
    pivaChips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    const mode = chip.dataset.mode;
    if(mode==='2025'){
      dataApertura.disabled=false;
      if(!dataApertura.value) dataApertura.value='2025-01-01';
    }else{
      dataApertura.disabled=true;
      dataApertura.value='';
    }
  });

  /* Pill Manuale/Stima */
  function refreshAccMode(){
    const man=document.getElementById('pillManuale'), sti=document.getElementById('pillStima');
    const manual=man.classList.contains('active');
    document.getElementById('accManual').style.display=manual?'grid':'none';
    document.getElementById('accStima').style.display=manual?'none':'block';
    man.setAttribute('aria-pressed',manual?'true':'false');
    sti.setAttribute('aria-pressed',manual?'false':'true');
  }
  document.getElementById('pillManuale').addEventListener('click',function(){this.classList.add('active');document.getElementById('pillStima').classList.remove('active');refreshAccMode();});
  document.getElementById('pillStima').addEventListener('click',function(){this.classList.add('active');document.getElementById('pillManuale').classList.remove('active');refreshAccMode();});

  /* Modalità calcolo inverso */
  const invTotaleBox=document.getElementById('invTotaleBox');
  const invLavoroBox=document.getElementById('invLavoroBox');
  const pillInvTotale=document.getElementById('pillInvTotale');
  const pillInvLavoro=document.getElementById('pillInvLavoro');

  function updateInvMode(mode){
    const isTot = mode !== 'lavoro';
    if(invTotaleBox) invTotaleBox.style.display=isTot?'grid':'none';
    if(invLavoroBox) invLavoroBox.style.display=isTot?'none':'grid';
    if(pillInvTotale){
      pillInvTotale.classList.toggle('active',isTot);
      pillInvTotale.setAttribute('aria-pressed',isTot?'true':'false');
    }
    if(pillInvLavoro){
      pillInvLavoro.classList.toggle('active',!isTot);
      pillInvLavoro.setAttribute('aria-pressed',!isTot?'true':'false');
    }
    const out=document.getElementById('invOut');
    if(!out) return;
    if(isTot){
      out.innerHTML='In questa modalità calcoliamo l’incassato annuo necessario per ottenere il netto complessivo desiderato, considerando <b>minimi + imposta + acconti</b>.';
    }else{
      out.innerHTML='Qui calcoliamo il <b>compenso minimo</b> per un singolo lavoro, sapendo quanto ha già incassato il cliente, così da lasciargli in tasca il netto che hai indicato.';
    }
  }

  if(pillInvTotale) pillInvTotale.addEventListener('click',()=>updateInvMode('totale'));
  if(pillInvLavoro) pillInvLavoro.addEventListener('click',()=>updateInvMode('lavoro'));
  updateInvMode('totale');

  /* AVVISO DEDUCIBILI */
  function _parseNumLocal(v){
    if(v==null) return 0;
    const s = String(v).replace(/\./g,'').replace(',', '.');
    const n = Number(s);
    return isNaN(n) ? 0 : n;
  }
  function updateDeducibiliNotice(){
    const el = document.getElementById('deducibili');
    const note = document.getElementById('deducibiliNotice');
    if(!el || !note) return;
    const val = _parseNumLocal(el.value);
    note.classList.toggle('hidden', !(val > 0));
  }

  /* Raccolta parametri */
  function collectParams(overrideInc){
    const gestione = (document.getElementById('gestione').value || 'commercianti');
    let incassato = typeof overrideInc==='number' ? overrideInc : val('incassato');

    let coeffPerc=document.getElementById('coeffCustom').value?parseInt(document.getElementById('coeffCustom').value,10):coeffFromChips;
    if(!coeffPerc||coeffPerc<=0) coeffPerc=78;

    const impRate=parseFloat(document.getElementById('imposta').value)||0.05;

    const agevBtn = document.querySelector('#agevChips .chip.active');
    const agevKey = agevBtn ? agevBtn.dataset.agev : 'nessuna';

    const pivaBtn = document.querySelector('#pivaChips .chip.active');
    const pivaMode = pivaBtn ? pivaBtn.dataset.mode : 'pre';

    let dataApt = null;
    if(pivaMode==='2025'){
      const v=document.getElementById('dataApertura').value;
      if(v) dataApt=new Date(v+'T00:00:00');
    }

    const deducibili=val('deducibili');

    const percAccImp = parseNum(document.getElementById('percAccImp').value)||100;
    const percAccInps = parseNum(document.getElementById('percAccInps').value)||100;

    const manual=document.getElementById('pillManuale').classList.contains('active');

    let accImpPrevManual=0, accInpsPrevManual=0, incasso2024=0, coeff2024Perc=78, imp2024Rate=0.05;

    if(manual){
      accImpPrevManual = val('accImpPrev');
      accInpsPrevManual = val('accInpsPrev');
    }else{
      incasso2024 = val('incasso2024');
      coeff2024Perc = parseNum(document.getElementById('coeff2024').value)||78;
      imp2024Rate = parseFloat(document.getElementById('imp2024').value)||0.05;
    }

    return {
      gestione,
      incassato,
      coeffPerc,
      impRate,
      agevKey,
      pivaMode,
      dataApt,
      deducibili,
      percAccImp,
      percAccInps,
      accMode: manual?'manuale':'stima',
      accImpPrevManual,
      accInpsPrevManual,
      incasso2024,
      coeff2024Perc,
      imp2024Rate
    };
  }

  /* Logica contributi */
  function getAgevConfig(key){
    switch(key){
      case 'esenzione': return {label:'Esenzione (lavoro dipendente)', factor:0, esonero:true};
      case 'rid35': return {label:'Riduzione 35%', factor:0.65, esonero:false};
      case 'rid50': return {label:'Riduzione 50%', factor:0.5, esonero:false};
      case 'nessuna':
      default: return {label:'Nessuna agevolazione', factor:1, esonero:false};
    }
  }

  const MINIM=18555;
  const SOGLIA2=55448;
  const FISSI_BASE={artigiani:4460.64, commercianti:4549.70};
  const ALIQ1={artigiani:0.24, commercianti:0.2448};
  const ALIQ2={artigiani:0.25, commercianti:0.2548};

  function calcFissiProRata(baseAnn, openDate){
    const dueDates=[
      new Date('2025-05-16T00:00:00'),
      new Date('2025-08-20T00:00:00'),
      new Date('2025-11-17T00:00:00'),
      new Date('2026-02-16T00:00:00')
    ];
    const end2025=new Date('2026-01-01T00:00:00');
    const msDay=24*60*60*1000;
    let daysRem=Math.max(0,Math.round((end2025-openDate)/msDay));
    if(daysRem<=0) return {q:[0,0,0,0],tot:0};
    const fPro=baseAnn*(daysRem/365);
    let q=[0,0,0,0];

    let skipIdx=0;
    for(let i=0;i<dueDates.length;i++){
      if(dueDates[i]>=openDate){skipIdx=i;break;}
    }

    const fullQuota=baseAnn/4;
    let rem=[];
    for(let i=0;i<4;i++){
      if(i===skipIdx) continue;
      if(dueDates[i]>openDate) rem.push(i);
    }

    if(rem.length===0){
      q[skipIdx]=fPro;
      return {q:q,tot:fPro};
    }

    const nFull=Math.min(2,rem.length);
    const fullIdxs=rem.slice(-nFull);
    let fullSum=0;
    fullIdxs.forEach(i=>{q[i]=fullQuota;fullSum+=fullQuota;});

    const leftover=rem.slice(0,rem.length-nFull);
    let remaining=Math.max(0,fPro-fullSum);

    if(leftover.length>0){
      const adjIdx=leftover[0];
      q[adjIdx]=remaining;
    }else if(fullSum>0 && fPro>0){
      const ratio=fPro/fullSum;
      fullIdxs.forEach(i=>{q[i]=q[i]*ratio;});
    }

    const tot=q.reduce((a,b)=>a+b,0);
    return {q:q,tot:tot};
  }

  function calcVariabile(imponibile, gestione, factor){
    let base1=0, base2=0;
    if(imponibile>MINIM){
      base1=Math.min(imponibile,SOGLIA2)-MINIM;
      if(imponibile>SOGLIA2) base2=imponibile-SOGLIA2;
    }
    const a1=ALIQ1[gestione]||0;
    const a2=ALIQ2[gestione]||0;
    const var1L=base1*a1;
    const var2L=base2*a2;
    const var1=var1L*factor;
    const var2=var2L*factor;
    const varTot=var1+var2;
    return {base1,base2,var1,var2,varTot,aliq1:a1,aliq2:a2};
  }

  function computePrevAcconti(params, agevCfg){
    if(params.accMode==='manuale'){
      return {
        accImpPrev:Math.max(0,params.accImpPrevManual||0),
        accInpsPrev:Math.max(0,params.accInpsPrevManual||0)
      };
    }
    const inc24=params.incasso2024||0;
    if(inc24<=0) return {accImpPrev:0,accInpsPrev:0};
    const coeff24=(params.coeff2024Perc>0?params.coeff2024Perc:78)/100;
    const impon24=inc24*coeff24;
    const var24=calcVariabile(impon24,params.gestione,agevCfg.factor).varTot;
    const imp24Rate=params.imp2024Rate||0.05;
    const imp24=impon24*imp24Rate;
    return {accImpPrev:imp24,accInpsPrev:var24};
  }

  function calcScenario(params){
    const coeff=params.coeffPerc/100;
    const imponibileForf=params.incassato*coeff;
    const agevCfg=getAgevConfig(params.agevKey);
    const factor=agevCfg.factor;

    // Fissi
    let fissiQ=[0,0,0,0], fissiTot=0;
    const baseAnn=FISSI_BASE[params.gestione]*factor;

    if(factor===0){
      fissiQ=[0,0,0,0]; fissiTot=0;
    }else{
      if(params.pivaMode==='pre' || !params.dataApt || params.dataApt<=new Date('2025-01-01T00:00:00')){
        const q=baseAnn/4;
        fissiQ=[q,q,q,q]; fissiTot=baseAnn;
      }else{
        const pr=calcFissiProRata(baseAnn,params.dataApt);
        fissiQ=pr.q; fissiTot=pr.tot;
      }
    }

    // Variabile
    const varData=calcVariabile(imponibileForf,params.gestione,factor);

    const inpsVar=varData.varTot;
    const inpsTot=fissiTot+inpsVar;

    // Acconti 2024
    const prev=computePrevAcconti(params,agevCfg);
    const accImpPrev=prev.accImpPrev;
    const accInpsPrev=prev.accInpsPrev;

    // Imposta
    const imponibileFisc=Math.max(0,imponibileForf-Math.max(0,params.deducibili||0));
    const imposta=imponibileFisc*params.impRate;

    // Saldi (solo INPS variabile + imposta)
    const saldoImposta=Math.max(0,imposta-accImpPrev);
    const saldoInpsVar=Math.max(0,inpsVar-accInpsPrev);
    const saldoTotale=saldoImposta+saldoInpsVar;

    const creditoImp=Math.max(0,accImpPrev-imposta);
    const creditoInps=Math.max(0,accInpsPrev-inpsVar);

    // Nuovi acconti (percentuali su imposta e INPS variabile)
    const ACC_IMP_PERC=(params.percAccImp>0?params.percAccImp:100)/100;
    const ACC_INPS_PERC=(params.percAccInps>0?params.percAccInps:100)/100;

    const accImpBase=imposta*ACC_IMP_PERC;
    const accInpsBase=inpsVar*ACC_INPS_PERC;

    const accImpTot=Math.max(0,accImpBase-creditoImp);
    const accInpsTot=Math.max(0,accInpsBase-creditoInps);

    const creditoImpResid=Math.max(0,creditoImp-accImpBase);
    const creditoInpsResid=Math.max(0,creditoInps-accInpsBase);

    const accImp1=accImpTot*0.5, accImp2=accImpTot*0.5;
    const accInps1=accInpsTot*0.5, accInps2=accInpsTot*0.5;

    const accontiTot=accImpTot+accInpsTot;

    const giugnoTot=saldoTotale+accImp1+accInps1;
    const novembreTot=accImp2+accInps2;

    const totaleAnno=fissiTot+saldoTotale+accontiTot;

    return {
      gestione:params.gestione,
      incassato:params.incassato,
      coeffPerc:params.coeffPerc,
      coeff,
      impRate:params.impRate,
      agevKey:params.agevKey,
      agevCfg,
      imposta,
      pivaMode:params.pivaMode,
      dataApt:params.dataApt,
      deducibili:params.deducibili||0,
      percAccImp:params.percAccImp,
      percAccInps:params.percAccInps,
      incasso2024:params.incasso2024,
      coeff2024Perc:params.coeff2024Perc,
      imp2024Rate:params.imp2024Rate,
      imponibileForf,
      imponibileFisc,
      fissiQ,
      fissiTot,
      inpsVarBase1:varData.base1,
      inpsVarBase2:varData.base2,
      inpsVar1:varData.var1,
      inpsVar2:varData.var2,
      aliqVar1:varData.aliq1,
      aliqVar2:varData.aliq2,
      inpsVar,
      inpsTot,
      accImpPrev,
      accInpsPrev,
      saldoImposta,
      saldoInpsVar,
      saldoTotale,
      creditoImp,
      creditoInps,
      creditoImpResid,
      creditoInpsResid,
      accImpTot,
      accInpsTot,
      accImp1,
      accImp2,
      accInps1,
      accInps2,
      accontiTot,
      giugnoTot,
      novembreTot,
      totaleAnno
    };
  }

  /* Compute principale */
  function compute(){
    const err=document.getElementById('err');
    const incassatoVal=val('incassato');
    if(incassatoVal<=0){
      err.style.display='block';
      err.textContent='Inserisci un incassato annuo valido (> 0) o usa il calcolo inverso nelle Opzioni avanzate.';
      document.getElementById('resultsBox').style.display='none';
      return;
    }
    err.style.display='none';
    updateDeducibiliNotice();

    const params=collectParams();
    params.incassato=incassatoVal;
    const s=calcScenario(params);
    lastState=s;

    /* KPI */
    setHTML('outImponibile',euro(s.imponibileForf));
    setHTML('outInps',euro(s.inpsTot));
    setHTML('outImposta',euro(s.imposta));
    setHTML('outSaldo',euro(s.saldoTotale));
    setHTML('outAcconti',euro(s.accontiTot));
    setHTML('outTotale',euro(s.totaleAnno));
    setHTML('liveResult',`Aggiornato. Saldi ${euro(s.saldoTotale)}, acconti ${euro(s.accontiTot)}, totali (inclusi minimi) ${euro(s.totaleAnno)}.`);

    /* Note soglie */
    let w='';
    if(s.incassato>100000) w='<div class="muted"><b>Attenzione:</b> oltre 100.000€ → uscita <b>immediata</b> dal forfettario.</div>';
    else if(s.incassato>85000) w='<div class="muted"><b>Nota:</b> oltre 85.000€ → uscita dal forfettario <b>dall’anno successivo</b>.</div>';
    setHTML('warnings',w);

    /* Dettaglio (tab 2) */
    let det='';
    const gestLabel=s.gestione==='artigiani'?'Artigiani':'Commercianti';
    det+='<tr><th colspan="2">Dati di base</th></tr>';
    det+=tr('Gestione INPS',gestLabel);
    det+=tr('Incassato',euro(s.incassato));
    det+=tr('Coefficiente',Math.round(s.coeff*100)+'%');
    det+=tr('Imponibile forfettario',euro(s.imponibileForf));
    det+=tr('Agevolazione contributiva',s.agevCfg.label);

    det+='<tr><th colspan="2">Contributi fissi (minimi)</th></tr>';
    det+=tr('Totale minimi',euro(s.fissiTot));
    const labelsF=['16/05/2025 — Q1','20/08/2025 — Q2','17/11/2025 — Q3','16/02/2026 — Q4'];
    for(let i=0;i<4;i++){
      det+=tr(labelsF[i],euro(s.fissiQ[i]||0),true);
    }

    det+='<tr><th colspan="2">Contributi variabili sul reddito</th></tr>';
    det+=tr(`Base 1 (18.555–55.448)`,`${euro(s.inpsVarBase1)} × ${(s.aliqVar1*100).toFixed(2)}% → ${euro(s.inpsVar1)}`,true);
    det+=tr(`Base 2 (&gt;55.448)`,`${euro(s.inpsVarBase2)} × ${(s.aliqVar2*100).toFixed(2)}% → ${euro(s.inpsVar2)}`,true);
    det+=tr('Variabile totale',euro(s.inpsVar));
    det+=tr('INPS totale (minimi + variabile)',euro(s.inpsTot));

    det+='<tr><th colspan="2">Imposta, saldi e acconti</th></tr>';
    det+=tr('Contributi deducibili per imposta','− '+euro(s.deducibili));
    det+=tr('Base per imposta',euro(s.imponibileFisc));
    det+=tr('Aliquota imposta',Math.round(s.impRate*100)+'%');
    det+=tr('Imposta calcolata',euro(s.imposta));
    det+=tr('Acconti imposta 2024','− '+euro(s.accImpPrev));
    det+=tr('Acconti INPS 2024 (variabile)','− '+euro(s.accInpsPrev));
    det+=tr('Saldo imposta',euro(s.saldoImposta));
    det+=tr('Saldo INPS variabile',euro(s.saldoInpsVar));
    det+=tr('Saldo totale (F24 giugno)',euro(s.saldoTotale));

    det+='<tr><th colspan="2">Nuovi acconti 2025</th></tr>';
    det+=tr(`Acconti IMPOSTA 2025 (${s.percAccImp}% del dovuto)`,euro(s.accImpTot));
    det+=tr(`Acconti INPS variabile 2025 (${s.percAccInps}% del dovuto)`,euro(s.accInpsTot));
    det+=tr('Imposta – 1° acconto (giugno)',euro(s.accImp1));
    det+=tr('Imposta – 2° acconto (novembre)',euro(s.accImp2));
    det+=tr('INPS variabile – 1° acconto (giugno)',euro(s.accInps1));
    det+=tr('INPS variabile – 2° acconto (novembre)',euro(s.accInps2));

    setHTML('tblDettaglio',det);
    setHTML('detTot',euro(s.totaleAnno));

    /* Scadenze (tab 3) */
    cacheGiugno=s.giugnoTot;
    cacheNov=s.novembreTot;
    cacheFissiTot=s.fissiTot;
    cacheFissiQ=s.fissiQ.slice();

    let fTab='';
    const lblF=['16/05/2025 — Q1','20/08/2025 — Q2','17/11/2025 — Q3','16/02/2026 — Q4'];
    for(let i=0;i<4;i++){
      fTab+=tr(lblF[i],euro(s.fissiQ[i]||0),true);
    }
    setHTML('tblFissi',fTab);
    setHTML('fissiTot',euro(s.fissiTot));

    let sc='';
    sc+=tr('<span class="badge-month">Giugno</span> — saldi (INPS variabile + imposta) + 1° acconti',euro(s.giugnoTot),true);
    sc+=tr('<span class="badge-month">Novembre</span> — 2° acconti',euro(s.novembreTot),true);
    setHTML('tblScadenze',sc);
    setHTML('scadVarTot',euro(s.giugnoTot+s.novembreTot));

    document.getElementById('ratesAcc').open=true;
    buildRate();

    buildExplanation();
    document.getElementById('resultsBox').style.display='';
  }

  /* Helpers per spiegazione */
  function P(t){return `<p class="line">${t}</p>`}
  function wrapSection(title,inner,cls){return `<div class="section ${cls||''}">
    <button type="button" class="copy-btn" title="Copia" aria-label="Copia">Copia</button>
    <div class="copy-content">${title?`<h3>${title}</h3>`:''}${inner}</div></div>`}

  function buildExplanation(){
    if(!lastState) return;
    const s=lastState;
    const simple=document.getElementById('simpToggle').checked;
    document.getElementById('viewLabel').textContent = simple ? 'Vista Semplificata' : 'Vista Dettagliata';

    const gestLabel=s.gestione==='artigiani'?'Artigiani':'Commercianti';
    const inc=euro(s.incassato);
    const impForf=euro(s.imponibileForf);
    const impPerc=Math.round(s.impRate*100);
    const inpsTot=euro(s.inpsTot);
    const inpsVar=euro(s.inpsVar);
    const fissiTot=euro(s.fissiTot);
    const saldoImp=euro(s.saldoImposta);
    const saldoInps=euro(s.saldoInpsVar);
    const saldoTot=euro(s.saldoTotale);
    const accTot=euro(s.accontiTot);
    const totAnno=euro(s.totaleAnno);
    const giu=euro(s.giugnoTot);
    const nov=euro(s.novembreTot);
    const baseImp=euro(s.imponibileFisc);
    const ded=euro(s.deducibili);
    const accImpPrev=euro(s.accImpPrev);
    const accInpsPrev=euro(s.accInpsPrev);
    const accImpTot=euro(s.accImpTot);
    const accInpsTot=euro(s.accInpsTot);

    const minBase=FISSI_BASE[s.gestione]||0;
    const minBaseStr=euro(minBase);
    const a1=(s.aliqVar1*100).toFixed(2);
    const a2=(s.aliqVar2*100).toFixed(2);
    const base1=euro(s.inpsVarBase1);
    const base2=euro(s.inpsVarBase2);

    let agevNote='';
    if(s.agevCfg.esonero){
      agevNote='Hai indicato <b>esenzione per lavoro dipendente</b>: i contributi INPS (minimi e variabili) risultano pari a 0 €, paghi solo l’imposta sostitutiva.';
    }else if(s.agevKey==='rid35'){
      agevNote='Hai attivato la <b>riduzione del 35%</b>: paghi il 65% dei contributi minimi e variabili.';
    }else if(s.agevKey==='rid50'){
      agevNote='Hai attivato la <b>riduzione del 50%</b>: paghi metà dei contributi minimi e variabili.';
    }else{
      agevNote='Non hai agevolazioni: paghi il 100% dei contributi minimi e variabili.';
    }

    let html='';

    // Premessa
    html+=wrapSection('Come funziona (in breve)',
      P(`Nel regime forfettario paghi le tasse e i contributi <b>non</b> sul totale che incassi, ma sul tuo incassato moltiplicato per il <b>coefficiente di redditività</b>.`) +
      P(`Nel tuo caso hai incassato <b>${inc}</b> e usi un coefficiente del <b>${s.coeffPerc}%</b>, quindi l’imponibile forfettario è <b>${impForf}</b>.`) +
      P(`Su questo imponibile paghi un’imposta sostitutiva del <b>${impPerc}%</b> e i contributi INPS <b>${gestLabel}</b> composti da <b>contributi fissi (minimi)</b> più <b>contributi variabili</b> solo sulla parte di reddito che supera i <b>18.555 €</b>.`) +
      P(agevNote)
    ,'');

    if(!simple){
      // 1. Imponibile
      html+=wrapSection('1. Imponibile forfettario',
        P(`Partiamo dall’incassato: <b>${inc}</b>.`) +
        P(`Applichiamo il coefficiente di redditività <b>${s.coeffPerc}%</b>:`) +
        P(`<span class="mono">${inc} × ${s.coeffPerc}% = ${impForf}</span>.`) +
        P(`Questa è la base su cui si calcolano sia l’imposta sia i contributi INPS variabili.`),
      '');

      // 2. Minimi
      const lblF=['16/05/2025 — Q1','20/08/2025 — Q2','17/11/2025 — Q3','16/02/2026 — Q4'];
      let righe='';
      for(let i=0;i<4;i++){
        righe+=P(`<span class="mono">${lblF[i]} → ${euro(s.fissiQ[i]||0)}</span>`);
      }

      let aperturaTesto='';
      if(s.pivaMode==='pre' || !s.dataApt || s.dataApt<=new Date('2025-01-01T00:00:00')){
        aperturaTesto='Hai indicato una partita IVA già aperta prima del 2025 (o dal 1° gennaio): i minimi sono distribuiti in 4 rate uguali durante l’anno.';
      }else{
        const d=s.dataApt;
        const dd=d.getDate().toString().padStart(2,'0');
        const mm=(d.getMonth()+1).toString().padStart(2,'0');
        aperturaTesto=`Hai indicato una partita IVA aperta il <b>${dd}/${mm}/2025</b>: la prima scadenza utile dopo questa data è messa a <b>0 €</b>, la successiva è “aggiustata” pro-rata in base ai giorni di attività e le ultime due rate sono quanto più possibile piene.`;
      }

      html+=wrapSection('2. Contributi fissi (minimi)',
        P(`Per la gestione <b>${gestLabel}</b> i contributi fissi annui “pieni” (senza agevolazioni) sarebbero <b>${minBaseStr}</b>. Dopo aver applicato la tua agevolazione arriviamo a minimi complessivi di <b>${fissiTot}</b>.`) +
        P(aperturaTesto) +
        righe +
        P(`Questi importi hanno <b>scadenze autonome</b> (maggio, agosto, novembre e febbraio) e non rientrano nel “saldo di giugno” né nei nuovi acconti.`),
      'inps');

      // 3. Variabile
      let varIntro=P(`I contributi INPS <b>variabili</b> si applicano solo sulla parte di reddito che supera i <b>18.555 €</b>.`) +
                   P(`Per la gestione <b>${gestLabel}</b> le aliquote 2025 sono:`) +
                   P(`<span class="mono">${a1}%</span> tra <b>18.555 €</b> e <b>55.448 €</b>, e <span class="mono">${a2}%</span> sulla parte oltre <b>55.448 €</b>, sempre dopo aver applicato l’agevolazione.`);

      let varDet='';
      if(s.inpsVarBase1>0){
        varDet+=P(`Base 1: <span class="mono">${base1}</span> × ${a1}% (agevolata) → <b>${euro(s.inpsVar1)}</b>.`);
      }else{
        varDet+=P(`Nel tuo caso la base 1 (18.555–55.448) è pari a <b>0 €</b> oppure l’imponibile non supera i 18.555 €.`);
      }
      if(s.inpsVarBase2>0){
        varDet+=P(`Base 2: <span class="mono">${base2}</span> × ${a2}% (agevolata) → <b>${euro(s.inpsVar2)}</b>.`);
      }
      varDet+=P(`Totale INPS variabile: <b>${inpsVar}</b>.`);

      if(s.agevCfg.esonero){
        varIntro+=P(`Con l’esenzione per lavoro dipendente, i contributi variabili sono azzerati (INPS = 0 €).`);
      }

      html+=wrapSection('3. Contributi variabili sul reddito', varIntro+varDet,'inps');

      // 4. Imposta
      let impTxt='';
      if(s.deducibili>0){
        impTxt+=P(`Dall’imponibile forfettario <b>${impForf}</b> togliamo i <b>contributi deducibili</b> (${ded}):`) +
                P(`<span class="mono">${impForf} − ${ded} = ${baseImp}</span>.`);
        impTxt+=P(`<b>Attenzione:</b> i contributi sono deducibili solo se <b>realmente versati</b> nell’anno.`);
      }else{
        impTxt+=P(`Non hai indicato contributi deducibili: la base per l’imposta coincide con l’imponibile forfettario, pari a <b>${baseImp}</b>.`);
      }
      impTxt+=P(`Su questa base applichiamo l’aliquota del <b>${impPerc}%</b>:`) +
               P(`<span class="mono">${baseImp} × ${impPerc}% = ${euro(s.imposta)}</span>.`);

      if(s.accImpPrev>0){
        impTxt+=P(`Hai inserito acconti d’imposta 2024 pari a <b>${accImpPrev}</b>, che riducono il saldo di quest’anno.`);
      }
      if(s.accInpsPrev>0){
        impTxt+=P(`Per l’INPS variabile hai acconti 2024 pari a <b>${accInpsPrev}</b>, che riducono il saldo dei contributi sul reddito.`);
      }

      impTxt+=P(`Alla fine abbiamo:`) +
               P(`<span class="mono">Saldo imposta = ${saldoImp}</span>`) +
               P(`<span class="mono">Saldo INPS variabile = ${saldoInps}</span>`) +
               P(`<span class="mono">Saldo totale (solo imposta + INPS variabile) = ${saldoTot}</span>.`);

      html+=wrapSection('4. Imposta sostitutiva e saldi', impTxt,'imp');

      // 5. Acconti
      let accTxt='';
      accTxt+=P(`Dopo aver calcolato il dovuto dell’anno, applichiamo le percentuali di acconto che hai indicato:`) +
              P(`<b>Imposta</b>: ${s.percAccImp}% → acconti totali <b>${accImpTot}</b>.`) +
              P(`<b>INPS variabile</b>: ${s.percAccInps}% → acconti totali <b>${accInpsTot}</b>.`);
      accTxt+=P(`Questi acconti sono divisi in due momenti:`) +
              P(`<b>Giugno</b>: 1° acconto imposta (${euro(s.accImp1)}) + 1° acconto INPS variabile (${euro(s.accInps1)}).`) +
              P(`<b>Novembre</b>: 2° acconto imposta (${euro(s.accImp2)}) + 2° acconto INPS variabile (${euro(s.accInps2)}).`);
      if(s.creditoImp>0 || s.creditoInps>0){
        accTxt+=P(`Eventuali eccedenze di acconti 2024 sono usate prima per ridurre i nuovi acconti; un eventuale residuo rimane come credito da riportare.`);
      }

      html+=wrapSection('5. Nuovi acconti 2025', accTxt,'');

      // 6. Totale
      html+=wrapSection('6. Totale anno e incidenza',
        P(`Mettendo insieme tutto, il costo complessivo dell’anno è:`) +
        P(`<span class="mono">Minimi ${fissiTot} + saldi (imp.+INPS variabile) ${saldoTot} + acconti ${accTot} = <b>${totAnno}</b></span>.`) +
        P(`In termini percentuali sul tuo incassato <b>${inc}</b>: saldi incidono per circa <b>${perc(s.saldoTotale,s.incassato)}</b>, acconti per <b>${perc(s.accontiTot,s.incassato)}</b> e il totale (minimi inclusi) per circa <b>${perc(s.totaleAnno,s.incassato)}</b>.`),
      '');

      html+=wrapSection('7. Scadenze principali',
        P(`I contributi <b>fissi (minimi)</b> seguono le quattro scadenze INPS (maggio, agosto, novembre, febbraio dell’anno successivo).`) +
        P(`La parte <b>variabile + imposta</b> si concentra invece su:`) +
        P(`<b>Giugno</b>: saldi imposta + INPS variabile (<b>${saldoTot}</b>) + primi acconti → <b>${giu}</b>.`) +
        P(`<b>Novembre</b>: secondi acconti → <b>${nov}</b>.`),
      '');

    }else{
      // Vista semplificata
      html+=wrapSection('Imponibile forfettario',
        P(`Incassato <b>${inc}</b> × coefficiente <b>${s.coeffPerc}%</b> = imponibile <b>${impForf}</b>.`),
      '');

      html+=wrapSection('Contributi INPS',
        P(`Minimi (gestione ${gestLabel}) dopo agevolazioni: <b>${fissiTot}</b> su 4 scadenze fisse.`) +
        P(`Contributi variabili sul reddito oltre 18.555 €: <b>${inpsVar}</b>.`) +
        P(`INPS totale (minimi + variabile): <b>${inpsTot}</b>.`),
      'inps');

      let impS=P(`Base per imposta: <b>${baseImp}</b> (dopo eventuali contributi deducibili).`) +
               P(`Imposta sostitutiva al <b>${impPerc}%</b>: <b>${euro(s.imposta)}</b>.`);
      html+=wrapSection('Imposta sostitutiva', impS,'imp');

      html+=wrapSection('Saldi + acconti',
        P(`Saldi da versare (solo imposta + INPS variabile): <b>${saldoTot}</b>.`) +
        P(`Nuovi acconti (imposta + INPS variabile): <b>${accTot}</b>.`) +
        P(`Totale anno (minimi + saldi + acconti): <b>${totAnno}</b>.`),
      '');

      html+=wrapSection('Scadenze',
        P(`<b>Minimi</b>: Q1, Q2, Q3, Q4 secondo tabella delle scadenze.`) +
        P(`<b>Giugno</b>: saldi + primi acconti ≈ <b>${giu}</b>.`) +
        P(`<b>Novembre</b>: secondi acconti ≈ <b>${nov}</b>.`),
      '');
    }

    setHTML('explanation',html);
  }

  /* Rate */
  function buildRate(){
    const totGiu=cacheGiugno;
    const quota=totGiu/5;
    let tbody='',sumInt=0,sumTotGiu=0;
    const RATE_PERC=[0.00,0.18,0.51,0.84,1.17];
    const RATE_DATE=["30 giugno","16 luglio","20 agosto","16 settembre","16 ottobre"];
    for(let i=0;i<5;i++){
      const p=RATE_PERC[i]/100, interesse=totGiu*p, rata=quota+interesse;
      sumInt+=interesse; sumTotGiu+=rata;
      tbody+=`<tr><td>${i+1}</td><td>${RATE_DATE[i]}</td><td>${euro(quota)}</td><td>${RATE_PERC[i].toFixed(2)}%</td><td>${euro(interesse)}</td><td><b>${euro(rata)}</b></td></tr>`;
    }
    tbody+=`<tr><td>6</td><td><b>Novembre — 2° acconti</b></td><td>${euro(cacheNov)}</td><td>—</td><td>—</td><td><b>${euro(cacheNov)}</b></td></tr>`;
    setHTML('rateBody',tbody);
    setHTML('rateIntTot',euro(sumInt));
    setHTML('rateTot',euro(sumTotGiu));
    setHTML('rateTotAll',euro(sumTotGiu+cacheNov));
  }

  /* Netto desiderato → incassato (totale anno) */
  function netAfterTotale(inc){
    const params=collectParams(inc);
    const s=calcScenario(params);
    return inc - s.totaleAnno;
  }

  function findIncassatoForNet(target){
    target=Math.max(0,target||0);
    let lo=0, hi=Math.max(20000, target*3+10000);
    for(let i=0;i<40 && netAfterTotale(hi)<target;i++) hi*=1.6;
    for(let k=0;k<64;k++){
      const mid=(lo+hi)/2;
      if(netAfterTotale(mid)>=target) hi=mid; else lo=mid;
    }
    return Math.round(hi);
  }

  /* Netto extra su nuovo lavoro → incasso totale */
  function findIncassoTotaleForExtraNet(extraNet, incassoAttuale){
    extraNet=Math.max(0,extraNet||0);
    incassoAttuale=Math.max(0,incassoAttuale||0);
    if(extraNet===0) return incassoAttuale;

    const net0=netAfterTotale(incassoAttuale);
    const targetNet=net0+extraNet;

    let lo=incassoAttuale;
    let hi=Math.max(incassoAttuale+extraNet*4+5000,incassoAttuale+20000);

    for(let i=0;i<40 && netAfterTotale(hi)<targetNet;i++){
      hi = incassoAttuale + (hi-incassoAttuale)*1.6;
    }
    let best=hi;
    for(let k=0;k<64;k++){
      const mid=(lo+hi)/2;
      const netMid=netAfterTotale(mid);
      if(netMid>=targetNet){best=mid;hi=mid;}else{lo=mid;}
    }
    return Math.round(best);
  }

  /* Stampa */
  document.getElementById('btnPrint').addEventListener('click',()=>{
    const vis=document.getElementById('resultsBox').style.display!=='none';
    if(!vis){alert('Prima clicca su CALCOLA per generare i risultati da stampare.');return;}
    window.print();
  });

  /* Inverso: netto annuo totale */
  document.getElementById('btnInverti').addEventListener('click',()=>{
    const target=val('nettoTargetTot');
    if(target<=0){setHTML('invOut','Inserisci un netto annuo desiderato valido.');return;}
    const inc=findIncassatoForNet(target);
    const incInput=document.getElementById('incassato');
    incInput.value=String(inc);
    [...document.getElementById('incChips').querySelectorAll('.chip')].forEach(c=>c.classList.remove('active'));
    setHTML('invOut',`Per portare il <b>netto complessivo dell’anno</b> intorno a <b>${euro(target)}</b>, ti servono circa <b>${euro(inc)}</b> di incassato complessivo (considerando minimi + imposta + acconti).`);
    compute();
    window.scrollTo({top:0,behavior:'smooth'});
  });

  /* Inverso: netto in più su nuovo lavoro */
  document.getElementById('btnInvJob').addEventListener('click',()=>{
    const incAtt=val('incassoAttuale');
    const extraNet=val('nettoLavoro');

    if(extraNet<=0){
      setHTML('invOut','Inserisci un netto desiderato valido per il nuovo lavoro (es. 2000).');
      return;
    }
    if(incAtt<0){
      setHTML('invOut','L’incassato attuale non può essere negativo.');
      return;
    }

    const incTot=findIncassoTotaleForExtraNet(extraNet,incAtt);
    const compenso=Math.max(0,incTot-Math.max(0,incAtt));

    // scenari prima / dopo
    const params0=collectParams(Math.max(0,incAtt));
    const s0=calcScenario(params0);
    const params1=collectParams(incTot);
    const s1=calcScenario(params1);

    const tasse0=s0.totaleAnno;
    const tasse1=s1.totaleAnno;
    const extraTasse=Math.max(0,tasse1-tasse0);

    const net0=incAtt-tasse0;
    const net1=incTot-tasse1;
    const netExtra=net1-net0;

    const percFisco=compenso>0?Math.round(extraTasse/compenso*100):0;

    const reddito0=s0.imponibileForf;
    const reddito1=s1.imponibileForf;
    const fissiTot=s1.fissiTot;

    let msg=`Per dare al cliente circa <b>${euro(extraNet)}</b> netti in più su questo lavoro, il compenso da chiedere è circa <b>${euro(compenso)}</b> (lordi).<br>`;
    msg+=`Su questi ${euro(compenso)} lo Stato si prende circa <b>${euro(extraTasse)}</b> (≈ <b>${percFisco||0}%</b>) tra imposta, contributi variabili e acconti.<br>`;
    msg+=`Il netto stimato aggiuntivo passa da circa <b>${euro(net0)}</b> a circa <b>${euro(net1)}</b> (extra netto ≈ <b>${euro(netExtra)}</b>).<br>`;

    if(reddito0>=MINIM){
      msg+=`In questo momento il reddito imponibile del cliente è circa <b>${euro(reddito0)}</b>, quindi è già oltre il minimale di ${euro(MINIM)}: questo lavoro genera soprattutto <b>imposta</b> e <b>contributi variabili/acconti</b>. I contributi fissi annui (${euro(fissiTot)}) restano invariati e li pagherebbe comunque.`;
    }else{
      msg+=`Al momento il reddito imponibile del cliente è circa <b>${euro(reddito0)}</b>, ancora sotto il minimale di ${euro(MINIM)}: i contributi fissi INPS (circa <b>${euro(fissiTot)}</b> annui) li paga comunque sull’anno, indipendentemente da questo singolo lavoro.`;
      if(reddito1>MINIM){
        msg+=`<br>Con questo lavoro il reddito imponibile supera il minimale, quindi iniziano ad attivarsi anche i <b>contributi variabili</b> sul reddito oltre i 18.555 € (oltre ai minimi).`;
      }
    }

    setHTML('invOut',msg);

    // aggiorno il simulatore allo scenario "dopo lavoro"
    const incAssatoInput=document.getElementById('incassato');
    incAssatoInput.value=String(incTot);
    [...document.getElementById('incChips').querySelectorAll('.chip')].forEach(c=>c.classList.remove('active'));
    compute();
    window.scrollTo({top:0,behavior:'smooth'});
  });

  /* Calcola / Reset / Init */
  document.getElementById('btnCalc').addEventListener('click',()=>{ compute(); });

  document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('coeffChips').querySelector('.chip[data-coeff="78"]').classList.add('active');
    updateGestioneInfo();

    // Invio = Calcola (simulatore)
    ['incassato','deducibili','accImpPrev','accInpsPrev','incasso2024','coeff2024','percAccImp','percAccInps']
      .forEach(id=>{
        const el=document.getElementById(id);
        if(!el) return;
        el.addEventListener('keydown',e=>{
          if(e.key==='Enter'){
            e.preventDefault();
            document.getElementById('btnCalc').click();
          }
        });
      });

    // Invio = calcoli inversi
    [
      ['nettoTargetTot','btnInverti'],
      ['incassoAttuale','btnInvJob'],
      ['nettoLavoro','btnInvJob']
    ].forEach(pair=>{
      const [inputId,btnId]=pair;
      const el=document.getElementById(inputId);
      const btn=document.getElementById(btnId);
      if(!el || !btn) return;
      el.addEventListener('keydown',e=>{
        if(e.key==='Enter'){
          e.preventDefault();
          btn.click();
        }
      });
    });

    document.getElementById('deducibili')?.addEventListener('input', updateDeducibiliNotice);
    updateDeducibiliNotice();

    document.getElementById('btnReset').addEventListener('click',()=>{
      ['incassato','deducibili','accImpPrev','accInpsPrev','incasso2024','nettoTargetTot','incassoAttuale','nettoLavoro'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
      document.getElementById('coeffCustom').value='';
      document.querySelectorAll('#coeffChips .chip').forEach(x=>x.classList.remove('active'));
      document.querySelector('#coeffChips .chip[data-coeff="78"]').classList.add('active'); coeffFromChips=78;
      document.getElementById('imposta').value='0.05';
      document.getElementById('gestione').value='commercianti';
      updateGestioneInfo();

      // Agevolazione
      document.querySelectorAll('#agevChips .chip').forEach(c=>c.classList.remove('active'));
      document.querySelector('#agevChips .chip[data-agev="nessuna"]').classList.add('active');

      // Apertura P.IVA
      document.querySelectorAll('#pivaChips .chip').forEach(c=>c.classList.remove('active'));
      document.querySelector('#pivaChips .chip[data-mode="pre"]').classList.add('active');
      const dataApt=document.getElementById('dataApertura');
      dataApt.disabled=true;
      dataApt.value='';

      document.getElementById('percAccImp').value='100';
      document.getElementById('percAccInps').value='100';

      document.getElementById('pillManuale').classList.add('active');
      document.getElementById('pillStima').classList.remove('active');
      refreshAccMode();

      updateInvMode('totale');

      document.getElementById('ratesAcc').open=true;
      document.getElementById('simpToggle').checked=false; document.getElementById('viewLabel').textContent='Vista Dettagliata';
      document.getElementById('resultsBox').style.display='none'; window.scrollTo({top:0,behavior:'smooth'});
      setHTML('invOut',''); setHTML('warnings','');
      const tb=document.querySelector('.tab-btn[data-tab="tab1"]'); if(tb) tb.click();
      updateDeducibiliNotice();
    });
  });
})();
</script>
</body>
</html>
