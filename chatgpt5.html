<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulatore Forfettario • Gestione Separata 2025</title>

<!-- Font stile Fiscozen -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f7f9fc; --card:#fff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb;
    --accent:#2563eb; --radius:16px; --shadow:0 12px 28px rgba(15,23,42,.08);
    --hl-y:#fff7b3; --hl-g:#d1fae5; --hl-b:#dbeafe; --hl-p:#ffe4e6;
  }
  *{box-sizing:border-box}
  html{font-size:18px} /* font più grande */
  body{
    margin:0;
    font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Helvetica Neue", sans-serif;
    background:var(--bg); color:var(--text); line-height:1.6;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  }
  .wrap{max-width:1040px;margin:40px auto;padding:0 18px}
  h1{margin:0 0 8px;font-size:2.1rem;font-weight:800;text-align:center;letter-spacing:-.01em}
  .sub{margin:0;color:var(--muted);text-align:center}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .pad{padding:26px}
  .pill{display:inline-block;background:var(--accent);color:#fff;border-radius:999px;padding:8px 12px;font-size:.78rem;font-weight:700}

  label{display:block;margin:14px 0 6px;font-weight:700}
  input,select{width:100%;padding:14px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:1rem}
  input:focus,select:focus{outline:none;border-color:#c7d2fe;box-shadow:0 0 0 3px #e0e7ff}
  .row{display:grid;gap:16px}
  .row.two{grid-template-columns:1fr}
  @media(min-width:860px){ .row.two{grid-template-columns:1fr 1fr} }
  .field{width:100%;max-width:520px;margin-inline:auto}
  .controls{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:18px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:14px 20px;border:0;border-radius:12px;background:var(--accent);color:#fff;font-weight:800;cursor:pointer;font-size:1rem}
  .btn.secondary{background:#fff;color:#111;border:1px solid var(--border)}
  .btn.print{background:#111827}

  /* Tabs */
  .tabs{margin-top:16px}
  .tab-bar{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;padding:12px}
  .tab-btn{border:1px solid var(--border);background:#fff;border-radius:999px;padding:10px 16px;cursor:pointer;font-weight:700;color:#111}
  .tab-btn.active{background:#111827;color:#fff;border-color:#111827}
  .tab{display:none}
  .tab.active{display:block}

  .hidden{display:none}
  .kpis{display:grid;gap:16px;margin-top:10px}
  @media(min-width:900px){.kpis{grid-template-columns:repeat(3,1fr)}}
  .kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:18px;text-align:center}
  .kpi h3{margin:0 0 6px;font-size:.8rem;color:var(--muted);font-weight:700;letter-spacing:.02em;text-transform:uppercase}
  .kpi .big{font-size:1.55rem;font-weight:900}
  .hr{height:1px;background:var(--border);margin:20px 0}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:1rem}
  th,td{border:1px solid var(--border);padding:14px 10px}
  th{background:#f3f4f6;color:#475569;font-weight:800}
  td:first-child{font-weight:600}

  /* Testo esplicativo */
  .explanation{max-width:880px;margin:0 auto;text-align:left;line-height:1.95}
  .explanation h3{margin:20px 0 10px;font-size:1.15rem}
  .line{margin:0 0 12px}
  .mono{font-family:ui-monospace,Consolas,Menlo,Monaco,monospace}
  .hl{padding:0 .35em;border-radius:.5em}
  .y{background:var(--hl-y)} .g{background:var(--hl-g)} .b{background:var(--hl-b)} .p{background:var(--hl-p)}
  .muted{color:var(--muted)}

  .error{margin-top:12px;padding:12px;border-left:4px solid #ef4444;background:#fdecec;border-radius:10px;color:#7f1d1d}

  /* PRINT */
  @media print{
    header,#inputCard,.tab-bar,.controls,#toggleRate{display:none !important}
    body{background:#fff}
    .wrap{margin:0;padding:0}
    .card{box-shadow:none;border:1px solid #ccc;border-radius:0}
    .kpi, table{page-break-inside:avoid}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Simulatore Forfettario • Gestione Separata 2025</h1>
    <p class="sub">Imponibile, INPS 26,07%, imposta 5%/15%, saldi, acconti (con compensazione crediti) e rate con interessi.</p>
  </header>

  <!-- INPUT -->
  <section id="inputCard" class="card">
    <div class="pad">
      <div style="text-align:center;margin-bottom:8px"><span class="pill">Aliquota INPS GS 2025: 26,07%</span></div>
      <div id="err" class="error hidden"></div>

      <div class="row two" style="margin-top:12px">
        <div class="field">
          <label for="incassato">Incassato annuo (€ – cassa)</label>
          <input id="incassato" type="text" inputmode="decimal" placeholder="es. 30.000 o 30000,00" />
        </div>
        <div class="field">
          <label for="coeff">Coefficiente di redditività</label>
          <select id="coeff">
            <option value="0.78" selected>78% (più usato)</option>
            <option value="0.86">86%</option>
            <option value="0.67">67%</option>
          </select>
        </div>
      </div>

      <div class="row two">
        <div class="field">
          <label for="imposta">Imposta sostitutiva</label>
          <select id="imposta">
            <option value="0.05" selected>5% (startup)</option>
            <option value="0.15">15% (ordinaria)</option>
          </select>
        </div>
      </div>

      <details>
        <summary>Mostra opzioni avanzate</summary>
        <div class="inner" style="padding:10px 16px 8px">
          <div class="row two">
            <div class="field">
              <label for="deducibili">Contributi previdenziali <u>già versati</u> nell’anno (€)</label>
              <input id="deducibili" type="text" inputmode="decimal" value="0" />
              <div class="muted" style="text-align:left;margin-top:6px">
                <span class="hl b"><b>Nota:</b> si deducono <i>solo</i> dalla base dell’IMPOSTA (non riducono l’INPS).</span>
              </div>
            </div>
            <div class="field"></div>
          </div>
          <div class="row two">
            <div class="field">
              <label for="accImpPrev">Acconti IMPOSTA versati l’anno prima (€)</label>
              <input id="accImpPrev" type="text" inputmode="decimal" value="0" />
            </div>
            <div class="field">
              <label for="accInpsPrev">Acconti INPS GS versati l’anno prima (€)</label>
              <input id="accInpsPrev" type="text" inputmode="decimal" value="0" />
            </div>
          </div>
        </div>
      </details>

      <div class="controls">
        <button id="btnCalc" class="btn" type="button">CALCOLA</button>
        <button id="btnPrint" class="btn print" type="button">Stampa PDF</button>
        <button id="btnReset" class="btn secondary" type="button">Reset</button>
      </div>
    </div>
  </section>

  <!-- TABS + CONTENUTI -->
  <section id="resultsBox" class="card hidden" style="margin-top:16px">
    <div class="tabs">
      <div class="tab-bar">
        <button class="tab-btn active" data-tab="tab1">Come si calcolano</button>
        <button class="tab-btn" data-tab="tab2">Risultati Tasse da pagare</button>
        <button class="tab-btn" data-tab="tab3">Scadenza tasse da pagare</button>
      </div>

      <!-- TAB 1 - Spiegazione -->
      <div id="tab1" class="tab active">
        <div class="pad">
          <div id="explanation" class="explanation"></div>
        </div>
      </div>

      <!-- TAB 2 - KPI + dettaglio -->
      <div id="tab2" class="tab">
        <div class="pad">
          <div class="kpis">
            <div class="kpi">
              <h3>Reddito imponibile forfettario</h3>
              <div class="big" id="outImponibile">€ 0,00</div>
              <div class="muted" style="font-size:.85rem">Incassato × coefficiente</div>
            </div>
            <div class="kpi">
              <h3>Contributi INPS (26,07%)</h3>
              <div class="big" id="outInps">€ 0,00</div>
              <div class="muted" style="font-size:.85rem">Base: imponibile forfettario</div>
            </div>
            <div class="kpi">
              <h3>Imposta sostitutiva</h3>
              <div class="big" id="outImposta">€ 0,00</div>
              <div class="muted" style="font-size:.85rem">Su (imponibile − contributi deducibili)</div>
            </div>
          </div>

          <div class="kpis" style="margin-top:8px">
            <div class="kpi">
              <h3>Saldo da pagare ora</h3>
              <div class="big" id="outSaldo">€ 0,00</div>
              <div class="muted" style="font-size:.85rem">= saldo imposta + saldo INPS (al netto acconti)</div>
            </div>
            <div class="kpi">
              <h3>Acconti (netti dei crediti)</h3>
              <div class="big" id="outAcconti">€ 0,00</div>
              <div class="muted" style="font-size:.85rem">Imposta 100% • INPS 80%</div>
            </div>
            <div class="kpi">
              <h3>Totale da versare</h3>
              <div class="big" id="outTotale">€ 0,00</div>
              <div class="muted" style="font-size:.85rem">Saldo + acconti</div>
            </div>
          </div>

          <div class="hr"></div>
          <div id="warnings" style="text-align:center"></div>
          <h3 style="margin:8px 0">Dettaglio calcolo</h3>
          <table>
            <tbody id="tblDettaglio"></tbody>
          </table>
        </div>
      </div>

      <!-- TAB 3 - Scadenze e rate -->
      <div id="tab3" class="tab">
        <div class="pad">
          <h3 style="margin:0 0 8px">Scadenze sintetiche</h3>
          <table>
            <tbody id="tblScadenze"></tbody>
          </table>

          <div style="margin:14px 0">
            <label><input type="checkbox" id="toggleRate" checked> Rateizza giugno in 5 rate (con interessi e date ufficiali) + mostra novembre</label>
          </div>

          <table id="tblRate">
            <thead>
              <tr>
                <th>#</th><th>Scadenza</th><th>Quota capitale</th><th>Interessi %</th><th>Interessi €</th><th>Rata da pagare</th>
              </tr>
            </thead>
            <tbody id="rateBody"></tbody>
            <tfoot>
              <tr><th colspan="4" style="text-align:right">Totale interessi giugno</th><th id="rateIntTot">€ 0,00</th><th id="rateTot">€ 0,00</th></tr>
              <tr><th colspan="5" style="text-align:right">Totale complessivo (giugno + novembre)</th><th id="rateTotAll">€ 0,00</th></tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
(function(){
  // ---------- Utils ----------
  function euro(n){
    try{ return new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(n||0); }
    catch(e){ n=Math.round((n||0)*100)/100; return "€ "+(n||0).toFixed(2).replace(".",","); }
  }
  function parseNum(str){
    if(str==null) return 0;
    var s=String(str).trim().replace(/\s+/g,'');
    if(s.indexOf('.')>-1 && s.indexOf(',')>-1){ s=s.replace(/\./g,'').replace(',', '.'); }
    else { s=s.replace(',', '.'); }
    var n=parseFloat(s); return isNaN(n)?0:n;
  }
  function val(id){ return parseNum(document.getElementById(id).value); }
  function setHTML(id, html){ var el=document.getElementById(id); if(el) el.innerHTML=html; }
  function show(id){ var el=document.getElementById(id); if(el) el.classList.remove('hidden'); }
  function hide(id){ var el=document.getElementById(id); if(el) el.classList.add('hidden'); }
  function tr(a,b){ return '<tr><td>'+a+'</td><td style="text-align:center">'+b+'</td></tr>'; }
  function perc(n, base){ return base>0 ? (n/base*100).toFixed(2)+'%' : '0.00%'; }

  // Costanti 2025
  var ALIQUOTA_INPS = 0.2607;   // GS professionisti
  var ACCONTO_INPS_PERC = 0.80; // 80% (2x40%)
  // Imposta: acconti 100% (2x50%)

  // Rate (come da tue immagini)
  var RATE_PERC = [0.00, 0.18, 0.51, 0.84, 1.17]; // %
  var RATE_DATE = ["30 giugno","16 luglio","20 agosto","16 settembre","16 ottobre"];

  // Cache scadenze
  var cacheGiugno=0, cacheNov=0;

  // Tabs
  document.addEventListener('click', function(e){
    var btn = e.target.closest('.tab-btn'); if(!btn) return;
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });

  function compute(){
    // Input
    var incassato  = val('incassato');
    var coeff      = parseFloat(document.getElementById('coeff').value) || 0.78;
    var impRate    = parseFloat(document.getElementById('imposta').value) || 0.05;
    var deducibili = val('deducibili');
    var accImpPrev = val('accImpPrev');
    var accInpsPrev= val('accInpsPrev');

    if(incassato<=0){
      setHTML('err','Inserisci un incassato annuo valido (> 0).');
      document.getElementById('err').classList.remove('hidden');
      document.getElementById('resultsBox').classList.add('hidden');
      return;
    }
    document.getElementById('err').classList.add('hidden');

    // Base
    var imponibileForf = incassato * coeff;
    var inps           = imponibileForf * ALIQUOTA_INPS;

    // Imposta (deduzione solo qui)
    var imponibileFisc = imponibileForf - Math.max(0, deducibili);
    if(imponibileFisc < 0) imponibileFisc = 0;
    var imposta        = imponibileFisc * impRate;

    // Saldi (al netto acconti anno prima)
    var saldoImposta   = imposta - Math.max(0, accImpPrev); if(saldoImposta<0) saldoImposta=0;
    var saldoInps      = inps    - Math.max(0, accInpsPrev); if(saldoInps<0) saldoInps=0;
    var saldoTotale    = saldoImposta + saldoInps;

    // Crediti se acconti > dovuto
    var creditoImp  = Math.max(0, accImpPrev  - imposta);
    var creditoInps = Math.max(0, accInpsPrev - inps);

    // Acconti base (storico)
    var accImpBase  = imposta;                 // 100%
    var accInpsBase = inps * ACCONTO_INPS_PERC;// 80%

    // Nuovi acconti NETTI dei crediti
    var accImpTot   = Math.max(0, accImpBase  - creditoImp);
    var accInpsTot  = Math.max(0, accInpsBase - creditoInps);

    // Credito residuo se il credito supera l'intero acconto
    var creditoImpResid  = Math.max(0, creditoImp  - accImpBase);
    var creditoInpsResid = Math.max(0, creditoInps - accInpsBase);

    var accImp1  = accImpTot * 0.50,  accImp2  = accImpTot * 0.50;
    var accInps1 = accInpsTot * 0.50, accInps2 = accInpsTot * 0.50;

    var accontiTot = accImpTot + accInpsTot;

    var giugnoTot  = saldoTotale + accImp1 + accInps1;
    var novTot     = accImp2 + accInps2;
    var totale     = saldoTotale + accontiTot;

    // ---------- KPI (Tab 2) ----------
    setHTML('outImponibile', euro(imponibileForf));
    setHTML('outInps',       euro(inps));
    setHTML('outImposta',    euro(imposta));
    setHTML('outSaldo',      euro(saldoTotale));
    setHTML('outAcconti',    euro(accontiTot));
    setHTML('outTotale',     euro(totale));

    // Avvisi soglie
    var w='';
    if(incassato>100000) w='<div class="muted"><b>Attenzione:</b> oltre 100.000€ → uscita <b>immediata</b> dal forfettario nell’anno.</div>';
    else if(incassato>85000) w='<div class="muted"><b>Nota:</b> oltre 85.000€ → uscita dal forfettario <b>dall’anno successivo</b>.</div>';
    setHTML('warnings', w);

    // Tabella dettaglio (Tab 2)
    var det='';
    det+=tr('<b>Incassato annuo</b>', euro(incassato));
    det+=tr('Coefficiente di redditività', Math.round(coeff*100)+'%');
    det+=tr('<b>Imponibile forfettario</b>', euro(imponibileForf));
    det+=tr('Contributi già versati (deducibili per imposta)', '− '+euro(deducibili));
    det+=tr('Base per imposta', euro(imponibileFisc));
    det+=tr('Aliquota imposta scelta', Math.round(impRate*100)+'%');
    det+=tr('<b>Imposta calcolata</b>', euro(imposta));
    det+=tr('Acconti imposta (anno precedente)', '− '+euro(accImpPrev));
    det+=tr('<b>Saldo imposta</b>', '<b>'+euro(saldoImposta)+'</b>');
    det+=tr('Contributi INPS dovuti (26,07%)', euro(inps));
    det+=tr('Acconti INPS (anno precedente)', '− '+euro(accInpsPrev));
    det+=tr('<b>Saldo INPS</b>', '<b>'+euro(saldoInps)+'</b>');
    det+=tr('<b>Saldo totale ora</b>', '<b>'+euro(saldoTotale)+'</b>');
    if(creditoImp>0 || creditoInps>0){
      det+='<tr><th colspan="2">Crediti che riducono i nuovi acconti</th></tr>';
      if(creditoImp>0)  det+=tr('Credito imposta utilizzato', '− '+euro(creditoImp));
      if(creditoInps>0) det+=tr('Credito INPS utilizzato',    '− '+euro(creditoInps));
    }
    det+='<tr><th colspan="2">Acconti per l’anno prossimo (netti dei crediti)</th></tr>';
    det+=tr('Imposta – Totale acconti', euro(accImpTot));
    det+=tr('INPS – Totale acconti',    euro(accInpsTot));
    det+=tr('Imposta – 1° acconto (50%)', euro(accImp1));
    det+=tr('Imposta – 2° acconto (50%)', euro(accImp2));
    det+=tr('INPS – 1° acconto (40%)',    euro(accInps1));
    det+=tr('INPS – 2° acconto (40%)',    euro(accInps2));
    if(creditoImpResid>0 || creditoInpsResid>0){
      det+='<tr><th colspan="2">Credito residuo da riportare</th></tr>';
      if(creditoImpResid>0)  det+=tr('Credito imposta residuo', euro(creditoImpResid));
      if(creditoInpsResid>0) det+=tr('Credito INPS residuo',    euro(creditoInpsResid));
    }
    setHTML('tblDettaglio', det);

    // ---------- Tab 3: scadenze ----------
    cacheGiugno=giugnoTot; cacheNov=novTot;
    var sc='';
    sc+=tr('Giugno — Saldo (imp.+INPS) + 1° acconti', euro(giugnoTot));
    sc+=tr('Novembre — 2° acconti',                   euro(novTot));
    setHTML('tblScadenze', sc);

    // Rate
    if(document.getElementById('toggleRate').checked){ buildRate(); }

    // ---------- Tab 1: spiegazione narrativa ----------
    function L(p){ return '<p class="line">'+p+'</p>'; }
    var S='';
    // Base & imponibile
    S+= L('Nel <b>regime forfettario</b> paghi l’<b>imposta sostitutiva</b> al <span class="hl y"><b>'+Math.round(impRate*100)+'%</b></span> e i <b>contributi INPS – Gestione Separata</b> al <span class="hl y"><b>26,07%</b></span>.');
    S+= L('La base di tutto è l’<b>imponibile forfettario</b>: <span class="mono">Imponibile = Incassato × Coefficiente</span>. Con i tuoi dati: <span class="hl g"><b>'+euro(incassato)+'</b> × <b>'+Math.round(coeff*100)+'%</b> = <b>'+euro(imponibileForf)+'</b></span>.');
    // Contributi
    S+= '<h3>Contributi INPS (come si calcolano)</h3>';
    S+= L('Si applica il <b>26,07%</b> all’imponibile: <span class="mono">Contributi INPS = Imponibile × 26,07%</span> → <span class="hl y"><b>'+euro(inps)+'</b></span>. I contributi già pagati nell’anno <b>non</b> riducono questa cifra.');
    // Imposta
    S+= '<h3>Imposta sostitutiva (con deduzioni)</h3>';
    if(deducibili>0){
      if(deducibili>=imponibileForf){
        S+= L('Con <span class="hl b"><b>'+euro(deducibili)+'</b></span> di contributi deducibili la <b>base per l’imposta si azzera</b>. Con aliquota <b>'+Math.round(impRate*100)+'%</b> l’imposta è <span class="hl y"><b>'+euro(imposta)+'</b></span>.');
      }else{
        S+= L('Deduzione: <span class="hl b"><b>'+euro(deducibili)+'</b></span>. <span class="mono">Base imposta = Imponibile − Contributi deducibili</span> → <span class="hl b"><b>'+euro(imponibileFisc)+'</b></span>. Con aliquota <b>'+Math.round(impRate*100)+'%</b> l’imposta è <span class="hl y"><b>'+euro(imposta)+'</b></span>.');
      }
    }else{
      S+= L('Nessuna deduzione: l’imposta si calcola su <b>'+euro(imponibileForf)+'</b> con aliquota <b>'+Math.round(impRate*100)+'%</b> → <span class="hl y"><b>'+euro(imposta)+'</b></span>.');
    }
    // Perché saldi = 0 se c'è credito
    S+= '<h3>Perché i saldi possono essere 0 €</h3>';
    if(accInpsPrev >= inps){
      S+= L('<b>INPS</b>: dovuto <b>'+euro(inps)+'</b> − acconti già versati <b>'+euro(accInpsPrev)+'</b> = <b>0 €</b>. Nasce un <b>credito INPS</b> di <span class="hl g"><b>'+euro(accInpsPrev - inps)+'</b></span> che riduce i nuovi acconti.');
    }else{
      S+= L('<b>INPS</b>: dovuto <b>'+euro(inps)+'</b> − acconti già versati <b>'+euro(accInpsPrev)+'</b> = saldo <span class="hl y"><b>'+euro(saldoInps)+'</b></span>.');
    }
    if(accImpPrev >= imposta){
      S+= L('<b>Imposta</b>: dovuta <b>'+euro(imposta)+'</b> − acconti già versati <b>'+euro(accImpPrev)+'</b> = <b>0 €</b>. Nasce un <b>credito imposta</b> di <span class="hl g"><b>'+euro(accImpPrev - imposta)+'</b></span> che riduce i nuovi acconti.');
    }else{
      S+= L('<b>Imposta</b>: dovuta <b>'+euro(imposta)+'</b> − acconti già versati <b>'+euro(accImpPrev)+'</b> = saldo <span class="hl y"><b>'+euro(saldoImposta)+'</b></span>.');
    }
    S+= L('Totale saldi da versare ora: <span class="hl g"><b>'+euro(saldoTotale)+'</b></span>.');
    // Crediti e acconti
    S+= '<h3>Crediti che riducono i nuovi acconti</h3>';
    var listCred=[];
    if(creditoImp>0)  listCred.push('imposta <b>'+euro(creditoImp)+'</b>');
    if(creditoInps>0) listCred.push('INPS <b>'+euro(creditoInps)+'</b>');
    if(listCred.length) S+= L('I crediti riducono gli acconti: '+listCred.join(' • ')+'.');
    else S+= L('Nessun credito: gli acconti si calcolano normalmente.');
    S+= L('Acconti imposta (100%): <b>'+euro(accImpTot)+'</b> → giugno <b>'+euro(accImp1)+'</b>, novembre <b>'+euro(accImp2)+'</b>.');
    S+= L('Acconti INPS (80%): <b>'+euro(accInpsTot)+'</b> → giugno <b>'+euro(accInps1)+'</b>, novembre <b>'+euro(accInps2)+'</b>.');
    if(creditoImpResid>0 || creditoInpsResid>0){
      S+= L('Resta un <b>credito residuo</b> da riportare: '+(creditoImpResid? 'imposta <b>'+euro(creditoImpResid)+'</b>':'')+(creditoImpResid&&creditoInpsResid?' • ':'')+(creditoInpsResid? 'INPS <b>'+euro(creditoInpsResid)+'</b>':'')+'.');
    }
    // Scadenze
    S+= '<h3>Quando paghi</h3>';
    S+= L('<b>Giugno</b> = saldi (imposta + INPS) + primi acconti → <span class="hl y"><b>'+euro(giugnoTot)+'</b></span>. Puoi dividerlo in <b>5 rate</b> (giu→ott) con interessi per rata: <b>0,00% • 0,18% • 0,51% • 0,84% • 1,17%</b>.');
    S+= L('<b>Novembre</b> = secondi acconti → <span class="hl y"><b>'+euro(novTot)+'</b></span>.');
    // Totale
    S+= '<h3>Totale anno e incidenza</h3>';
    S+= L('Totale complessivo (<i>saldi + acconti</i>): <span class="hl g"><b>'+euro(totale)+'</b></span>. Incide sul tuo incassato per <b>'+perc(totale,incassato)+'</b> (saldi: '+perc(saldoTotale,incassato)+' • acconti: '+perc(accontiTot,incassato)+').');
    if(incassato>100000) S+= L('<span class="muted"><b>Attenzione:</b> incassi oltre 100.000€ → uscita <b>immediata</b> dal forfettario nell’anno.</span>');
    else if(incassato>85000) S+= L('<span class="muted"><b>Nota:</b> incassi oltre 85.000€ → uscita dal forfettario <b>dall’anno successivo</b>.</span>');

    setHTML('explanation', S);
    document.getElementById('resultsBox').classList.remove('hidden');
  }

  function buildRate(){
    var totGiu = cacheGiugno;
    var quota = totGiu/5;
    var tbody='', sumInt=0, sumTotGiu=0;

    // 5 rate giugno con interessi
    for(var i=0;i<5;i++){
      var p = RATE_PERC[i]/100;
      var interesse = totGiu * p;   // percentuale per rata sul TOTALE di giugno (come richiesto)
      var rata = quota + interesse;
      sumInt += interesse; sumTotGiu += rata;
      tbody += '<tr>'+
        '<td>'+(i+1)+'</td>'+
        '<td>'+RATE_DATE[i]+'</td>'+
        '<td>'+euro(quota)+'</td>'+
        '<td>'+RATE_PERC[i].toFixed(2)+'%</td>'+
        '<td>'+euro(interesse)+'</td>'+
        '<td><b>'+euro(rata)+'</b></td>'+
      '</tr>';
    }

    // Riga aggiuntiva: Novembre (2° acconti) come rata unica senza interessi
    tbody += '<tr>'+
      '<td>6</td>'+
      '<td><b>Novembre — 2° acconti</b></td>'+
      '<td>'+euro(cacheNov)+'</td>'+
      '<td>—</td>'+
      '<td>—</td>'+
      '<td><b>'+euro(cacheNov)+'</b></td>'+
    '</tr>';

    setHTML('rateBody', tbody);
    setHTML('rateIntTot', euro(sumInt));                 // solo interessi giugno
    setHTML('rateTot', euro(sumTotGiu));                 // totale 5 rate giugno
    setHTML('rateTotAll', euro(sumTotGiu + cacheNov));   // totale giugno + novembre
  }

  // Eventi
  document.addEventListener('DOMContentLoaded', function(){
    document.getElementById('btnCalc').addEventListener('click', compute);
    ['incassato','deducibili','accImpPrev','accInpsPrev'].forEach(function(id){
      var el=document.getElementById(id); if(!el) return;
      el.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); compute(); } });
    });
    document.getElementById('toggleRate').addEventListener('change', function(e){
      if(e.target.checked){ buildRate(); } else { /* lascio la tabella visibile come da richiesta */ }
    });
    document.getElementById('btnPrint').addEventListener('click', function(){ window.print(); });
    document.getElementById('btnReset').addEventListener('click', function(){
      ['incassato','deducibili','accImpPrev','accInpsPrev'].forEach(function(id){ var el=document.getElementById(id); if(el) el.value=''; });
      document.getElementById('coeff').value='0.78';
      document.getElementById('imposta').value='0.05';
      document.getElementById('toggleRate').checked=true;
      document.getElementById('resultsBox').classList.add('hidden');
      var err=document.getElementById('err'); err.classList.add('hidden'); err.textContent='';
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });
})();
</script>
</body>
</html>
