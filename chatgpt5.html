<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulatore Forfettario • Gestione Separata 2025</title>
<style>
  :root{
    --bg:#f7f9fc; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb;
    --accent:#2563eb; --accent-2:#16a34a; --warn:#f59e0b; --danger:#ef4444;
    --radius:14px; --shadow:0 10px 24px rgba(15,23,42,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:920px;margin:34px auto;padding:0 16px}
  h1{margin:0 0 6px 0;font-size:32px;font-weight:800}
  .sub{margin:0;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .pad{padding:18px}
  label{display:block;margin:14px 0 6px;font-weight:600}
  input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:16px}
  input:focus,select:focus{outline:none;border-color:#c7d2fe;box-shadow:0 0 0 3px #e0e7ff}
  .btn{display:inline-flex;align-items:center;gap:8px;margin-top:18px;padding:12px 18px;border:0;border-radius:12px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
  .btn.secondary{background:#fff;color:var(--text);border:1px solid var(--border)}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:820px){ .row.two{grid-template-columns:1fr 1fr} }
  details{margin-top:12px;border:1px solid var(--border);border-radius:12px;background:#fbfcff}
  summary{cursor:pointer;padding:12px 14px;font-weight:700}
  details .inner{padding:0 14px 14px}
  .pill{display:inline-flex;align-items:center;gap:6px;background:var(--accent);color:#fff;border-radius:999px;padding:6px 10px;font-size:12px}

  .hidden{display:none}
  .kpis{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:820px){ .kpis{grid-template-columns:repeat(3,1fr)} }
  .kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px}
  .kpi h3{margin:0 0 6px 0;font-size:13px;color:var(--muted)}
  .kpi .big{font-size:22px;font-weight:800}
  .hr{height:1px;background:var(--border);margin:14px 0}
  .warnbox{margin-top:10px;padding:12px;border-left:4px solid var(--warn);background:#fff7ed;border-radius:10px}
  .dangerbox{margin-top:10px;padding:12px;border-left:4px solid var(--danger);background:#fef2f2;border-radius:10px}

  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--border);padding:10px;text-align:center}
  th{background:#f3f4f6;color:var(--muted)}

  .muted{color:var(--muted)}
  .explanation{line-height:1.75}
  .error{margin-top:10px;padding:10px;border-left:4px solid var(--danger);background:#fdecec;border-radius:10px;color:#7f1d1d}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Simulatore Forfettario • Gestione Separata 2025</h1>
      <p class="sub">Calcolo semplice stile Fiscozen: imponibile, INPS (26,07%), imposta 5%/15%, saldi e acconti (storico).</p>
    </header>

    <!-- INPUT -->
    <section class="card">
      <div class="pad">
        <div class="pill">Aliquota INPS GS 2025: 26,07%</div>

        <div id="err" class="error hidden"></div>

        <div class="row two">
          <div>
            <label for="incassato">Incassato annuo (€ – principio di cassa)</label>
            <input id="incassato" type="text" inputmode="decimal" placeholder="es. 30.000 o 30000,00" autocomplete="off" />
          </div>
          <div>
            <label for="coeff">Coefficiente di redditività</label>
            <select id="coeff">
              <option value="0.78" selected>78% (più usato)</option>
              <option value="0.86">86%</option>
              <option value="0.67">67%</option>
            </select>
          </div>
        </div>

        <div class="row two">
          <div>
            <label for="imposta">Imposta sostitutiva</label>
            <select id="imposta">
              <option value="0.05" selected>5% (startup)</option>
              <option value="0.15">15% (ordinaria)</option>
            </select>
          </div>
        </div>

        <details>
          <summary>Mostra opzioni avanzate</summary>
          <div class="inner">
            <div class="row two">
              <div>
                <label for="deducibili">Contributi previdenziali <u>già versati</u> nell’anno (€)</label>
                <input id="deducibili" type="text" inputmode="decimal" value="0" />
                <div class="muted" style="font-size:12px;margin-top:6px">
                  I contributi deducibili <b>riducano solo la base dell’imposta</b> (non i contributi INPS).
                </div>
              </div>
              <div></div>
            </div>
            <div class="row two">
              <div>
                <label for="accImpPrev">Acconti IMPOSTA versati l’anno prima (€)</label>
                <input id="accImpPrev" type="text" inputmode="decimal" value="0" />
              </div>
              <div>
                <label for="accInpsPrev">Acconti INPS GS versati l’anno prima (€)</label>
                <input id="accInpsPrev" type="text" inputmode="decimal" value="0" />
              </div>
            </div>
          </div>
        </details>

        <div class="row" style="margin-top:6px">
          <div>
            <button id="btnCalc" class="btn" type="button">CALCOLA</button>
            <button id="btnReset" class="btn secondary" type="button">Reset</button>
          </div>
        </div>
      </div>
    </section>

    <!-- RISULTATI -->
    <section id="resultsBox" class="hidden" style="margin-top:16px">
      <div class="card">
        <div class="pad">
          <h2 style="margin:0 0 6px 0">Risultati</h2>

          <div class="kpis">
            <div class="kpi">
              <h3>Reddito imponibile forfettario</h3>
              <div class="big" id="outImponibile">€ 0,00</div>
              <div class="muted" style="font-size:12px">Incassato × coefficiente</div>
            </div>
            <div class="kpi">
              <h3>Contributi INPS GS (26,07%)</h3>
              <div class="big" id="outInps">€ 0,00</div>
              <div class="muted" style="font-size:12px">Base: imponibile forfettario</div>
            </div>
            <div class="kpi">
              <h3>Imposta sostitutiva</h3>
              <div class="big" id="outImposta">€ 0,00</div>
              <div class="muted" style="font-size:12px">Su (imponibile − contributi deducibili)</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="kpis">
            <div class="kpi">
              <h3>Saldo da pagare ora</h3>
              <div class="big" id="outSaldo">€ 0,00</div>
              <div class="muted" style="font-size:12px">= saldo imposta + saldo INPS (al netto acconti)</div>
            </div>
            <div class="kpi">
              <h3>Acconti per l’anno prossimo</h3>
              <div class="big" id="outAcconti">€ 0,00</div>
              <div class="muted" style="font-size:12px">Imposta 100% (2×50%) • INPS 80% (2×40%)</div>
            </div>
            <div class="kpi">
              <h3>Totale da versare</h3>
              <div class="big" id="outTotale">€ 0,00</div>
              <div class="muted" style="font-size:12px">Saldo + acconti</div>
            </div>
          </div>

          <div id="warnings"></div>

          <div class="hr"></div>

          <h3 style="margin:8px 0">Dettaglio calcolo & scadenze</h3>
          <table>
            <tbody id="tblDettaglio"></tbody>
          </table>

          <div style="margin:12px 0">
            <label><input type="checkbox" id="toggleRate"> Mostra rate di giugno in 5 rate</label>
          </div>

          <table id="tblRate" class="hidden" style="margin-top:10px">
            <thead><tr><th>Mese</th><th>Importo rata</th></tr></thead>
            <tbody id="rateBody"></tbody>
          </table>

          <div class="hr"></div>

          <h3 style="margin:8px 0">Spiegazione con i tuoi dati</h3>
          <div id="explanation" class="explanation muted"></div>
        </div>
      </div>
    </section>
  </div>

<script>
(function(){
  // ----- Utils robuste -----
  function formatEuro(n){
    try{ return new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(n||0); }
    catch(e){ n=Math.round((n||0)*100)/100; return "€ "+n.toFixed(2).replace(".",","); }
  }
  function parseNum(str){
    if(str==null) return 0;
    // supporta "30.000,50" o "30000.50" o "30000"
    var s = String(str).trim().replace(/\s+/g,'');
    // se contiene sia punto che virgola, assumiamo formato it-IT "12.345,67"
    if(s.indexOf('.')>-1 && s.indexOf(',')>-1){
      s = s.replace(/\./g,'').replace(',', '.');
    }else{
      // solo virgola -> decimale it
      s = s.replace(',', '.');
    }
    var n = parseFloat(s);
    return isNaN(n)?0:n;
  }
  function getVal(id){ return parseNum(document.getElementById(id).value); }
  function setTxt(id, html){ var el=document.getElementById(id); if(el) el.innerHTML = html; }
  function show(id){ var el=document.getElementById(id); if(el) el.classList.remove('hidden'); }
  function hide(id){ var el=document.getElementById(id); if(el) el.classList.add('hidden'); }

  // ----- Costanti 2025 -----
  var ALIQUOTA_INPS = 0.2607;    // Gestione Separata professionisti
  var ACCONTO_INPS_PERC = 0.80;  // 80% (2 rate 40/40)
  // Imposta: acconti 100% (2 rate 50/50)

  var cacheGiugno = 0;

  // ----- Calcolo principale -----
  function compute(){
    // Non svuotare gli input e non fare submit: non c'è nessun <form> qui
    hide('err'); setTxt('err','');

    var incassato  = getVal('incassato');
    var coeff      = parseFloat(document.getElementById('coeff').value) || 0.78;
    var impRate    = parseFloat(document.getElementById('imposta').value) || 0.05;
    var deducibili = getVal('deducibili');
    var accImpPrev = getVal('accImpPrev');
    var accInpsPrev= getVal('accInpsPrev');

    if(incassato<=0){ show('err'); setTxt('err','Inserisci un incassato annuo valido (> 0).'); hide('resultsBox'); return; }

    // Base forfettaria
    var imponibileForf = incassato * coeff;

    // Contributi INPS (sulla base forfettaria)
    var inps = imponibileForf * ALIQUOTA_INPS;

    // Contributi deducibili: riducono SOLO la base dell'imposta
    var imponibileFisc = Math.max(0, imponibileForf - Math.max(0, deducibili));
    var imposta = imponibileFisc * impRate;

    // Saldi (al netto degli acconti versati l'anno prima)
    var saldoImposta = Math.max(0, imposta - Math.max(0, accImpPrev));
    var saldoInps    = Math.max(0, inps    - Math.max(0, accInpsPrev));
    var saldoTotale  = saldoImposta + saldoInps;

    // Acconti anno prossimo (metodo storico)
    var accImpTot = imposta;              // 100% (50/50)
    var accImp1   = accImpTot * 0.50;
    var accImp2   = accImpTot * 0.50;

    var accInpsTot= inps * ACCONTO_INPS_PERC; // 80% (40/40)
    var accInps1  = accInpsTot * 0.50;        // 40%
    var accInps2  = accInpsTot * 0.50;        // 40%

    var accontiTot= accImpTot + accInpsTot;
    var totale    = saldoTotale + accontiTot;

    // KPI
    setTxt('outImponibile', formatEuro(imponibileForf));
    setTxt('outInps',       formatEuro(inps));
    setTxt('outImposta',    formatEuro(imposta));
    setTxt('outSaldo',      formatEuro(saldoTotale));
    setTxt('outAcconti',    formatEuro(accontiTot));
    setTxt('outTotale',     formatEuro(totale));

    // Warnings soglie
    var w = '';
    if(incassato>100000) w = '<div class="dangerbox">Incassato oltre <b>100.000€</b>: uscita <b>immediata</b> dal forfettario nell’anno.</div>';
    else if(incassato>85000) w = '<div class="warnbox">Superata la soglia <b>85.000€</b>: in via ordinaria si esce dal forfettario <b>dall’anno successivo</b>.</div>';
    setTxt('warnings', w);

    // Dettaglio & scadenze
    var det = '';
    det += tr('Incassato annuo', formatEuro(incassato));
    det += tr('Coefficiente di redditività', Math.round(coeff*100)+'%');
    det += tr('Imponibile forfettario', formatEuro(imponibileForf));
    det += tr('Contributi già versati (deducibili solo per imposta)', '− '+formatEuro(deducibili));
    det += tr('Imponibile fiscale per imposta', formatEuro(imponibileFisc));
    det += tr('Aliquota imposta scelta', Math.round(impRate*100)+'%');
    det += tr('Imposta calcolata', formatEuro(imposta));
    det += tr('Acconti imposta versati anno precedente', '− '+formatEuro(accImpPrev));
    det += tr('<b>Saldo imposta</b>', '<b>'+formatEuro(saldoImposta)+'</b>');
    det += tr('Contributi INPS dovuti (26,07%)', formatEuro(inps));
    det += tr('Acconti INPS versati anno precedente', '− '+formatEuro(accInpsPrev));
    det += tr('<b>Saldo INPS</b>', '<b>'+formatEuro(saldoInps)+'</b>');
    det += tr('<b>Saldo totale (imposta + INPS)</b>', '<b>'+formatEuro(saldoTotale)+'</b>');
    det += '<tr><th colspan="2">Acconti per l’anno prossimo (metodo storico)</th></tr>';
    det += tr('Imposta – 1° acconto (50%)', formatEuro(accImp1));
    det += tr('Imposta – 2° acconto (50%)', formatEuro(accImp2));
    det += tr('INPS – 1° acconto (40%)',    formatEuro(accInps1));
    det += tr('INPS – 2° acconto (40%)',    formatEuro(accInps2));
    det += tr('<b>Acconti totali</b>', '<b>'+formatEuro(accontiTot)+'</b>');
    det += '<tr><th colspan="2">Scadenze sintetiche</th></tr>';
    var giugnoTot = saldoTotale + accImp1 + accInps1;
    var novTot    = accImp2 + accInps2;
    det += tr('Giugno — Saldo (imp.+INPS) + 1° acconti', formatEuro(giugnoTot));
    det += tr('Novembre — 2° acconti',                   formatEuro(novTot));
    setTxt('tblDettaglio', det);

    // Rate giugno (toggle)
    cacheGiugno = giugnoTot;
    var chk = document.getElementById('toggleRate');
    if(chk.checked){ buildRate(); } else { hide('tblRate'); }

    // Spiegazione chiara (con i TUOI dati)
    var s = '';
    s += 'Hai indicato di aver incassato '+formatEuro(incassato)+'. ';
    s += 'Con il coefficiente del '+Math.round(coeff*100)+'% consideriamo solo una parte come reddito su cui si fanno i conti: è il tuo imponibile forfettario ('+formatEuro(imponibileForf)+'). ';
    s += 'Su questo imponibile calcoliamo i contributi INPS della Gestione Separata al 26,07%, che risultano pari a '+formatEuro(inps)+'. ';
    s += 'Per l’imposta sostitutiva hai scelto il '+Math.round(impRate*100)+'%. Prima di applicarla togliamo i contributi che hai già pagato nel corso dell’anno ('+formatEuro(deducibili)+'): ';
    s += 'questa deduzione vale <b>solo</b> per il calcolo dell’imposta. Otteniamo così una base fiscale di '+formatEuro(imponibileFisc)+' su cui calcolare l’imposta, che è '+formatEuro(imposta)+'. ';
    s += 'Poiché l’anno precedente hai già versato '+formatEuro(accImpPrev)+' di acconti imposta e '+formatEuro(accInpsPrev)+' di acconti INPS, li scaliamo adesso: ';
    s += 'in questo modo il tuo <b>saldo attuale</b> (imposta + INPS) è '+formatEuro(saldoTotale)+'. ';
    s += 'Per l’anno successivo, con il metodo storico, versi anche gli <b>acconti</b>: 100% dell’imposta (metà a giugno e metà a novembre) e 80% dei contributi INPS (metà a giugno e metà a novembre), per un totale di '+formatEuro(accontiTot)+'. ';
    s += 'La somma tra saldo e acconti è il <b>totale di quest’anno</b>: '+formatEuro(totale)+'. ';
    s += 'Se ti aiuta nella gestione del flusso di cassa, l’importo di giugno ('+formatEuro(giugnoTot)+') può essere suddiviso in 5 rate uguali da giugno a ottobre.';
    setTxt('explanation', s);

    show('resultsBox');
  }

  function tr(a,b){ return '<tr><td style="text-align:left">'+a+'</td><td>'+b+'</td></tr>'; }

  function buildRate(){
    var rata = cacheGiugno/5;
    var mesi=['Giugno','Luglio','Agosto','Settembre','Ottobre'];
    var html=''; for(var i=0;i<5;i++){ html+='<tr><td>'+mesi[i]+'</td><td>'+formatEuro(rata)+'</td></tr>'; }
    setTxt('rateBody', html); show('tblRate');
  }

  // ----- Event wiring -----
  document.addEventListener('DOMContentLoaded', function(){
    // Click calcola
    document.getElementById('btnCalc').addEventListener('click', compute);
    // Invio da tastiera su qualsiasi input
    ['incassato','deducibili','accImpPrev','accInpsPrev'].forEach(function(id){
      var el=document.getElementById(id); if(!el) return;
      el.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); compute(); } });
    });
    // Toggle rate
    document.getElementById('toggleRate').addEventListener('change', function(e){
      if(e.target.checked){ buildRate(); } else { hide('tblRate'); }
    });
    // Reset
    document.getElementById('btnReset').addEventListener('click', function(){
      ['incassato','deducibili','accImpPrev','accInpsPrev'].forEach(function(id){
        var el=document.getElementById(id); if(el) el.value='';
      });
      document.getElementById('coeff').value='0.78';
      document.getElementById('imposta').value='0.05';
      document.getElementById('toggleRate').checked=false;
      hide('tblRate'); hide('resultsBox'); hide('err'); setTxt('err','');
    });
  });
})();
</script>
</body>
</html>
