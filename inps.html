<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulatore Forfettario • INPS Commercianti / Artigiani 2025</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f7f9fc; --card:#fff; --text:#0f172a; --muted:#64748b; --border:#e6e6eb;
  --accent:#2563eb; --accent-dark:#1e40af; --ink:#3b82f6;
  --radius:14px; --shadow:0 14px 28px rgba(2,6,23,.08);
  --hl-y:#fff8c8; --dots:26px;
}
*{box-sizing:border-box}
html{font-size:17px}
body{
  margin:0;color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;
  background:
    radial-gradient(rgba(2,6,23,.08) 1px, transparent 1px) 0 0/ var(--dots) var(--dots),
    #f7f9fc;
}
.wrap{max-width:860px;margin:32px auto;padding:0 14px}

/* Header */
header{text-align:center;margin-bottom:16px}
h1{margin:0;font-size:2rem;font-weight:900;letter-spacing:-.01em;line-height:1.2}
.hl{padding:.05em .35em;border-radius:.45em;background:var(--hl-y);border:1px solid #f3e89a}

/* Cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
.pad{padding:20px}

/* Form */
.form-vertical{display:flex;flex-direction:column;row-gap:22px}
.field{width:100%}
label{display:block;margin:0 0 6px;font-weight:800}
input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:1rem}
input[type="date"]{padding:10px 12px}
input:disabled{background:#f8fafc;color:#334155}
input:focus,select:focus,.chip:focus-visible,.pill:focus-visible,.btn:focus-visible{outline:none;border-color:#c7d2fe;box-shadow:0 0 0 3px #e0e7ff}

/* Chips */
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.chip{height:40px;padding:0 14px;display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:9999px;background:#fff;cursor:pointer;font-weight:900;user-select:none}
.chip:hover{border-color:#bcd0ff}
.chip.active{background:#111827;color:#fff;border-color:#111827}
.coeff-wrap{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.coeff-input{width:86px}

/* Pulsanti */
.actions{display:flex;flex-direction:column;gap:10px;align-items:center;margin-top:8px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:0;border-radius:10px;font-weight:900;cursor:pointer;transition:transform .05s}
.btn:active{transform:translateY(1px)}
.btn.primary{background:var(--accent);color:#fff;height:46px;padding:0 18px;max-width:380px;width:100%}
.btn.primary:hover{background:var(--accent-dark)}
.sub-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.btn.dark{background:#111827;color:#fff;height:38px;padding:0 12px}
.btn.secondary{background:#fff;border:1px solid var(--border);height:38px;padding:0 12px}

/* Tabs & view */
.tabbar-wrap{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px}
.tab-bar{position:relative;display:flex;gap:8px;overflow:auto hidden}
.tab-btn{position:relative;border:1px solid var(--border);background:#fff;border-radius:9999px;padding:6px 12px;height:34px;cursor:pointer;font-weight:900;white-space:nowrap}
.tab-btn.active{background:#e8f0ff;border-color:#c7d2fe}
.inkbar{position:absolute;height:2px;background:var(--ink);border-radius:2px;bottom:-6px;left:0;width:0;transition:all .25s}
.tab{display:none}.tab.active{display:block}
.viewctrl{display:flex;align-items:center;gap:8px}
#viewLabel{font-weight:800;color:#475569}
.switch{position:relative;display:inline-block;width:44px;height:24px}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#e5e7eb;border-radius:999px;transition:.2s}
.slider:before{content:"";position:absolute;height:18px;width:18px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 2px rgba(0,0,0,.3)}
.switch input:checked + .slider{background:#60a5fa}
.switch input:checked + .slider:before{transform:translateX(20px)}

/* KPI & tabelle */
.kpis{display:grid;gap:12px;margin-top:8px}
@media(min-width:640px){.kpis{grid-template-columns:repeat(2,1fr)}}
@media(min-width:860px){.kpis{grid-template-columns:repeat(3,1fr)}}
.kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;box-shadow:0 6px 16px rgba(2,6,23,.04);display:flex;flex-direction:column;justify-content:center;min-height:120px}
.kpi h3{margin:0 0 6px;font-size:.78rem;color:#64748b;text-transform:uppercase;font-weight:800}
.kpi .big{font-size:1.35rem;font-weight:900;font-variant-numeric:tabular-nums}
table{width:100%;border-collapse:collapse;margin-top:6px;font-size:.98rem;background:#fff;border:1px solid var(--border);box-shadow:0 6px 16px rgba(2,6,23,.04);page-break-inside:avoid}
th,td{border:1px solid var(--border);padding:12px 8px}
th{background:#f7f7fb;color:#475569;font-weight:800}
tr:hover{background:#f8faff}
tfoot tr th{background:#f1f5f9;font-weight:800}
#tblScadenze td:nth-child(2),#tblFissi td:nth-child(2),#rateBody td:nth-child(3),#rateBody td:nth-child(5),#rateBody td:nth-child(6),#scadTot{text-align:right;font-variant-numeric:tabular-nums}
.badge-month{display:inline-block;padding:2px 8px;border-radius:9999px;background:#eef2ff;border:1px solid #c7d2fe;font-weight:800;font-size:.85em}

/* Spiegazioni */
.section{position:relative;border-left:4px solid #e5e7eb;padding:14px;margin:12px 0 8px;border-radius:10px;background:#fff;border:1px solid var(--border);box-shadow:0 6px 16px rgba(2,6,23,.04)}
.section.inps{border-left-color:#2563eb}
.section.imp{border-left-color:#16a34a}
.section h3{margin:0 0 6px;font-size:1.05rem;font-weight:800}
.copy-btn{position:absolute;right:-10px;top:-10px;padding:6px 10px;font-size:.75rem;font-weight:900;border:0;border-radius:999px;background:#111827;color:#fff;box-shadow:0 6px 14px rgba(2,6,23,.18);cursor:pointer;opacity:0;transition:opacity .15s,transform .15s;transform:translateY(2px)}
.section:hover .copy-btn{opacity:1;transform:none}
@media (max-width:900px){.copy-btn{display:none}}
.explanation{max-width:820px;margin:0 auto;text-align:left}
.explanation .line{line-height:30px;margin:0;font-weight:500}
.muted{color:var(--muted)}
.mono{font-variant-numeric:tabular-nums}
.error{margin-top:10px;padding:10px;border-left:4px solid #ef4444;background:#fdecec;border-radius:10px;color:#7f1d1d}

/* Rate */
details.rates>summary{list-style:none;cursor:pointer;display:flex;align-items:center;gap:8px;font-weight:900;color:#111827;padding:8px 0}
details.rates>summary::before{content:"";width:8px;height:8px;border:2px solid #111827;border-left:0;border-top:0;transform:rotate(45deg);transition:.2s}
details.rates[open]>summary::before{transform:rotate(-135deg)}

/* Print */
@media print{
  body{background:#fff}
  header,#inputCard,.tabbar-wrap .viewctrl,.copy-btn{display:none!important}
  .wrap{max-width:1000px;margin:0;padding:0}
  #resultsBox{margin-top:0!important;border:none;box-shadow:none}
  .tabbar-wrap{display:none!important}
  .print-head{display:block !important; border-bottom:1px solid #ddd; padding:6px 0; margin-bottom:8px}
  .print-title{display:block !important; font-size:1.15rem; font-weight:800; margin:6px 0}
  .tab{display:block !important; page-break-inside:avoid}
  table,tr,td,th{page-break-inside:avoid}
  @page{size:A4;margin:12mm}
}
.print-head,.print-title{display:none}
</style>
</head>
<body>
<div class="wrap">
  <!-- TITOLO -->
  <header>
    <h1>Simulatore Forfettario per<br><u><span class="hl">INPS Commercianti / Artigiani 2025</span></u></h1>
  </header>

  <!-- FORM -->
  <section class="card" id="inputCard" style="margin-top:14px">
    <div class="pad">
      <div class="form-vertical" style="max-width:720px;margin:0 auto">
        <div class="field">
          <label>Anno <span class="hl">2025</span></label>
          <input type="text" value="2025" disabled aria-disabled="true"/>
        </div>

        <div class="field">
          <label for="gestione">Gestione</label>
          <select id="gestione">
            <option value="artigiani">Artigiani (IVS)</option>
            <option value="commercianti">Commercianti (IVS)</option>
          </select>
        </div>

        <div class="field">
          <label for="incassato">Incassato annuo (€)</label>
          <input id="incassato" type="text" inputmode="numeric" placeholder="es. 50000">
          <div class="chips" id="incChips">
            <button class="chip" data-val-num="10000">10.000</button>
            <button class="chip" data-val-num="20000">20.000</button>
            <button class="chip" data-val-num="30000">30.000</button>
            <button class="chip" data-val-num="50000">50.000</button>
            <button class="chip" data-val-num="85000">85.000</button>
          </div>
        </div>

        <div class="field">
          <label>Coefficiente di redditività</label>
          <div class="coeff-wrap">
            <div class="chips" id="coeffChips">
              <button class="chip active" data-coeff="78">78%</button>
              <button class="chip" data-coeff="86">86%</button>
              <button class="chip" data-coeff="67">67%</button>
            </div>
            <input id="coeffCustom" class="coeff-input" maxlength="2" inputmode="numeric" placeholder="%">
          </div>
        </div>

        <div class="field">
          <label for="imposta">Imposta sostitutiva</label>
          <select id="imposta">
            <option value="0.05" selected>5% (primi 5 anni)</option>
            <option value="0.15">15% (ordinaria)</option>
          </select>
        </div>

        <div class="field">
          <label>Agevolazione contributiva</label>
          <div class="chips" id="riduzioneChips">
            <button class="chip active" data-reduct="none">Nessuna</button>
            <button class="chip" data-reduct="dip">Esenzione (lavoro dip.)</button>
            <button class="chip" data-reduct="35">Riduzione 35%</button>
            <button class="chip" data-reduct="50">Riduzione 50%</button>
          </div>
        </div>

        <div class="field">
          <label>Apertura Partita IVA</label>
          <div class="chips" id="openChips">
            <button class="chip active" data-open="pre2025">Aperta prima del 2025</button>
            <button class="chip" data-open="in2025">Aperta nel 2025</button>
          </div>
          <div class="subgrid">
            <div>
              <label for="dataApertura">Data apertura (se nel 2025)</label>
              <input id="dataApertura" type="date" min="2025-01-01" max="2025-12-31" disabled>
              <div class="desc" id="openHint">Se hai aperto prima del 2025 i fissi sono dovuti per 12 mesi.</div>
            </div>
          </div>
        </div>

        <div id="boxInfo" class="desc"></div>

        <!-- Opzioni avanzate -->
        <details class="adv" style="margin-top:4px">
          <summary>Opzioni avanzate</summary>
          <div class="adv-panel">
            <div class="adv-grid">
              <div class="ibox">
                <div class="bar">Acconti</div>
                <div class="subgrid">
                  <div><label>Acconti Imposta (%)</label><input id="accImpPerc" type="text" inputmode="decimal" value="100"></div>
                  <div><label>Acconti INPS (%)</label><input id="accInpsPerc" type="text" inputmode="decimal" value="100"></div>
                </div>
              </div>

              <div class="ibox">
                <div class="bar">Acconti versati l’anno precedente</div>
                <div class="pill-toggle" role="tablist" aria-label="Modalità inserimento acconti">
                  <button type="button" class="pill active" id="pillManuale" aria-pressed="true">Manuale</button>
                  <button type="button" class="pill" id="pillStima" aria-pressed="false">Stima da 2024</button>
                </div>
                <div class="subgrid" id="accManual">
                  <div><label>Acconti IMPOSTA 2024 (€)</label><input id="accImpPrev" type="text" inputmode="decimal" value="0"></div>
                  <div><label>Acconti INPS 2024 (€)</label><input id="accInpsPrev" type="text" inputmode="decimal" value="0"></div>
                </div>
                <div id="accStima" style="display:none">
                  <div class="subgrid">
                    <div><label>Incassato 2024 (€)</label><input id="incasso2024" type="text" inputmode="decimal" value="0"></div>
                    <div><label>Imposta 2024</label>
                      <select id="imp2024"><option value="0.05" selected>5%</option><option value="0.15">15%</option></select>
                    </div>
                    <div><label>Coeff. 2024 (%)</label><input id="coeff2024" class="coeff-input" maxlength="2" inputmode="numeric" value="78"></div>
                  </div>
                  <div class="desc">Stima veloce: stessa gestione/agevolazione di quest’anno.</div>
                </div>
              </div>

              <div class="ibox">
                <div class="bar">Contributi deducibili (imposta)</div>
                <div class="subgrid">
                  <div style="grid-column:1/-1">
                    <label for="deducibili">Contributi previdenziali già versati (€)</label>
                    <input id="deducibili" type="text" inputmode="decimal" value="0"/>
                  </div>
                </div>
              </div>

              <div class="ibox">
                <div class="bar">Calcolo inverso</div>
                <div class="subgrid" style="align-items:end">
                  <div><label for="nettoTarget">Netto annuo desiderato (€)</label><input id="nettoTarget" type="text" inputmode="decimal" placeholder="es. 20000"></div>
                  <div><button type="button" id="btnInverti" class="btn dark" style="width:100%">Calcola incassato</button></div>
                </div>
                <div id="invOut" class="desc" style="margin-top:8px"></div>
                <div class="desc">Nota: copre i <b>saldi</b> (imposta + INPS) ma non i nuovi acconti.</div>
              </div>
            </div>
          </div>
        </details>

        <div class="actions">
          <button class="btn primary" id="btnCalc">Calcola</button>
          <div class="sub-actions">
            <button class="btn dark" id="btnPrint">Stampa PDF</button>
            <button class="btn secondary" id="btnReset">Reset</button>
          </div>
        </div>

      </div>

      <div id="err" class="error" style="display:none"></div>
      <div id="liveResult" class="sr-only" aria-live="polite"></div>
    </div>
  </section>

  <!-- RISULTATI -->
  <section id="resultsBox" class="card" style="margin-top:14px;display:none" aria-live="polite">
    <div class="print-head" id="printHead"></div>

    <div class="tabbar-wrap">
      <div class="tab-bar" id="tabBar">
        <button class="tab-btn active" data-tab="tab1">Come si calcolano</button>
        <button class="tab-btn" data-tab="tab2">Risultati</button>
        <button class="tab-btn" data-tab="tab3">Scadenze</button>
        <span class="inkbar" id="inkbar"></span>
      </div>
      <div class="viewctrl">
        <span id="viewLabel">Vista Dettagliata</span>
        <label class="switch" title="Cambia vista">
          <input type="checkbox" id="simpToggle"><span class="slider"></span>
        </label>
      </div>
    </div>

    <div id="tab1" class="tab active">
      <h2 class="print-title">Come si calcolano</h2>
      <div class="pad"><div id="explanation" class="explanation"></div></div>
    </div>

    <div id="tab2" class="tab">
      <h2 class="print-title">Risultati Tasse da pagare</h2>
      <div class="pad">
        <div class="kpis">
          <div class="kpi"><h3>Reddito imponibile</h3><div class="big" id="outImponibile">€ 0</div><div class="muted" style="font-size:.85rem">Incassato × coefficiente</div></div>
          <div class="kpi"><h3>INPS (fissi + variabile)</h3><div class="big" id="outInps">€ 0</div><div class="muted" style="font-size:.85rem">Minimi + scaglioni</div></div>
          <div class="kpi"><h3>Imposta sostitutiva</h3><div class="big" id="outImposta">€ 0</div><div class="muted" style="font-size:.85rem">Su (imponibile − deducibili)</div></div>
        </div>
        <div class="kpis" style="margin-top:6px">
          <div class="kpi"><h3>Saldo da versare ora</h3><div class="big" id="outSaldo">€ 0</div></div>
          <div class="kpi"><h3>Acconti netti</h3><div class="big" id="outAcconti">€ 0</div></div>
          <div class="kpi"><h3>Totale anno</h3><div class="big" id="outTotale">€ 0</div></div>
        </div>
        <div class="hr" style="height:1px;background:var(--border);margin:14px 0"></div>
        <div id="warnings" style="text-align:center"></div>
        <h3 style="margin:6px 0">Dettaglio</h3>
        <table><tbody id="tblDettaglio"></tbody></table>
      </div>
    </div>

    <div id="tab3" class="tab">
      <h2 class="print-title">Scadenze da pagare</h2>
      <div class="pad">
        <h3 style="margin:0 0 6px">Fissi IVS 2025 (pro-rata a giorni)</h3>
        <table>
          <tbody id="tblFissi"></tbody>
          <tfoot><tr><th style="text-align:right">Totale fissi</th><th id="totFissi" style="text-align:right"></th></tr></tfoot>
        </table>

        <div class="hr" style="height:1px;background:var(--border);margin:14px 0"></div>

        <h3 style="margin:0 0 6px">Saldi & Acconti (imposta + IVS variabile)</h3>
        <table><tbody id="tblScadenze"></tbody><tfoot><tr><th style="text-align:right">Totale (fissi + saldi/acconti)</th><th id="scadTot" style="text-align:right"></th></tr></tfoot></table>

        <details class="rates" id="ratesAcc" style="margin-top:12px" open>
          <summary>Dettaglio rate di giugno (5 rate) + riga di novembre</summary>
          <div id="rateBlock" style="margin-top:8px">
            <table>
              <thead><tr><th>#</th><th>Scadenza</th><th>Quota capitale</th><th>Interessi %</th><th>Interessi €</th><th>Rata</th></tr></thead>
              <tbody id="rateBody"></tbody>
              <tfoot>
                <tr><th colspan="4" style="text-align:right">Totale interessi giugno</th><th id="rateIntTot">€ 0</th><th id="rateTot">€ 0</th></tr>
                <tr><th colspan="5" style="text-align:right">Totale complessivo (giugno + novembre)</th><th id="rateTotAll">€ 0</th></tr>
              </tfoot>
            </table>
          </div>
        </details>
      </div>
    </div>
  </section>
</div>

<script>
(function(){
  /* === Costanti 2025 === */
  const YEAR=2025;
  const MINIMALE = 18555;
  const SOGLIA_SUP = 55448;
  const FISSI = { artigiani: 4460.64, commercianti: 4549.70 };
  const VAR_RATE = { artigiani: 0.24, commercianti: 0.2448 };
  const VAR_RATE_HIGH = { artigiani: 0.25, commercianti: 0.2548 };
  const FIX_DATES = [
    {label:"16 maggio 2025", q:1},
    {label:"20 agosto 2025", q:2},
    {label:"17 novembre 2025", q:3},
    {label:"16 febbraio 2026", q:4}
  ];

  /* === Utils === */
  function euro(n){const r=Math.round(n||0);try{return new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR',minimumFractionDigits:0,maximumFractionDigits:0}).format(r);}catch{return '€ '+r.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.')}}
  function parseNum(s){if(s==null)return 0;let t=String(s).trim().replace(/\s+/g,'');t=t.replace(/\./g,'').replace(',','.');const n=parseFloat(t);return isNaN(n)?0:n}
  function val(id){return parseNum(document.getElementById(id).value)}
  function setHTML(id,html){const el=document.getElementById(id);if(el)el.innerHTML=html}
  function tr(a,b,right=false){return '<tr><td>'+a+'</td><td style="text-align:'+(right?'right':'center')+';font-variant-numeric:tabular-nums">'+b+'</td></tr>'}
  function perc(n,b){return b>0?(Math.round((n/b*100))+'%'):'0%'}
  function nowIt(){return new Intl.DateTimeFormat('it-IT',{dateStyle:'medium',timeStyle:'short'}).format(new Date())}
  function P(t){return `<p class="line">${t}</p>`}
  function wrapSection(title,inner,cls){return `<div class="section ${cls||''}"><button type="button" class="copy-btn">Copia</button><div class="copy-content">${title?`<h3>${title}</h3>`:''}${inner}</div></div>`}

  /* === Giorni/Trimestri === */
  function quarterBounds(year,q){ // q=1..4
    const starts=[new Date(year,0,1),new Date(year,3,1),new Date(year,6,1),new Date(year,9,1)];
    const ends=[new Date(year,2,31),new Date(year,5,30),new Date(year,8,30),new Date(year,11,31)];
    return {start:starts[q-1], end:ends[q-1]};
  }
  function daysDiffInclusive(d1,d2){
    return Math.floor((Date.UTC(d2.getFullYear(),d2.getMonth(),d2.getDate())-Date.UTC(d1.getFullYear(),d1.getMonth(),d1.getDate()))/86400000)+1;
  }

  /* === Riduzioni === */
  function reductFactor(code){ if(code==='dip')return 0; if(code==='35')return .65; if(code==='50')return .50; return 1 }
  function currentReductionCode(){const a=document.querySelector('#riduzioneChips .chip.active');return a?a.dataset.reduct:'none'}

  /* === FISSI a giorni per trimestre === */
  function calcFissiByDays(gestione, reductCode, openMode, openDateStr){
    const mult = reductFactor(reductCode);
    const annuo = FISSI[gestione]*mult;
    const baseQuarter = annuo/4;
    const qVals=[0,0,0,0];
    if(mult===0) return {q:qVals, tot:0};

    // Apertura prima del 2025: 4 quote piene
    if(openMode!=='in2025') return {q:[baseQuarter,baseQuarter,baseQuarter,baseQuarter], tot:annuo};

    if(!openDateStr) return {q:[0,0,0,0], tot:0};
    const dOpen = new Date(openDateStr+"T12:00:00");

    // Per ogni trimestre: 0 prima dell'apertura, proporzionato nel trimestre di apertura, pieno dopo
    for(let q=1;q<=4;q++){
      const {start,end}=quarterBounds(YEAR,q);
      const dTot = daysDiffInclusive(start,end);
      if(dOpen < start){ // apertura dopo questo trimestre
        qVals[q-1]=0;
      }else if(dOpen > end){ // apertura prima di questo trimestre
        qVals[q-1]=baseQuarter;
      }else{ // apertura dentro questo trimestre
        const dAct = daysDiffInclusive(dOpen,end);
        qVals[q-1]= baseQuarter * (dAct/dTot);
      }
    }
    const tot=qVals.reduce((a,b)=>a+b,0);
    return {q:qVals, tot};
  }

  /* === INPS variabile === */
  function calcINPS_Variabile(imponibile, gestione, reductCode){
    const mult = reductFactor(reductCode);
    const rateLow=VAR_RATE[gestione], rateHigh=VAR_RATE_HIGH[gestione];
    if(mult===0) return {base1:0,base2:0,quota1:0,quota2:0,tot:0,rateLow,rateHigh};
    const base1=Math.max(0, Math.min(imponibile, SOGLIA_SUP) - MINIMALE);
    const base2=Math.max(0, imponibile - SOGLIA_SUP);
    const q1=base1*rateLow*mult, q2=base2*rateHigh*mult;
    return {base1,base2,quota1:q1,quota2:q2,tot:q1+q2,rateLow,rateHigh};
  }

  /* === UI === */
  const gestioneSel=document.getElementById('gestione');
  const ridChips=document.getElementById('riduzioneChips');
  const openChips=document.getElementById('openChips');
  const openDate=document.getElementById('dataApertura');
  const incChips=document.getElementById('incChips');
  const incInput=document.getElementById('incassato');

  function refreshInfo(){
    const g=gestioneSel.value;
    setHTML('boxInfo',`Fissi annui <b>${euro(FISSI[g])}</b> • Variabile: ${Math.round(VAR_RATE[g]*100)}% / ${Math.round(VAR_RATE_HIGH[g]*100)}% (oltre ${euro(MINIMALE)}).`);
  }
  refreshInfo();
  gestioneSel.addEventListener('change',refreshInfo);

  // CHIP HANDLERS (ripristinati)
  incChips.addEventListener('click',e=>{
    const chip=e.target.closest('.chip'); if(!chip) return;
    incChips.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
    chip.classList.add('active');
    incInput.value = chip.dataset.valNum;
    incInput.focus();
    try{incInput.setSelectionRange(incInput.value.length,incInput.value.length);}catch{}
  });
  incInput.addEventListener('input',()=>{incChips.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));});

  document.getElementById('coeffChips').addEventListener('click',e=>{
    const c=e.target.closest('.chip'); if(!c) return;
    document.querySelectorAll('#coeffChips .chip').forEach(x=>x.classList.remove('active'));
    c.classList.add('active');
    document.getElementById('coeffCustom').value='';
  });

  ridChips.addEventListener('click',e=>{
    const c=e.target.closest('.chip'); if(!c) return;
    ridChips.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
    c.classList.add('active');
  });

  openChips.addEventListener('click',e=>{
    const c=e.target.closest('.chip'); if(!c) return;
    openChips.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
    c.classList.add('active');
    const mode=c.dataset.open;
    if(mode==='in2025'){openDate.disabled=false; setHTML('openHint','Se apri nel 2025: la prima rata utile si riduce in base al mese di apertura.');}
    else{openDate.disabled=true; openDate.value=''; setHTML('openHint','Apertura prima del 2025: 4 rate minime intere.');}
  });

  document.getElementById('pillManuale').addEventListener('click',function(){
    this.classList.add('active');document.getElementById('pillStima').classList.remove('active');
    document.getElementById('accManual').style.display='grid';document.getElementById('accStima').style.display='none';
  });
  document.getElementById('pillStima').addEventListener('click',function(){
    this.classList.add('active');document.getElementById('pillManuale').classList.remove('active');
    document.getElementById('accManual').style.display='none';document.getElementById('accStima').style.display='block';
  });

  // Tabs underline
  const inkbar=document.getElementById('inkbar');
  function moveInkbar(btn){if(!btn)return;inkbar.style.width=btn.offsetWidth+'px';inkbar.style.left=btn.offsetLeft+'px';}
  document.addEventListener('click',e=>{
    const b=e.target.closest('.tab-btn'); if(!b) return;
    document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active'); document.getElementById(b.dataset.tab).classList.add('active'); moveInkbar(b);
  });
  window.addEventListener('resize',()=>moveInkbar(document.querySelector('.tab-btn.active')));

  document.getElementById('simpToggle').addEventListener('change',()=>{document.getElementById('viewLabel').textContent=document.getElementById('simpToggle').checked?'Vista Semplificata':'Vista Dettagliata'; buildExplanation();});
  document.addEventListener('click',async e=>{
    const btn=e.target.closest('.copy-btn'); if(!btn) return;
    const box=btn.closest('.section'); const payload=(box.querySelector('.copy-content')||box).innerText.trim();
    try{await navigator.clipboard.writeText(payload);const t=btn.textContent;btn.textContent='Copiato!';setTimeout(()=>btn.textContent=t,1200);}catch{const t=btn.textContent;btn.textContent='Errore';setTimeout(()=>btn.textContent=t,1200);}
  });

  /* === Calcolo principale === */
  let lastState=null, cacheGiugno=0, cacheNov=0;

  function coeffPerc(){const c=document.getElementById('coeffCustom').value||document.querySelector('#coeffChips .chip.active')?.dataset.coeff||'78';return Math.max(1,parseInt(c,10)||78)}

  function compute(){
    const incassato=val('incassato');
    const cPerc=coeffPerc(), coeff=cPerc/100;
    const impRate=parseFloat(document.getElementById('imposta').value)||0.05;
    const accImpPerc=parseNum(document.getElementById('accImpPerc').value)/100||1.00;
    const accInpsPerc=parseNum(document.getElementById('accInpsPerc').value)/100||1.00;
    const deducibili=val('deducibili');
    const gestione=document.getElementById('gestione').value;
    const reduct=currentReductionCode();
    const openMode=document.querySelector('#openChips .chip.active').dataset.open;
    const openDateStr=document.getElementById('dataApertura').value;

    const err=document.getElementById('err');
    if(openMode==='in2025' && !openDateStr){err.style.display='block';err.textContent='Seleziona la data di apertura nel 2025 per ripartire i fissi a giorni.';document.getElementById('resultsBox').style.display='none';return}
    if(incassato<=0){err.style.display='block';err.textContent='Inserisci un incassato annuo valido (> 0).';document.getElementById('resultsBox').style.display='none';return}
    err.style.display='none';

    const imponibileForf=incassato*coeff;

    // INPS fissi + variabile
    const fissi=calcFissiByDays(gestione, reduct, openMode, openDateStr);
    const variab=calcINPS_Variabile(imponibileForf, gestione, reduct);
    const inpsTot=fissi.tot + variab.tot;

    // Imposta
    const imponibileFisc=Math.max(0,imponibileForf-Math.max(0,deducibili));
    const imposta=imponibileFisc*impRate;

    // Acconti precedenti
    let accImpPrev=0, accInpsPrev=0;
    if(document.getElementById('pillManuale').classList.contains('active')){
      accImpPrev=val('accImpPrev'); accInpsPrev=val('accInpsPrev');
    }else{
      const inc24=val('incasso2024'), c24=(parseNum(document.getElementById('coeff2024').value)||78)/100, imp24=parseFloat(document.getElementById('imp2024').value)||0.05;
      const impon24=inc24*c24;
      const inps24 = calcINPS_Variabile(impon24, gestione, reduct).tot; // stima veloce
      const imp24Val=Math.max(0,impon24)*imp24;
      accImpPrev=imp24Val; accInpsPrev=inps24;
    }

    // Saldi e nuovi acconti
    const saldoImp=Math.max(0,imposta-accImpPrev);
    const saldoInps=Math.max(0,inpsTot-accInpsPrev);
    const saldoTotale=saldoImp+saldoInps;

    const creditoImp=Math.max(0,accImpPrev-imposta);
    const creditoInps=Math.max(0,accInpsPrev-inpsTot);

    const accImpBase=imposta*accImpPerc;
    const accInpsBase=inpsTot*accInpsPerc;

    const accImpTot=Math.max(0,accImpBase-creditoImp);
    const accInpsTot=Math.max(0,accInpsBase-creditoInps);

    const accImp1=accImpTot*0.50, accImp2=accImpTot*0.50;
    const accInps1=accInpsTot*0.50, accInps2=accInpsTot*0.50;

    const accontiTot=accImpTot+accInpsTot;
    const giugnoTot=saldoTotale+accImp1+accInps1;
    const novTot=accImp2+accInps2;

    /* KPI */
    setHTML('outImponibile',euro(imponibileForf));
    setHTML('outInps',euro(inpsTot));
    setHTML('outImposta',euro(imposta));
    setHTML('outSaldo',euro(saldoTotale));
    setHTML('outAcconti',euro(accontiTot));
    setHTML('outTotale',euro(saldoTotale+accontiTot));

    /* Dettaglio */
    let det='';
    det+=tr('<b>Gestione</b>',gestione==='artigiani'?'Artigiani':'Commercianti');
    det+=tr('<b>Incassato</b>',euro(incassato));
    det+=tr('Coefficiente',cPerc+'%');
    det+=tr('<b>Imponibile</b>',euro(imponibileForf));
    const rtxt={none:'Nessuna',dip:'Esenzione (lavoro dip.)','35':'Riduzione 35%','50':'Riduzione 50%'}[reduct];
    det+=tr('Agevolazione',rtxt);

    if(reduct==='dip'){
      det+=tr('<b>INPS fissi</b>','<b>€ 0</b>');
      det+=tr('<b>INPS variabile</b>','<b>€ 0</b>');
    }else{
      det+='<tr><th colspan="2">Contributi fissi (minimi)</th></tr>';
      det+=tr('Totale fissi (anno)',euro(fissi.tot));
      det+=tr('16/05/2025 — Q1',euro(fissi.q[0]));
      det+=tr('20/08/2025 — Q2',euro(fissi.q[1]));
      det+=tr('17/11/2025 — Q3',euro(fissi.q[2]));
      det+=tr('16/02/2026 — Q4',euro(fissi.q[3]));
      det+='<tr><th colspan="2">Contributi variabili (sul reddito)</th></tr>';
      const rL=(variab.rateLow*100).toFixed(2), rH=(variab.rateHigh*100).toFixed(2);
      det+=tr('Variabile totale',euro(variab.tot));
      if(variab.base1>0) det+=tr(`• ${rL}% sulla quota tra ${euro(MINIMALE)} e ${euro(SOGLIA_SUP)}`,euro(variab.quota1));
      if(variab.base2>0) det+=tr(`• ${rH}% oltre ${euro(SOGLIA_SUP)}`,euro(variab.quota2));
    }

    det+='<tr><th colspan="2">Imposta sostitutiva, saldi e acconti</th></tr>';
    det+=tr('Deducibili per imposta','− '+euro(deducibili));
    det+=tr('Base per imposta',euro(imponibileFisc));
    det+=tr('Aliquota imposta',Math.round(impRate*100)+'%');
    det+=tr('Imposta calcolata',euro(imposta));
    det+=tr('Acconti imposta 2024','− '+euro(accImpPrev));
    det+=tr('Acconti INPS 2024','− '+euro(accInpsPrev));
    det+=tr('<b>Saldo INPS</b>','<b>'+euro(saldoInps)+'</b>');
    det+=tr('<b>Saldo imposta</b>','<b>'+euro(saldoImp)+'</b>');
    det+=tr('<b>Saldo totale</b>','<b>'+euro(saldoTotale)+'</b>');
    det+=tr('Acconti imposta (50%/50%)',`${euro(accImp1)} / ${euro(accImp2)}`);
    det+=tr('Acconti INPS (50%/50%)',`${euro(accInps1)} / ${euro(accInps2)}`);
    setHTML('tblDettaglio',det);

    /* Scadenze */
    let tf=''; let totFissi=0;
    FIX_DATES.forEach((d,idx)=>{ tf+=tr(d.label, euro(fissi.q[idx]||0), true); totFissi+=(fissi.q[idx]||0); });
    setHTML('tblFissi',tf); setHTML('totFissi',euro(totFissi));

    cacheGiugno=giugnoTot; cacheNov=novTot;
    let sc=''; sc+=tr('<span class="badge-month">Giugno</span> — Saldi (imposta + variabile) + 1° acconti',euro(giugnoTot),true);
    sc+=tr('<span class="badge-month">Novembre</span> — 2° acconti',euro(novTot),true);
    setHTML('tblScadenze',sc);
    setHTML('scadTot',euro(giugnoTot+novTot+totFissi));

    lastState={incassato,coeffPerc:cPerc,imponibileForf,variab,fissi,imposta,imponibileFisc,impRate,
      saldoImp,saldoInps,saldoTotale,accImpTot,accInpsTot,accImp1,accImp2,accInps1,accInps2,giugnoTot,novTot,totFissi};

    buildExplanation();

    document.getElementById('resultsBox').style.display='';
    const t=document.querySelector('.tab-btn.active'); if(t) moveInkbar(t);
    setHTML('printHead', `<div><strong>Simulatore Forfettario – INPS Commercianti/Artigiani 2025</strong></div>
      <div style="font-size:12px;color:#6b7280;margin-top:2px">Stampa generata il ${nowIt()}</div>`);
  }

  function buildExplanation(){
    if(!lastState) return;
    const s=lastState, simple=document.getElementById('simpToggle').checked;
    const impForf=euro(s.imponibileForf), inpsVar=euro(s.variab.tot), inpsFissi=euro(s.fissi.tot),
          q1=euro(s.fissi.q[0]||0), q2=euro(s.fissi.q[1]||0), q3=euro(s.fissi.q[2]||0), q4=euro(s.fissi.q[3]||0),
          imposta=euro(s.imposta), baseImp=euro(s.imponibileFisc),
          saldoINPS=euro(s.saldoInps), saldoIMP=euro(s.saldoImp),
          giu=euro(s.giugnoTot), nov=euro(s.novTot), tot=euro(s.giugnoTot+s.novTot+s.totFissi);

    let html='';
    if(!simple){
      html+=wrapSection('Contributi fissi (minimi) – come si pagano',
        P(`I minimi si dividono in <b>4 rate</b>: 16/05, 20/08, 17/11 e 16/02/2026.`) +
        P(`Se apri a <b>gennaio</b> paghi tutte e quattro le rate intere.`) +
        P(`Se apri <b>durante l’anno</b>: le rate <b>prima</b> dell’apertura sono <b>€ 0</b>, la <b>prima utile</b> si riduce in base al periodo effettivo lavorato, le <b>altre due</b> sono <b>intere</b>.`) +
        P(`Per il tuo caso: Q1 <b>${q1}</b>, Q2 <b>${q2}</b>, Q3 <b>${q3}</b>, Q4 <b>${q4}</b> — Totale minimi <b>${inpsFissi}</b>.`),'inps');

      const rL=(s.variab.rateLow*100).toFixed(2), rH=(s.variab.rateHigh*100).toFixed(2);
      html+=wrapSection('Contributi variabili (sul reddito)',
        P(`Imponibile forfettario <b>${impForf}</b>. Sulla parte oltre ${euro(MINIMALE)} si applica <b>${rL}%</b> fino a ${euro(SOGLIA_SUP)}, poi <b>${rH}%</b> sull’eccedenza. Totale variabile: <b>${inpsVar}</b>.`),'inps');

      html+=wrapSection('Imposta sostitutiva, saldi e acconti',
        P(`Base per imposta: <b>${baseImp}</b> → imposta <b>${imposta}</b>.`) +
        P(`<b>Giugno</b>: saldi (imposta + variabile) + 1° acconti = <b>${giu}</b>. <b>Novembre</b>: 2° acconti = <b>${nov}</b>.`) +
        P(`Totale anno (minimi + giugno + novembre): <b>${tot}</b>.`), 'imp');
    }else{
      html+=wrapSection('Sintesi',
        P(`Minimi: <b>${inpsFissi}</b> — Q1 ${q1}, Q2 ${q2}, Q3 ${q3}, Q4 ${q4}.`) +
        P(`Variabile su imponibile ${impForf}: <b>${inpsVar}</b>. Imposta su base ${baseImp}: <b>${imposta}</b>.`) +
        P(`Giugno <b>${giu}</b> • Novembre <b>${nov}</b> • Totale con minimi <b>${tot}</b>.`),'');
    }
    setHTML('explanation',html);
  }

  function buildRate(){
    const totGiu=cacheGiugno, quota=totGiu/5; let tbody='',sumInt=0,sumTotGiu=0;
    const RATE_PERC=[0.00,0.18,0.51,0.84,1.17];
    const RATE_DATE=["30 giugno","16 luglio","20 agosto","16 settembre","16 ottobre"];
    for(let i=0;i<5;i++){
      const p=RATE_PERC[i]/100, interesse=totGiu*p, rata=quota+interesse;
      sumInt+=interesse; sumTotGiu+=rata;
      tbody+=`<tr><td>${i+1}</td><td>${RATE_DATE[i]}</td><td>${euro(quota)}</td><td>${RATE_PERC[i].toFixed(2)}%</td><td>${euro(interesse)}</td><td><b>${euro(rata)}</b></td></tr>`;
    }
    tbody+=`<tr><td>6</td><td><b>Novembre — 2° acconti</b></td><td>${euro(cacheNov)}</td><td>—</td><td>—</td><td><b>${euro(cacheNov)}</b></td></tr>`;
    setHTML('rateBody',tbody); setHTML('rateIntTot',euro(sumInt)); setHTML('rateTot',euro(sumTotGiu)); setHTML('rateTotAll',euro(sumTotGiu+cacheNov));
  }

  document.getElementById('btnCalc').addEventListener('click',()=>{compute();document.getElementById('ratesAcc').open=true;buildRate();});
  document.getElementById('btnPrint').addEventListener('click',()=>{if(document.getElementById('resultsBox').style.display==='none'){alert('Prima calcola.');return;}window.print();});
  document.getElementById('btnReset').addEventListener('click',()=>{
    ['incassato','deducibili','accImpPrev','accInpsPrev','incasso2024','nettoTarget'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
    document.getElementById('coeffCustom').value='';
    document.querySelectorAll('#coeffChips .chip').forEach(x=>x.classList.remove('active'));
    document.querySelector('#coeffChips .chip[data-coeff="78"]').classList.add('active');
    document.getElementById('imposta').value='0.05';
    document.getElementById('accImpPerc').value='100'; document.getElementById('accInpsPerc').value='100';
    ridChips.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
    ridChips.querySelector('.chip[data-reduct="none"]').classList.add('active');
    openChips.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
    openChips.querySelector('.chip[data-open="pre2025"]').classList.add('active');
    openDate.disabled=true; openDate.value='';
    document.getElementById('resultsBox').style.display='none';
  });

  // Enter = CALCOLA
  ['incassato','deducibili','accImpPrev','accInpsPrev','incasso2024','coeff2024','accImpPerc','accInpsPerc','nettoTarget']
    .forEach(id=>{const el=document.getElementById(id);if(!el)return;el.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();document.getElementById('btnCalc').click();}})});
})();
</script>
</body>
</html>
