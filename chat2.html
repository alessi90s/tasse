<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulatore Forfettario â€¢ GS 2025</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f7f9fc; --card:#fff; --text:#0f172a; --muted:#64748b; --border:#e6e6eb;
    --accent:#2563eb; --accent-2:#111827; --radius:14px; --shadow:0 14px 28px rgba(2,6,23,.08);
    --hl-y:#FFF8C8; --hl-g:#eafcf1; --hl-b:#e8f0ff; --green:#16a34a;
    --lineH:30px; --grid:28px; --dots:26px;
  }
  *{box-sizing:border-box}
  html{font-size:17px}
  body{
    margin:0;color:var(--text);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;
    /* Pattern quaderno SOLO come sfondo pagina, opacitÃ  bassa */
    background:
      radial-gradient(rgba(2,6,23,.20) 1px, transparent 1px) 0 0/ var(--dots) var(--dots),
      #f7f9fc;
  }
  .wrap{max-width:860px;margin:32px auto;padding:0 14px}

  /* ===== Header su due righe con badge (peso 800 e margine) ===== */
  header{display:flex;justify-content:center;margin-bottom:16px}
  .title{
    text-align:center; line-height:1.15; margin:0;
    font-size:2rem; font-weight:800; letter-spacing:-.01em;
  }
  .title .sub{display:block; margin-top:6px}
  .badge{
    display:inline-block; padding:6px 12px; border-radius:9999px; font-weight:900;
    background:#eef2ff; color:#111827; border:1px solid #c7d2fe;
  }

  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .pad{padding:20px}

  /* Spaziatura macro 24px tra blocchi principali */
  .form-vertical{display:flex;flex-direction:column;row-gap:24px}
  .field{width:100%}
  label{display:block;margin:0 0 6px;font-weight:700}
  /* Evidenziazione: giallo pastello + bordo coerente dappertutto */
  .hl{
    padding:0 .35em;border-radius:.5em;background:var(--hl-y);
    border:1px solid #F3E89A; /* dal PDF */
  }
  .mark-b,.mark-g,.mark-y{padding:0 .35em;border-radius:.5em}
  .mark-b{background:var(--hl-b)} .mark-g{background:var(--hl-g)} .mark-y{background:var(--hl-y)}
  input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:1rem}
  input:disabled{background:#f8fafc;color:#334155}
  input:focus,select:focus,.btn:focus{outline:3px solid #c7d2fe; outline-offset:2px} /* focus accessibile */

  /* Chips (importi & coefficienti) UNIFORMI (h40, pad 0-14, radius full), gap 8-10 */
  .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
  .chip{
    height:40px; padding:0 14px; display:inline-flex; align-items:center; justify-content:center;
    border:1px solid var(--border); border-radius:9999px; background:#fff;
    cursor:pointer; font-weight:800; font-size:.95rem; transition:border-color .15s, box-shadow .15s, transform .05s;
    box-shadow: inset 0 0 0 0 rgba(59,130,246,.0);
  }
  .chip:hover{border-color:#bcd0ff; box-shadow: inset 0 0 0 1px rgba(59,130,246,.25)}
  .chip:active{transform:translateY(1px)}
  .chip.active{background:#111827;color:#fff;border-color:#111827}

  .coeff-wrap{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .coeff-input{width:86px}

  /* Pulsanti finali: Calcola principale (max 440), secondari sotto centrati */
  .actions{display:flex;flex-direction:column;gap:12px;align-items:center;margin-top:6px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:11px 14px;border:0;border-radius:10px;font-weight:800;font-size:1rem;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;padding:14px 18px;font-size:1.06rem;width:min(440px,100%);height:52px}
  .sub-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .btn.secondary{background:#fff;color:#111;border:1px solid var(--border);padding:9px 12px}
  .btn.dark{background:var(--accent-2);color:#fff;padding:9px 12px}

  /* Opzioni avanzate â€” header cliccabile con chevron, pannello card */
  details.adv{display:block;width:100%}
  details.adv > summary{
    cursor:pointer; list-style:none; padding:10px 14px; border:1px solid var(--border); border-radius:12px;
    font-weight:900; background:#fff; display:flex; align-items:center; gap:10px;
  }
  details.adv > summary::before{
    content:""; width:10px;height:10px;border:2px solid #111827;border-left:0;border-top:0;transform:rotate(45deg);transition:.2s;
  }
  details.adv[open] > summary::before{transform:rotate(-135deg)}
  details.adv[open] > summary{background:#111827;color:#fff;border-color:#111827}
  .adv-panel{
    display:none;margin-top:12px;width:100%;
    background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 24px rgba(2,6,23,.06);padding:16px
  }
  details.adv[open] .adv-panel{display:block}
  .adv-grid{display:grid;row-gap:16px}
  .subgrid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}

  /* Box interni coerenti (card bianca + titolo in barra blu scuro) */
  .ibox{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:0 6px 16px rgba(2,6,23,.04)}
  .ibox .bar{
    display:flex;align-items:center;gap:8px;margin:-6px -6px 10px;padding:8px 10px;border-radius:8px;
    background:#0F1D40; color:#fff; font-weight:900
  }
  .ibox .bar.green{background:#065f46}

  /* Pill toggle Manuale/Stima */
  .pill-toggle{display:flex;justify-content:center;gap:8px;margin:8px 0 16px}
  .pill{height:38px;padding:0 14px;border-radius:9999px;border:1px solid var(--border);background:#fff;font-weight:900;cursor:pointer}
  .pill.active{background:#111827;color:#fff;border-color:#111827}

  /* Sezioni spiegazione + copia (card) */
  .section{position:relative;border-left:4px solid #e5e7eb;padding:14px 14px 12px;margin:12px 0 8px;border-radius:10px;background:#fff;border:1px solid var(--border);box-shadow:0 6px 16px rgba(2,6,23,.04)}
  .section.inps{border-left-color:var(--accent)}
  .section.imp{border-left-color:var(--green)}
  .section h3{margin:0 0 6px;font-size:1.05rem;font-weight:700}
  .copy-btn{
    position:absolute; right:-10px; top:-10px; padding:6px 10px; font-size:.75rem; font-weight:900;
    border:0; border-radius:999px; background:#111827; color:#fff; box-shadow:0 6px 14px rgba(2,6,23,.18);
    cursor:pointer; opacity:0; transition:opacity .15s, transform .15s; transform:translateY(2px);
  }
  .section:hover .copy-btn{opacity:1; transform:none}
  @media (max-width:900px){ .copy-btn{display:none} }

  /* Tabs moderni con underline animato + scroll snap */
  .tabs{margin-top:14px}
  .tabbar-wrap{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 12px}
  .tab-bar{position:relative;display:flex;gap:8px;flex-wrap:nowrap;overflow:auto;scroll-snap-type:x mandatory}
  .tab-btn{
    position:relative;border:1px solid var(--border);background:#fff;border-radius:9999px;padding:8px 14px;height:38px;
    cursor:pointer;font-weight:900;scroll-snap-align:start;white-space:nowrap;
  }
  .tab-btn.active{background:#E8F0FF;color:#111827;border-color:#c7d2fe}
  .inkbar{position:absolute;height:2px;background:#3b82f6;border-radius:2px;bottom:-6px;left:0;width:30px;transition:all .25s ease}

  /* Toggle vista accanto ai tab */
  .viewctrl{display:flex;align-items:center;gap:10px}
  .viewctrl .tag{color:#64748b;font-weight:800;user-select:none}
  .switch{position:relative;display:inline-block;width:52px;height:28px}
  .switch input{opacity:0;width:0;height:0}
  .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#e5e7eb;transition:.2s;border-radius:999px}
  .slider:before{position:absolute;content:"";height:22px;width:22px;left:3px;top:3px;background:white;transition:.2s;border-radius:50%}
  .switch input:checked + .slider{background:#111827}
  .switch input:checked + .slider:before{transform:translateX(24px)}

  .tab{display:none} .tab.active{display:block}

  /* KPI e tabelle */
  .kpis{display:grid;gap:12px;margin-top:8px}
  @media(min-width:860px){.kpis{grid-template-columns:repeat(3,1fr)}}
  .kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;box-shadow:0 6px 16px rgba(2,6,23,.04)}
  .kpi h3{margin:0 0 6px;font-size:.8rem;color:#64748b;letter-spacing:.02em;text-transform:uppercase;font-weight:700;display:flex;gap:6px;align-items:center;justify-content:center}
  .kpi h3 .ico{font-size:.95rem;opacity:.9}
  .kpi .big{font-size:1.35rem;font-weight:900;font-variant-numeric:tabular-nums}
  .hr{height:1px;background:var(--border);margin:14px 0}
  table{width:100%;border-collapse:collapse;margin-top:6px;font-size:.98rem;background:#fff;border:1px solid var(--border);box-shadow:0 6px 16px rgba(2,6,23,.04)}
  th,td{border:1px solid var(--border);padding:12px 8px}
  th{background:#f7f7fb;color:#475569;font-weight:800}
  td:first-child{font-weight:600}
  #tblScadenze tr:hover, #rateBody tr:hover{background:#F8FAFF}
  #tblScadenze td:nth-child(2), #rateBody td:last-child, #rateBody td:nth-child(3), #rateBody td:nth-child(5), tfoot th:last-child{
    text-align:right; font-family:ui-monospace,Consolas,Menlo,monospace; font-variant-numeric:tabular-nums;
  }
  .badge-month{display:inline-block;padding:2px 8px;border-radius:9999px;background:#eef2ff;border:1px solid #c7d2fe;font-weight:800}

  /* Testo spiegazione (ritmo line-height) */
  .explanation{max-width:820px;margin:0 auto;text-align:left}
  .explanation .line{line-height:var(--lineH); margin:0; font-weight:500}

  .mono{font-family:ui-monospace,Consolas,Menlo,Monaco,monospace}
  .muted{color:var(--muted)}
  .error{margin-top:10px;padding:10px;border-left:4px solid #ef4444;background:#fdecec;border-radius:10px;color:#7f1d1d}

  /* Accordion â€œrateâ€ con chevron */
  details.rates > summary{
    list-style:none; cursor:pointer; display:flex; align-items:center; gap:8px;
    font-weight:800; color:#111827; padding:6px 0;
  }
  details.rates > summary::before{
    content:""; width:8px;height:8px;border:2px solid #111827;border-left:0;border-top:0;transform:rotate(45deg);transition:.2s;
  }
  details.rates[open] > summary::before{transform:rotate(-135deg)}

  /* A11y util */
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

  /* PRINT: solo risultati, intestazione con data/ora, niente page-break dentro tabelle */
  @media print{
    body{background:#fff}
    header, #inputCard, .sub-actions, .actions, .tabbar-wrap .viewctrl, .copy-btn{display:none!important}
    .wrap{max-width:1000px;margin:0;padding:0}
    #resultsBox{border:none;box-shadow:none}
    .tabbar-wrap{display:none!important}
    /* mostra TUTTI i tab in stampa */
    .tab{display:block !important; page-break-inside:avoid}
    .print-header{display:flex !important; align-items:baseline; justify-content:space-between; margin:0 0 8px}
    .print-title{display:block !important; font-size:1.15rem; font-weight:800; margin:8px 0}
    table, tr, td, th{page-break-inside:avoid}
    @page{size:A4;margin:16mm}
  }
  .print-header,.print-title{display:none}
</style>
</head>
<body>
<div class="wrap">
  <!-- Titolo su 2 righe con badge -->
  <header>
    <h1 class="title">
      Simulatore Forfettario per
      <span class="sub"><span class="badge">Gestione Separata 2025</span></span>
    </h1>
  </header>

  <!-- ===== FORM ===== -->
  <section class="card" id="inputCard" style="margin-top:14px">
    <div class="pad">
      <div class="form-vertical" style="max-width:720px;margin:0 auto">

        <div class="field">
          <label for="anno">Anno di riferimento <span class="hl" title="Anno di calcolo">2025</span></label>
          <input id="anno" type="text" value="2025" disabled aria-disabled="true" />
        </div>

        <div class="field">
          <label for="incassato">Incassato annuo (â‚¬) <span class="hl" title="Importo incassato dellâ€™anno">importo incassato dellâ€™anno</span></label>
          <input id="incassato" type="text" inputmode="decimal" placeholder="es. 30.000" />
          <div class="chips" aria-label="Importi rapidi">
            <button class="chip" data-val="10000">10.000</button>
            <button class="chip" data-val="20000">20.000</button>
            <button class="chip" data-val="30000">30.000</button>
            <button class="chip" data-val="50000">50.000</button>
            <button class="chip" data-val="65000">65.000</button>
            <button class="chip" data-val="85000">85.000</button>
          </div>
        </div>

        <div class="field">
          <label>Coefficiente di <span class="hl" title="Percentuale di redditivitÃ ">redditivitÃ </span></label>
          <div class="coeff-wrap">
            <div class="chips" id="coeffChips">
              <button class="chip active" data-coeff="78">78%</button>
              <button class="chip" data-coeff="86">86%</button>
              <button class="chip" data-coeff="67">67%</button>
            </div>
            <input id="coeffCustom" class="coeff-input" maxlength="2" inputmode="numeric" pattern="[0-9]*" placeholder="%" title="2 cifre" />
            <span class="muted" style="font-size:.9rem">personalizzato</span>
          </div>
        </div>

        <div class="field">
          <label for="imposta">Percentuale <span class="hl" title="Aliquota imposta sostitutiva">Imposta sostitutiva</span></label>
          <select id="imposta">
            <option value="0.05" selected>5% (primi 5 anni)</option>
            <option value="0.15">15% (ordinaria)</option>
          </select>
        </div>

        <!-- Opzioni avanzate -->
        <details class="adv" style="margin-top:4px">
          <summary>Opzioni avanzate</summary>
          <div class="adv-panel">
            <div class="adv-grid">

              <div class="ibox">
                <div class="bar">Parametri INPS & acconti</div>
                <div class="subgrid">
                  <div><label>Aliquota INPS (%)</label><input id="aliqInps" type="text" inputmode="decimal" value="26,07"></div>
                  <div><label>Acconti Imposta (%)</label><input id="accImpPerc" type="text" inputmode="decimal" value="100"></div>
                  <div><label>Acconti INPS (%)</label><input id="accInpsPerc" type="text" inputmode="decimal" value="80"></div>
                </div>
                <div class="muted" style="font-size:.9rem;margin-top:6px">Varia aliquota INPS e percentuali acconti (metodo storico).</div>
              </div>

              <div class="ibox">
                <div class="bar">Acconti versati lâ€™anno precedente</div>

                <div class="pill-toggle" role="tablist" aria-label="ModalitÃ  inserimento acconti">
                  <button type="button" class="pill active" id="pillManuale">Manuale</button>
                  <button type="button" class="pill" id="pillStima">Stima automatica da incasso 2024</button>
                </div>

                <div class="subgrid" id="accManual">
                  <div><label>Acconti IMPOSTA versati (â‚¬)</label><input id="accImpPrev" type="text" inputmode="decimal" value="0"></div>
                  <div><label>Acconti INPS versati (â‚¬)</label><input id="accInpsPrev" type="text" inputmode="decimal" value="0"></div>
                </div>

                <div id="accStima" style="display:none">
                  <div class="subgrid">
                    <div><label>Incassato 2024 (â‚¬)</label><input id="incasso2024" type="text" inputmode="decimal" value="0"></div>
                    <div>
                      <label>Imposta 2024</label>
                      <select id="imp2024"><option value="0.05" selected>5%</option><option value="0.15">15%</option></select>
                    </div>
                    <div><label>Coeff. 2024 (%)</label><input id="coeff2024" type="text" class="coeff-input" maxlength="2" inputmode="numeric" pattern="[0-9]*" value="78"></div>
                    <div><label>Aliquota INPS 2024 (%)</label><input id="inps2024" type="text" inputmode="decimal" value="26,07"></div>
                  </div>
                  <div class="muted" style="margin-top:6px">Stima veloce: nessuna deduzione; acconti â‰ˆ impostaÃ—100% e INPSÃ—80%.</div>
                </div>
              </div>

              <div class="ibox">
                <div class="bar green">Contributi deducibili (per lâ€™imposta)</div>
                <div class="subgrid">
                  <div style="grid-column:1/-1">
                    <label for="deducibili">Contributi previdenziali versati nellâ€™anno (â‚¬)</label>
                    <input id="deducibili" type="text" inputmode="decimal" value="0" />
                  </div>
                </div>
              </div>

            </div>
          </div>
        </details>

        <div class="actions">
          <button class="btn primary" id="btnCalc">Calcola</button>
          <div class="sub-actions">
            <button class="btn dark" id="btnPrint">Stampa PDF</button>
            <button class="btn secondary" id="btnReset">Reset</button>
          </div>
        </div>

      </div>

      <div id="err" class="error" style="display:none"></div>
    </div>
  </section>

  <!-- ===== RISULTATI ===== -->
  <section id="resultsBox" class="card" style="margin-top:14px; display:none" aria-live="polite">
    <!-- intestazione stampa -->
    <div class="print-header">
      <div style="font-weight:800">Simulatore Forfettario â€“ Risultati</div>
      <div id="printDateTime" class="muted"></div>
    </div>

    <div class="tabbar-wrap">
      <div class="tab-bar" id="tabBar">
        <button class="tab-btn active" data-tab="tab1">Come si calcolano</button>
        <button class="tab-btn" data-tab="tab2">Risultati Tasse da pagare</button>
        <button class="tab-btn" data-tab="tab3">Scadenze da pagare</button>
        <span class="inkbar" id="inkbar"></span>
      </div>
      <div class="viewctrl">
        <span class="tag">Vista</span>
        <span id="viewLabel" class="tag"><b>Dettagliata</b></span>
        <label class="switch" title="Cambia tra dettagliata e semplificata"><input type="checkbox" id="simpToggle"><span class="slider"></span></label>
      </div>
    </div>

    <div id="tab1" class="tab active">
      <h2 class="print-title">Come si calcolano</h2>
      <div class="pad">
        <div id="explanation" class="explanation"></div>
      </div>
    </div>

    <div id="tab2" class="tab">
      <h2 class="print-title">Risultati Tasse da pagare</h2>
      <div class="pad">
        <div class="kpis">
          <div class="kpi"><h3><span class="ico">â‚¬</span> Reddito imponibile</h3><div class="big" id="outImponibile">â‚¬ 0</div><div class="muted" style="font-size:.85rem">Incassato Ã— coefficiente</div></div>
          <div class="kpi"><h3><span class="ico">%</span> Contributi INPS</h3><div class="big" id="outInps">â‚¬ 0</div><div class="muted" style="font-size:.85rem">Aliquota su imponibile</div></div>
          <div class="kpi"><h3><span class="ico">Î£</span> Imposta sostitutiva</h3><div class="big" id="outImposta">â‚¬ 0</div><div class="muted" style="font-size:.85rem">Su (imponibile âˆ’ deducibili)</div></div>
        </div>
        <div class="kpis" style="margin-top:6px">
          <div class="kpi"><h3>Saldo da versare ora</h3><div class="big" id="outSaldo">â‚¬ 0</div><div class="muted" style="font-size:.85rem">INPS + Imposta (netto acconti)</div></div>
          <div class="kpi"><h3>Acconti netti</h3><div class="big" id="outAcconti">â‚¬ 0</div><div class="muted" style="font-size:.85rem">Imposta 100% â€¢ INPS 80%</div></div>
          <div class="kpi"><h3>Totale anno</h3><div class="big" id="outTotale">â‚¬ 0</div><div class="muted" style="font-size:.85rem">Saldo + acconti</div></div>
        </div>
        <div class="hr"></div>
        <div id="warnings" style="text-align:center"></div>
        <h3 style="margin:6px 0">Dettaglio</h3>
        <table>
          <tbody id="tblDettaglio"></tbody>
          <tfoot>
            <tr><th style="text-align:right" colspan="1">Totale</th><th id="detTot" style="text-align:center"></th></tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div id="tab3" class="tab">
      <h2 class="print-title">Scadenze da pagare</h2>
      <div class="pad">
        <h3 style="margin:0 0 6px">Scadenze sintetiche</h3>
        <table>
          <tbody id="tblScadenze"></tbody>
          <tfoot>
            <tr><th style="text-align:right" colspan="1">Totale anno</th><th id="scadTot" style="text-align:right"></th></tr>
          </tfoot>
        </table>

        <details class="rates" id="ratesAcc" style="margin-top:12px">
          <summary>Mostra dettaglio rate di giugno (5 rate con interessi) + riga di novembre</summary>
          <div id="rateBlock" style="margin-top:8px">
            <table>
              <thead><tr><th>#</th><th>Scadenza</th><th>Quota capitale</th><th>Interessi %</th><th>Interessi â‚¬</th><th>Rata</th></tr></thead>
              <tbody id="rateBody"></tbody>
              <tfoot>
                <tr><th colspan="4" style="text-align:right">Totale interessi giugno</th><th id="rateIntTot">â‚¬ 0</th><th id="rateTot">â‚¬ 0</th></tr>
                <tr><th colspan="5" style="text-align:right">Totale complessivo (giugno + novembre)</th><th id="rateTotAll">â‚¬ 0</th></tr>
              </tfoot>
            </table>
          </div>
        </details>
      </div>
    </div>

  </section>

  <!-- aria-live riassunto per screen reader -->
  <div id="live" class="sr-only" aria-live="polite"></div>
</div>

<script>
(function(){
  /* ---------- Utils ---------- */
  function euro(n){ const r=Math.round(n||0);
    try{ return new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR',minimumFractionDigits:0,maximumFractionDigits:0}).format(r);}
    catch(e){ return "â‚¬ "+(r.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".")); } }
  function parseNum(str){if(str==null)return 0;let s=String(str).trim().replace(/\s+/g,'');s=s.replace(/\./g,'');s=s.replace(',', '.');const n=parseFloat(s);return isNaN(n)?0:n}
  function val(id){return parseNum(document.getElementById(id).value)}
  function setHTML(id,html){const el=document.getElementById(id);if(el)el.innerHTML=html}
  function show(x){if(typeof x==='string')x=document.getElementById(x);x.style.display=''}
  function hide(x){if(typeof x==='string')x=document.getElementById(x);x.style.display='none'}
  function tr(a,b,tdRight=false){return '<tr><td>'+a+'</td><td style="text-align:'+(tdRight?'right':'center')+'">'+b+'</td></tr>'}
  function perc(n,b){return b>0?(Math.round((n/b*100))+'%'):'0%'}

  const RATE_PERC=[0.00,0.18,0.51,0.84,1.17];
  const RATE_DATE=["30 giugno","16 luglio","20 agosto","16 settembre","16 ottobre"];

  let cacheGiugno=0, cacheNov=0, lastState=null;
  let coeffFromChips=78; // default 78%

  /* ---------- Tabs + Inkbar ---------- */
  const tabBar=document.getElementById('tabBar');
  const inkbar=document.getElementById('inkbar');
  function moveInkbar(btn){ if(!btn) return; inkbar.style.width = btn.offsetWidth+'px'; inkbar.style.left = btn.offsetLeft+'px'; }
  function activateTab(btn){
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.getElementById(btn.dataset.tab).classList.add('active');
    moveInkbar(btn);
  }
  document.addEventListener('click',e=>{
    const btn=e.target.closest('.tab-btn'); if(!btn) return; activateTab(btn);
  });
  window.addEventListener('resize',()=>{ const active=document.querySelector('.tab-btn.active'); moveInkbar(active); });

  /* ---------- Chips incasso ---------- */
  document.addEventListener('click',e=>{
    const chip=e.target.closest('.chip'); if(!chip||!chip.dataset.val) return;
    document.querySelectorAll('.chip[data-val]').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    const v=parseInt(chip.dataset.val,10)||0;
    document.getElementById('incassato').value=v.toLocaleString('it-IT');
  });

  /* ---------- Coeff chips + custom ---------- */
  document.getElementById('coeffChips').addEventListener('click',e=>{
    const c=e.target.closest('.chip'); if(!c) return;
    document.querySelectorAll('#coeffChips .chip').forEach(x=>x.classList.remove('active'));
    c.classList.add('active'); coeffFromChips=parseInt(c.dataset.coeff,10)||78;
    document.getElementById('coeffCustom').value='';
  });
  document.getElementById('coeffCustom').addEventListener('input',function(){
    this.value=this.value.replace(/\D/g,'').slice(0,2);
    document.querySelectorAll('#coeffChips .chip').forEach(x=>x.classList.remove('active'));
  });

  /* ---------- Opzioni avanzate: pill toggle Manuale/Stima ---------- */
  function refreshAccMode(){
    const manualActive = document.getElementById('pillManuale').classList.contains('active');
    if(manualActive){ show('accManual'); hide('accStima'); }
    else { hide('accManual'); show('accStima'); }
  }
  document.getElementById('pillManuale').addEventListener('click',function(){
    this.classList.add('active'); document.getElementById('pillStima').classList.remove('active'); refreshAccMode();
  });
  document.getElementById('pillStima').addEventListener('click',function(){
    this.classList.add('active'); document.getElementById('pillManuale').classList.remove('active'); refreshAccMode();
  });

  /* ---------- Toggle vista accanto ai tab ---------- */
  const viewLabel = document.getElementById('viewLabel');
  document.getElementById('simpToggle').addEventListener('change',function(){
    viewLabel.innerHTML = '<b>'+(this.checked ? 'Semplificata' : 'Dettagliata')+'</b>';
    if(document.getElementById('resultsBox').style.display!=='none') buildExplanation();
  });

  /* ---------- Copy buttons (desktop) ---------- */
  document.addEventListener('click',async (e)=>{
    const btn=e.target.closest('.copy-btn'); if(!btn) return;
    const box=btn.closest('.section');
    const content=box.querySelector('.copy-content')||box;
    const text=content.innerText.replace(/^Copia\s*/,'').trim();
    try{ await navigator.clipboard.writeText(text); const old=btn.textContent; btn.textContent='Copiato!'; setTimeout(()=>btn.textContent=old,1200); }
    catch(err){ const old=btn.textContent; btn.textContent='Errore'; setTimeout(()=>btn.textContent=old,1200); }
  });

  /* ---------- Calcolo ---------- */
  function compute(){
    const incassato=val('incassato');
    let coeffPerc=document.getElementById('coeffCustom').value?parseInt(document.getElementById('coeffCustom').value,10):coeffFromChips;
    if(!coeffPerc||coeffPerc<=0) coeffPerc=78;
    const coeff=coeffPerc/100;

    const impRate=parseFloat(document.getElementById('imposta').value)||0.05;
    const aliqInps=parseNum(document.getElementById('aliqInps').value)/100||0.2607;
    const accImpPerc=parseNum(document.getElementById('accImpPerc').value)/100||1.00;
    const accInpsPerc=parseNum(document.getElementById('accInpsPerc').value)/100||0.80;
    const deducibili=val('deducibili');

    // acconti anno precedente
    let accImpPrev=0, accInpsPrev=0;
    const manualActive = document.getElementById('pillManuale').classList.contains('active');
    if(manualActive){
      accImpPrev=val('accImpPrev'); accInpsPrev=val('accInpsPrev');
    }else{
      const inc24=val('incasso2024');
      const coeff24=(parseNum(document.getElementById('coeff2024').value)||78)/100;
      const imp24rate=parseFloat(document.getElementById('imp2024').value)||0.05;
      const inps24rate=parseNum(document.getElementById('inps2024').value)/100||0.2607;
      const impon24=inc24*coeff24;
      const inps24=impon24*inps24rate;
      const imp24=impon24*imp24rate;
      accImpPrev=imp24*1.00; accInpsPrev=inps24*0.80;
    }

    const err=document.getElementById('err');
    if(incassato<=0){err.style.display='block';err.textContent='Inserisci un incassato annuo valido (> 0).';hide('resultsBox');return}
    err.style.display='none';

    const imponibileForf=incassato*coeff;
    const inps=imponibileForf*aliqInps;

    const imponibileFisc=Math.max(0,imponibileForf-Math.max(0,deducibili));
    const imposta=imponibileFisc*impRate;

    let saldoImposta=Math.max(0,imposta-Math.max(0,accImpPrev));
    let saldoInps=Math.max(0,inps-Math.max(0,accInpsPrev));
    const saldoTotale=saldoImposta+saldoInps;

    const creditoImp=Math.max(0,accImpPrev-imposta);
    const creditoInps=Math.max(0,accInpsPrev-inps);

    const accImpBase=imposta*accImpPerc;
    const accInpsBase=inps*accInpsPerc;

    const accImpTot=Math.max(0,accImpBase-creditoImp);
    const accInpsTot=Math.max(0,accInpsBase-creditoInps);

    const creditoImpResid=Math.max(0,creditoImp-accImpBase);
    const creditoInpsResid=Math.max(0,creditoInps-accInpsBase);

    const accImp1=accImpTot*0.50, accImp2=accImpTot*0.50;
    const accInps1=accInpsTot*0.50, accInps2=accInpsTot*0.50;

    const accontiTot=accImpTot+accInpsTot;
    const giugnoTot=saldoTotale+accImp1+accInps1;
    const novTot=accImp2+accInps2;
    const totale=saldoTotale+accontiTot;

    /* KPI */
    setHTML('outImponibile',euro(imponibileForf));
    setHTML('outInps',euro(inps));
    setHTML('outImposta',euro(imposta));
    setHTML('outSaldo',euro(saldoTotale));
    setHTML('outAcconti',euro(accontiTot));
    setHTML('outTotale',euro(totale));

    /* Note soglia */
    let w='';
    if(incassato>100000) w='<div class="muted"><b>Attenzione:</b> oltre 100.000â‚¬ â†’ uscita <b>immediata</b> dal forfettario nellâ€™anno.</div>';
    else if(incassato>85000) w='<div class="muted"><b>Nota:</b> oltre 85.000â‚¬ â†’ uscita dal forfettario <b>dallâ€™anno successivo</b>.</div>';
    setHTML('warnings',w);

    /* Dettaglio tab 2 + (totale riga in fondo pronto se servirÃ ) */
    let det='';
    det+=tr('<b>Incassato</b>',euro(incassato));
    det+=tr('Coefficiente', (coeffPerc)+'%');
    det+=tr('<b>Imponibile</b>',euro(imponibileForf));
    det+=tr('Deducibili per imposta','âˆ’ '+euro(deducibili));
    det+=tr('Base per imposta',euro(imponibileFisc));
    det+=tr('Aliquota imposta',Math.round(impRate*100)+'%');
    det+=tr('<b>Imposta calcolata</b>',euro(imposta));
    det+=tr('Acconti imposta anno precedente','âˆ’ '+euro(accImpPrev));
    det+=tr('<b>Saldo imposta</b>','<b>'+euro(saldoImposta)+'</b>');
    det+=tr('Contributi INPS ('+(aliqInps*100).toFixed(2)+'%)',euro(inps));
    det+=tr('Acconti INPS anno precedente','âˆ’ '+euro(accInpsPrev));
    det+=tr('<b>Saldo INPS</b>','<b>'+euro(saldoInps)+'</b>');
    det+=tr('<b>Saldo totale</b>','<b>'+euro(saldoTotale)+'</b>');
    if(creditoImp>0||creditoInps>0){
      det+='<tr><th colspan="2">Crediti che riducono i nuovi acconti</th></tr>';
      if(creditoImp>0)  det+=tr('Credito imposta utilizzato','âˆ’ '+euro(creditoImp));
      if(creditoInps>0) det+=tr('Credito INPS utilizzato','âˆ’ '+euro(creditoInps));
    }
    det+='<tr><th colspan="2">Acconti per lâ€™anno prossimo (netti dei crediti)</th></tr>';
    det+=tr('Imposta â€“ totale acconti ('+(accImpPerc*100).toFixed(0)+'%)',euro(accImpTot));
    det+=tr('INPS â€“ totale acconti ('+(accInpsPerc*100).toFixed(0)+'%)',euro(accInpsTot));
    det+=tr('Imposta â€“ 1Â° acconto (50%)',euro(accImp1));
    det+=tr('Imposta â€“ 2Â° acconto (50%)',euro(accImp2));
    det+=tr('INPS â€“ 1Â° acconto (40%)',euro(accInps1));
    det+=tr('INPS â€“ 2Â° acconto (40%)',euro(accInps2));
    if(creditoImpResid>0||creditoInpsResid>0){
      det+='<tr><th colspan="2">Credito residuo da riportare</th></tr>';
      if(creditoImpResid>0)  det+=tr('Credito imposta residuo',euro(creditoImpResid));
      if(creditoInpsResid>0) det+=tr('Credito INPS residuo',euro(creditoInpsResid));
    }
    setHTML('tblDettaglio',det);
    setHTML('detTot','');

    /* Scadenze tab 3 + riga Totale */
    cacheGiugno=giugnoTot; cacheNov=novTot;
    let sc=''; 
    sc+=tr('<span class="badge-month" title="Saldo + 1Â° acconti">Giugno</span> â€” Saldo (imp.+INPS) + 1Â° acconti',euro(giugnoTot),true);
    sc+=tr('<span class="badge-month" title="2Â° acconti">Novembre</span> â€” 2Â° acconti',euro(novTot),true);
    setHTML('tblScadenze',sc);
    setHTML('scadTot',euro(giugnoTot+novTot));

    /* Rate (se lâ€™accordion Ã¨ aperto) */
    if(document.getElementById('ratesAcc').open) buildRate();

    /* Stato per spiegazione e annuncio aria-live */
    lastState={incassato,coeffPerc,coeff,impRate,aliqInps,imponibileForf,inps,deducibili,imponibileFisc,imposta,
      accImpPrev,accInpsPrev,saldoImposta,saldoInps,saldoTotale,accImpTot,accInpsTot,accImp1,accImp2,accInps1,accInps2,
      giugnoTot,novTot,totale,creditoImp,creditoInps,creditoImpResid,creditoInpsResid};
    buildExplanation(); show('resultsBox');

    document.getElementById('live').textContent =
      `Risultati aggiornati: saldo ${euro(saldoTotale)}, acconti ${euro(accontiTot)}, totale ${euro(totale)}.`;

    moveInkbar(document.querySelector('.tab-btn.active')); // allinea underline

    // Aggiorna intestazione stampa (data/ora locale)
    const now = new Date();
    document.getElementById('printDateTime').textContent =
      now.toLocaleString('it-IT', { dateStyle:'medium', timeStyle:'short' });
  }

  /* ---------- Spiegazione (tab 1) ---------- */
  function wrapSection(title, inner, cls){
    return `<div class="section ${cls||''}">
      <button type="button" class="copy-btn" title="Copia" aria-label="Copia">Copia</button>
      <div class="copy-content">
        ${title?`<h3>${title}</h3>`:''}
        ${inner}
      </div>
    </div>`;
  }
  function P(t){ return `<p class="line">${t}</p>` }

  function buildExplanation(){
    if(!lastState) return;
    const s=lastState, simple=document.getElementById('simpToggle').checked;

    const inc=euro(s.incassato), impForf=euro(s.imponibileForf), inps=euro(s.inps), imposta=euro(s.imposta),
          baseImp=euro(s.imponibileFisc), saldoINPS=euro(s.saldoInps), saldoIMP=euro(s.saldoImposta),
          saldoTot=euro(s.saldoTotale), giu=euro(s.giugnoTot), nov=euro(s.novTot), tot=euro(s.totale),
          accINPStot=euro(s.accInpsTot), accIMPtot=euro(s.accImpTot),
          accINPS1=euro(s.accInps1), accIMP1=euro(s.accImp1);

    let html='';
    if(!simple){
      let intro=P(`Hai incassato <span class="mark-y"><b>${inc}</b></span>. Con coefficiente <span class="mark-y"><b>${s.coeffPerc}%</b></span> il reddito imponibile diventa:`)+P(`<span class="mono">${inc} Ã— ${s.coeffPerc}% = ${impForf}</span>`);
      html+=wrapSection('Imponibile',intro,'');

      let inpsTxt=P(`Aliquota <b>${(s.aliqInps*100).toFixed(2)}%</b> sullâ€™imponibile: <span class="mono">${impForf} Ã— ${(s.aliqInps*100).toFixed(2)}% = ${inps}</span>.`);
      if(s.accInpsPrev>0){
        inpsTxt+=P(`Acconti INPS giÃ  versati: <span class="mark-b"><b>${euro(s.accInpsPrev)}</b></span>. Quindi saldo: <span class="mono">${inps} âˆ’ ${euro(s.accInpsPrev)} = ${saldoINPS}</span>.`);
        if(s.creditoInps>0) inpsTxt+=P(`Gli acconti superano il dovuto: saldo INPS <b>0 â‚¬</b> e nasce un <b>credito INPS</b> di <span class="mark-b"><b>${euro(s.creditoInps)}</b></span>, usato per ridurre i nuovi acconti.`);
        if(s.creditoInpsResid>0) inpsTxt+=P(`Resta un <b>credito INPS residuo</b> di <span class="mark-b"><b>${euro(s.creditoInpsResid)}</b></span> da riportare.`);
      }
      inpsTxt+=P(`ðŸ‘‰ <span class="mark-b"><b>Saldo INPS</b> da versare ora: <b>${saldoINPS}</b></span>.`);
      html+=wrapSection('Contributi INPS',inpsTxt,'inps');

      let impTxt='';
      if(s.deducibili>0){ impTxt+=P(`Prima togliamo i <b>contributi deducibili</b> (<span class="mark-g">${euro(s.deducibili)}</span>): <span class="mono">${impForf} âˆ’ ${euro(s.deducibili)} = ${baseImp}</span>.`); }
      else { impTxt+=P(`Base imposta: <b>${impForf}</b> (nessuna deduzione).`); }
      impTxt+=P(`Aliquota <b>${Math.round(s.impRate*100)}%</b>: <span class="mono">${baseImp} Ã— ${Math.round(s.impRate*100)}% = ${imposta}</span>.`);
      if(s.accImpPrev>0){
        impTxt+=P(`Acconti imposta giÃ  versati: <span class="mark-g"><b>${euro(s.accImpPrev)}</b></span>. Quindi saldo: <span class="mono">${imposta} âˆ’ ${euro(s.accImpPrev)} = ${saldoIMP}</span>.`);
        if(s.creditoImp>0) impTxt+=P(`Gli acconti superano il dovuto: saldo imposta <b>0 â‚¬</b> e nasce un <b>credito imposta</b> di <span class="mark-g"><b>${euro(s.creditoImp)}</b></span>, usato per ridurre i nuovi acconti.`);
        if(s.creditoImpResid>0) impTxt+=P(`Resta un <b>credito imposta residuo</b> di <span class="mark-g"><b>${euro(s.creditoImpResid)}</b></span> da riportare.`);
      }
      impTxt+=P(`ðŸ‘‰ <span class="mark-g"><b>Saldo imposta</b> da versare ora: <b>${saldoIMP}</b></span>.`);
      html+=wrapSection('Imposta sostitutiva',impTxt,'imp');

      html+=wrapSection('Totale saldi ora', P(`<span class="mono"><span class="mark-b">${saldoINPS} INPS</span> + <span class="mark-g">${saldoIMP} imposta</span> = <b>${saldoTot}</b></span>.`),'');
      html+=wrapSection('Acconti per lâ€™anno successivo', P(`Calcolati sul dovuto di questâ€™anno (metodo storico), al netto dei crediti: <span class="mark-g">imposta ${accIMPtot}</span> (50% giugno, 50% novembre) e <span class="mark-b">INPS ${accINPStot}</span> (40% giugno, 40% novembre).`),'');
      html+=wrapSection('Scadenze', P(`<b>Giugno</b> = saldi (<span class="mark-b">${saldoINPS}</span> + <span class="mark-g">${saldoIMP}</span>) + primi acconti (<span class="mark-g">${accIMP1} imposta</span> + <span class="mark-b">${accINPS1} INPS</span>) = <span class="mark-y"><b>${giu}</b></span>.`) + P(`<b>Novembre</b> = secondi acconti (imposta + INPS) = <span class="mark-y"><b>${nov}</b></span>.`) ,'');
      html+=wrapSection('Totale anno e incidenza', P(`<span class="mono">${giu} + ${nov} = ${tot}</span>. Incidenza: saldi <b>${perc(s.saldoTotale,s.incassato)}</b>; acconti <b>${perc(s.accImpTot+s.accInpsTot,s.incassato)}</b>; totale <b>${perc(s.totale,s.incassato)}</b>.`),'');
    } else {
      let intro=P(`Hai incassato <span class="mark-y"><b>${inc}</b></span> nellâ€™anno. Con coefficiente <b>${s.coeffPerc}%</b> il reddito imponibile diventa:`)+P(`<span class="mono">${inc} Ã— ${s.coeffPerc}% = ${impForf}</span>`);
      html+=wrapSection('Imponibile',intro,'');

      let inpsS=P(`Si calcolano sullâ€™imponibile: <span class="mono">${impForf} Ã— ${(s.aliqInps*100).toFixed(2)}% = ${inps}</span>.`);
      if(s.accInpsPrev>0){ inpsS+=P(`Avendo giÃ  versato <b>${euro(s.accInpsPrev)}</b>: <span class="mono">${inps} âˆ’ ${euro(s.accInpsPrev)} = ${saldoINPS}</span>.`); }
      else { inpsS+=P(`Saldo INPS: <b>${saldoINPS}</b>.`); }
      html+=wrapSection('Contributi INPS',inpsS,'inps');

      let impS='';
      if(s.deducibili>0){ impS+=P(`Prima si sottraggono i contributi deducibili (<b>${euro(s.deducibili)}</b>): <span class="mono">${impForf} âˆ’ ${euro(s.deducibili)} = ${baseImp}</span>.`); }
      else { impS+=P(`Base imposta: <b>${baseImp}</b>.`); }
      impS+=P(`Su questo si applica il <b>${Math.round(s.impRate*100)}%</b>: <span class="mono">${baseImp} Ã— ${Math.round(s.impRate*100)}% = ${imposta}</span>.`);
      if(s.accImpPrev>0){ impS+=P(`Tolti gli acconti giÃ  pagati (<b>${euro(s.accImpPrev)}</b>): <span class="mono">${imposta} âˆ’ ${euro(s.accImpPrev)} = ${saldoIMP}</span>.`); }
      else { impS+=P(`Saldo imposta: <b>${saldoIMP}</b>.`); }
      html+=wrapSection('Imposta sostitutiva',impS,'imp');

      html+=wrapSection('Totale saldi ora', P(`<span class="mono">${saldoINPS} (INPS) + ${saldoIMP} (imposta) = <b>${saldoTot}</b></span>.`),'');
      html+=wrapSection('Acconti per lâ€™anno successivo', P(`INPS: <b>${accINPStot}</b> (2 rate). â€¢ Imposta: <b>${accIMPtot}</b> (2 rate).`),'');
      html+=wrapSection('Scadenze', P(`<b>Giugno</b>: saldi + primi acconti = <b>${giu}</b>. <b>Novembre</b>: secondi acconti = <b>${nov}</b>.`),'');
    }

    setHTML('explanation', html);
  }

  /* ---------- Rate ---------- */
  function buildRate(){
    const totGiu=cacheGiugno, quota=totGiu/5;
    let tbody='', sumInt=0, sumTotGiu=0;
    for(let i=0;i<5;i++){
      const p=RATE_PERC[i]/100, interesse=totGiu*p, rata=quota+interesse;
      sumInt+=interesse; sumTotGiu+=rata;
      tbody+='<tr><td>'+(i+1)+'</td><td>'+RATE_DATE[i]+'</td><td>'+euro(quota)+'</td><td>'+RATE_PERC[i].toFixed(2)+'%</td><td>'+euro(interesse)+'</td><td><b>'+euro(rata)+'</b></td></tr>';
    }
    tbody+='<tr><td>6</td><td><b>Novembre â€” 2Â° acconti</b></td><td>'+euro(cacheNov)+'</td><td>â€”</td><td>â€”</td><td><b>'+euro(cacheNov)+'</b></td></tr>';
    setHTML('rateBody',tbody); setHTML('rateIntTot',euro(sumInt)); setHTML('rateTot',euro(sumTotGiu)); setHTML('rateTotAll',euro(sumTotGiu+cacheNov));
  }

  /* ---------- Stampa PDF (solo risultati) ---------- */
  document.getElementById('btnPrint').addEventListener('click',()=>{
    const rb=document.getElementById('resultsBox');
    if(rb.style.display==='none'){ alert('Prima clicca su CALCOLA per generare i risultati da stampare.'); return; }
    // aggiorna data/ora intestazione stampa
    const now = new Date();
    document.getElementById('printDateTime').textContent =
      now.toLocaleString('it-IT', { dateStyle:'medium', timeStyle:'short' });
    window.print();
  });

  /* ---------- Bind iniziali ---------- */
  document.addEventListener('DOMContentLoaded',function(){
    // 78% giÃ  attivo e inkbar iniziale
    document.querySelector('#coeffChips .chip[data-coeff="78"]').classList.add('active');
    coeffFromChips=78;
    const firstTab=document.querySelector('.tab-btn.active'); if(firstTab) setTimeout(()=>{const r=firstTab.getBoundingClientRect(); document.getElementById('inkbar').style.width=r.width+'px'; document.getElementById('inkbar').style.left=firstTab.offsetLeft+'px';},0);

    document.getElementById('btnCalc').addEventListener('click',compute);
    ['incassato','deducibili','accImpPrev','accInpsPrev','incasso2024','coeff2024','aliqInps','accImpPerc','accInpsPerc','inps2024']
      .forEach(id=>{const el=document.getElementById(id);if(!el)return;el.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();compute();}})});
    document.getElementById('btnReset').addEventListener('click',function(){
      ['incassato','deducibili','accImpPrev','accInpsPrev','incasso2024'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
      document.getElementById('coeffCustom').value='';
      document.querySelectorAll('#coeffChips .chip').forEach(x=>x.classList.remove('active'));
      document.querySelector('#coeffChips .chip[data-coeff="78"]').classList.add('active');
      coeffFromChips=78;
      document.getElementById('imposta').value='0.05';
      document.getElementById('aliqInps').value='26,07'; document.getElementById('accImpPerc').value='100'; document.getElementById('accInpsPerc').value='80';
      document.getElementById('ratesAcc').open=false;
      document.getElementById('simpToggle').checked=false; document.getElementById('viewLabel').innerHTML='<b>Dettagliata</b>';
      hide('resultsBox'); window.scrollTo({top:0,behavior:'smooth'});
      const first=document.querySelector('.tab-btn[data-tab="tab1"]'); if(first){first.click();}
    });

    // Aprendo/chiudendo lâ€™accordion rate, rigenera tabella se giÃ  calcolato
    document.getElementById('ratesAcc').addEventListener('toggle',()=>{
      if(document.getElementById('ratesAcc').open && lastState){ buildRate(); }
    });
  });
})();
</script>
</body>
</html>
