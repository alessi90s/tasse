<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Simulatore Rate ENPAP – Interessi progressivi (k × 0,375%)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0b0c10;
      --card:#101218;
      --muted:#9aa2b1;
      --txt:#e9edf5;
      --accent:#7dd3fc;
      --border:#1e2230;
      --ok:#86efac;
      --warn:#fde68a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--txt);
      font: 15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    header{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:16px;gap:16px}
    header h1{margin:0;font-size:20px;letter-spacing:.2px}
    header .tag{font-size:12px;color:var(--muted)}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:14px; padding:16px;
      box-shadow:0 1px 0 rgba(255,255,255,.02), 0 8px 40px rgba(0,0,0,.35);
    }
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:800px){ .grid{grid-template-columns:1fr} }
    label{display:block;font-weight:600;margin:4px 0 6px}
    .hl{background:linear-gradient(transparent 60%, rgba(125,211,252,.25) 0);}
    input,select,button{
      width:100%; padding:12px 12px; border-radius:10px; border:1px solid var(--border);
      background:#0f1320; color:var(--txt); outline:none;
    }
    input::placeholder{color:#667085}
    .row{display:grid;grid-template-columns:repeat(4,1fr); gap:12px}
    @media (max-width:900px){ .row{grid-template-columns:1fr 1fr} }
    @media (max-width:560px){ .row{grid-template-columns:1fr} }
    .btn{
      background:#0b132d; border:1px solid #1f2a44; font-weight:700; cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .btn.primary{background:linear-gradient(180deg,#112042,#0b132d); border-color:#223055}
    .btn.ghost{background:transparent}
    .muted{color:var(--muted);font-size:13px}
    .note{font-size:13px;color:#cfeaff}
    .rule{
      margin-top:10px; padding:10px 12px; border:1px dashed #2a3246; border-radius:10px; background:#0c121f;
      color:#cfeaff; font-size:13px;
    }
    table{width:100%; border-collapse:collapse; margin-top:16px; overflow:auto}
    thead th{
      text-align:right; font-size:13px; color:#b7c0d4; font-weight:700; padding:10px;
      border-bottom:1px solid var(--border); background:#0f1524;
      position:sticky; top:0; z-index:1;
    }
    thead th:first-child, tbody td:first-child{ text-align:center; }
    thead th:nth-child(2), tbody td:nth-child(2){ text-align:center; }
    tbody td{
      text-align:right; padding:10px; border-bottom:1px solid #171b28; font-variant-numeric:tabular-nums;
    }
    tfoot td{padding:12px 10px; font-weight:700; background:#0f1524; border-top:1px solid var(--border)}
    .kpi{display:flex; gap:12px; flex-wrap:wrap; margin-top:12px}
    .pill{
      background:#0f1524; border:1px solid var(--border); border-radius:12px; padding:10px 12px; min-width:180px;
    }
    .pill strong{display:block;font-size:18px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .sep{height:1px;background:var(--border);margin:16px 0}
    .switch{display:flex;align-items:center;gap:8px;margin-top:8px}
    .inline{display:flex;gap:10px;align-items:end;flex-wrap:wrap}
    .small{font-size:12px}
    .ok{color:var(--ok)} .warn{color:var(--warn)}
    .center{display:flex;justify-content:center}
    .footnote{margin-top:8px;color:#aeb7c8;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Simulatore rate ENPAP</h1>
        <div class="tag">Interessi progressivi: <span class="hl">k × 0,375%</span> sul <b>residuo prima della rata</b></div>
      </div>
      <div class="right">
        <button class="btn ghost small" id="btnReset">Reset</button>
      </div>
    </header>

    <section class="card">
      <div class="grid">
        <div>
          <label for="importo">Importo da rateizzare (€)</label>
          <input id="importo" inputmode="decimal" placeholder="es. 1.041,00" />
        </div>
        <div>
          <label for="rate">Numero di rate (mesi)</label>
          <input id="rate" type="number" min="1" max="12" step="1" value="5" />
        </div>
        <div>
          <label for="tasso">Tasso mensile (%)</label>
          <input id="tasso" inputmode="decimal" value="0,375" />
          <div class="muted small">Di default 0,375%</div>
        </div>
        <div>
          <label for="primaData">Prima scadenza</label>
          <input id="primaData" type="date" />
          <div class="muted small">Data entro cui si paga la 1ª rata</div>
        </div>
      </div>

      <div class="switch">
        <input id="progressivo" type="checkbox" checked />
        <label for="progressivo" class="small">Applica regola ENPAP: interessi progressivi (<b>k × 0,375%</b>)</label>
      </div>

      <div class="rule">
        Regola interessi: 1° mese <b>0,375%</b>, 2° mese <b>0,750%</b>, 3° mese <b>1,125%</b>, ecc. (moltiplicatore <b>k</b> in base al numero di rata).
      </div>

      <div class="actions">
        <button class="btn primary" id="btnCalcola">Calcola</button>
        <button class="btn" id="btnCopia">Copia elenco per chat</button>
        <button class="btn" id="btnCSV">Esporta CSV</button>
      </div>

      <div class="kpi" id="kpi" style="display:none">
        <div class="pill"><div class="muted small">Totale capitale</div><strong id="kCap"></strong></div>
        <div class="pill"><div class="muted small">Totale interessi</div><strong id="kInt"></strong></div>
        <div class="pill"><div class="muted small">Totale complessivo</div><strong id="kTot"></strong></div>
      </div>

      <div class="sep"></div>

      <div id="out" style="display:none;overflow:auto">
        <table id="tbl">
          <thead>
            <tr>
              <th>Rata</th>
              <th>Scadenza</th>
              <th>Residuo prima rata (€)</th>
              <th>Interessi (€)</th>
              <th>Quota capitale (€)</th>
              <th>Totale rata (€)</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="3">Totali</td>
              <td id="tfInt">0,00</td>
              <td id="tfCap">0,00</td>
              <td id="tfTot">0,00</td>
            </tr>
          </tfoot>
        </table>
        <div class="footnote">Le quote capitale sono uguali (l’ultima è aggiustata per chiudere i centesimi). Interessi calcolati sul residuo prima della rata.</div>
      </div>
    </section>
  </div>

  <script>
    // --- Utils formattazione & parsing ---
    const fmt = new Intl.NumberFormat('it-IT', { minimumFractionDigits:2, maximumFractionDigits:2 });
    const euro = n => fmt.format(n);
    function parseEuro(str){
      if(typeof str !== 'string') return Number(str)||0;
      // remove dots thousands, replace comma decimal
      const s = str.trim().replace(/\./g,'').replace(',', '.');
      const n = Number(s);
      return isNaN(n) ? 0 : n;
    }
    function addMonths(date, months){
      const d = new Date(date.getTime());
      const day = d.getDate();
      d.setMonth(d.getMonth() + months);
      // fix month overflow (e.g., 31 → adjust)
      if (d.getDate() !== day) d.setDate(0);
      return d;
    }
    function toISODateInput(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }
    function itDate(d){
      const day = String(d.getDate()).padStart(2,'0');
      const mo = String(d.getMonth()+1).padStart(2,'0');
      const y = d.getFullYear();
      return `${day}/${mo}/${y}`;
    }
    function round2(n){ return Math.round((n + Number.EPSILON) * 100)/100; }

    // --- Stato/elementi ---
    const elImporto = document.getElementById('importo');
    const elRate = document.getElementById('rate');
    const elTasso = document.getElementById('tasso');
    const elPrimaData = document.getElementById('primaData');
    const elProg = document.getElementById('progressivo');

    const btnCalcola = document.getElementById('btnCalcola');
    const btnCopia = document.getElementById('btnCopia');
    const btnCSV = document.getElementById('btnCSV');
    const btnReset = document.getElementById('btnReset');

    const outWrap = document.getElementById('out');
    const tbody = document.querySelector('#tbl tbody');
    const tfInt = document.getElementById('tfInt');
    const tfCap = document.getElementById('tfCap');
    const tfTot = document.getElementById('tfTot');
    const kpi = document.getElementById('kpi');
    const kCap = document.getElementById('kCap');
    const kInt = document.getElementById('kInt');
    const kTot = document.getElementById('kTot');

    // --- Default prima scadenza: prossimo 1° del mese (o fra 30 giorni se oggi è fine mese) ---
    (function initFirstDate(){
      const today = new Date();
      const next = new Date(today.getFullYear(), today.getMonth()+1, 1);
      elPrimaData.value = toISODateInput(next);
    })();

    // --- Persistenza semplice ---
    function saveState(){
      const state = {
        importo: elImporto.value,
        rate: elRate.value,
        tasso: elTasso.value,
        primaData: elPrimaData.value,
        progressivo: elProg.checked
      };
      localStorage.setItem('enpapSimState', JSON.stringify(state));
    }
    function loadState(){
      const raw = localStorage.getItem('enpapSimState');
      if(!raw) return;
      try{
        const s = JSON.parse(raw);
        if(s.importo != null) elImporto.value = s.importo;
        if(s.rate != null) elRate.value = s.rate;
        if(s.tasso != null) elTasso.value = s.tasso;
        if(s.primaData) elPrimaData.value = s.primaData;
        if(typeof s.progressivo === 'boolean') elProg.checked = s.progressivo;
      }catch(e){}
    }
    loadState();

    // --- Calcolo ---
    function calcola(){
      const capitale = parseEuro(elImporto.value);
      const n = Math.max(1, Math.min(120, parseInt(elRate.value || '1',10)));
      const tassoPerc = parseEuro(elTasso.value); // es. 0,375
      const tasso = (tassoPerc || 0) / 100;
      const firstDateStr = elPrimaData.value;
      const firstDate = firstDateStr ? new Date(firstDateStr + 'T00:00:00') : new Date();
      const progressivo = elProg.checked;

      if(capitale <= 0 || !isFinite(capitale)){
        alert('Inserisci un importo valido.');
        return;
      }

      // Quote capitale uguali (aggiustiamo l’ultima per chiudere i centesimi)
      const base = Math.floor((capitale / n) * 100) / 100; // tronco a 2 dec
      const quote = Array.from({length:n}, (_,i)=> base);
      const sommaBase = round2(base * n);
      const diff = round2(capitale - sommaBase);
      // distribuisci la differenza di centesimi sull’ultima rata
      quote[n-1] = round2(quote[n-1] + diff);

      let residuo = round2(capitale);
      const righe = [];

      for(let k=1; k<=n; k++){
        const fattore = progressivo ? k : 1; // k × tasso se progressivo
        const interessi = round2(residuo * tasso * fattore);
        const cap = quote[k-1];
        const totaleRata = round2(cap + interessi);
        const data = addMonths(firstDate, k-1);

        righe.push({
          rata: k,
          scadenza: itDate(data),
          residuoPrima: residuo,
          interessi,
          capitale: cap,
          totale: totaleRata
        });

        residuo = round2(residuo - cap);
      }

      render(righe);
      saveState();
    }

    function render(rows){
      tbody.innerHTML = '';
      let totInt = 0, totCap = 0, totAll = 0;

      for(const r of rows){
        totInt += r.interessi;
        totCap += r.capitale;
        totAll += r.totale;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.rata}ª</td>
          <td>${r.scadenza}</td>
          <td>${euro(r.residuoPrima)}</td>
          <td>${euro(r.interessi)}</td>
          <td>${euro(r.capitale)}</td>
          <td><strong>${euro(r.totale)}</strong></td>
        `;
        tbody.appendChild(tr);
      }

      tfInt.textContent = euro(round2(totInt));
      tfCap.textContent = euro(round2(totCap));
      tfTot.textContent = euro(round2(totAll));

      kInt.textContent = euro(round2(totInt));
      kCap.textContent = euro(round2(totCap));
      kTot.textContent = euro(round2(totAll));

      kpi.style.display = 'flex';
      outWrap.style.display = 'block';
    }

    // --- Copia elenco per chat ---
    function copiaChat(){
      const rows = Array.from(tbody.querySelectorAll('tr')).map(tr=>{
        const tds = tr.querySelectorAll('td');
        return {
          rata: tds[0].textContent.trim(),
          data: tds[1].textContent.trim(),
          tot: tds[5].textContent.replace(/\s/g,'').trim(), // già formattato
          int: tds[3].textContent.replace(/\s/g,'').trim()
        };
      });
      if(!rows.length){
        alert('Calcola prima il piano.');
        return;
      }
      const lines = rows.map(r => `- ${r.rata} rata: ${r.tot} (interessi ${r.int}) — entro ${r.data}`);
      const txt = lines.join('\n');
      navigator.clipboard.writeText(txt).then(()=>{
        alert('Elenco copiato negli appunti ✅');
      },()=> alert('Impossibile copiare. Copia manualmente.'));
    }

    // --- Export CSV ---
    function exportCSV(){
      const rows = Array.from(tbody.querySelectorAll('tr')).map(tr=>{
        const tds = tr.querySelectorAll('td');
        return Array.from(tds).slice(0,6).map(td=> td.textContent.trim());
      });
      if(!rows.length){
        alert('Calcola prima il piano.');
        return;
      }
      const head = ["Rata","Scadenza","Residuo prima rata (€)","Interessi (€)","Quota capitale (€)","Totale rata (€)"];
      const all = [head, ...rows];
      const csv = all.map(r => r.map(cell => `"${cell.replace(/"/g,'""')}"`).join(';')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'piano-rate-enpap.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // --- Reset ---
    function resetAll(){
      localStorage.removeItem('enpapSimState');
      elImporto.value = '';
      elRate.value = '5';
      elTasso.value = '0,375';
      elProg.checked = true;
      // reset prima scadenza al prossimo 1°
      const today = new Date();
      const next = new Date(today.getFullYear(), today.getMonth()+1, 1);
      elPrimaData.value = toISODateInput(next);

      tbody.innerHTML = '';
      tfInt.textContent = tfCap.textContent = tfTot.textContent = '0,00';
      kInt.textContent = kCap.textContent = kTot.textContent = '0,00';
      kpi.style.display = 'none';
      outWrap.style.display = 'none';
    }

    // --- Eventi ---
    btnCalcola.addEventListener('click', calcola);
    btnCopia.addEventListener('click', copiaChat);
    btnCSV.addEventListener('click', exportCSV);
    btnReset.addEventListener('click', resetAll);

    // Enter per calcolare
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        const target = e.target;
        if(['INPUT','SELECT'].includes(target.tagName)){
          e.preventDefault();
          calcola();
        }
      }
    });

    // Autocalcolo se già abbiamo stato salvato
    window.addEventListener('load', ()=>{
      // auto-calcola se importo presente
      if(elImporto.value.trim()){
        calcola();
      }
    });
  </script>
</body>
</html>
