<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Simulatore Rate ENPAP – interessi per mesi trascorsi dalla scadenza</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0b0c10; --card:#101218; --muted:#9aa2b1; --txt:#e9edf5;
      --border:#1e2230; --ok:#86efac; --okbg:#0f2a19; --warn:#fca5a5; --warnbg:#3b0d0d;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    header{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:16px;gap:12px}
    h1{margin:0;font-size:20px} .tag{font-size:12px;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 1px 0 rgba(255,255,255,.02),0 8px 40px rgba(0,0,0,.35)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px} @media(max-width:900px){.grid{grid-template-columns:1fr}}
    label{display:block;font-weight:600;margin:4px 0 6px}
    input,button{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background:#0f1320;color:#e9edf5}
    .btn{cursor:pointer;font-weight:700;background:#0b132d;border:1px solid #1f2a44} .btn:hover{filter:brightness(1.08)}
    .primary{background:linear-gradient(180deg,#112042,#0b132d);border-color:#223055}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    thead th{position:sticky;top:0;background:#0f1524;border-bottom:1px solid var(--border);padding:10px;font-size:13px;color:#b7c0d4;text-align:right}
    thead th:first-child,tbody td:first-child{text-align:center} thead th:nth-child(2),tbody td:nth-child(2){text-align:center}
    tbody td{padding:10px;border-bottom:1px solid #171b28;text-align:right;font-variant-numeric:tabular-nums}
    tfoot td{padding:12px;border-top:1px solid var(--border);background:#0f1524;font-weight:700}
    .kpi{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .pill{background:#0f1524;border:1px solid var(--border);border-radius:12px;padding:10px 12px;min-width:180px}
    .pill strong{display:block;font-size:18px}
    .banner{display:none;margin-top:12px;padding:12px;border-radius:10px;border:1px solid}
    .ok{display:block;border-color:#234b33;background:var(--okbg);color:var(--ok)}
    .warn{display:block;border-color:#6b1d1d;background:var(--warnbg);color:var(--warn)}
    .small{font-size:12px;color:#aeb7c8}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Simulatore rate ENPAP</h1>
        <div class="tag">Interessi = <b>mesi trascorsi dalla scadenza</b> × <b>tasso mensile</b> sul residuo prima della rata</div>
      </div>
      <button class="btn" id="btnReset">Reset</button>
    </header>

    <section class="card">
      <div class="grid">
        <div>
          <label for="importo">Importo da rateizzare (€)</label>
          <input id="importo" inputmode="decimal" placeholder="es. 1.041,00" />
        </div>
        <div>
          <label for="rate">Numero di rate (mesi)</label>
          <input id="rate" type="number" min="1" max="12" value="5" />
        </div>
        <div>
          <label for="tasso">Tasso mensile (%)</label>
          <input id="tasso" inputmode="decimal" value="0,375" />
          <div class="small">Default 0,375%</div>
        </div>
        <div>
          <label for="scadOrig">Scadenza originaria del saldo</label>
          <input id="scadOrig" type="date" value="2025-10-01" />
          <div class="small">Il 1° mese (stessa data) = interessi 0%</div>
        </div>
        <div>
          <label for="primaData">Data 1ª rata</label>
          <input id="primaData" type="date" value="2025-10-01" />
          <div class="small">Esempi: 01/10 = 0 mesi; 01/11 = 1 mese; 01/12 = 2 mesi…</div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn primary" id="btnCalcola">Calcola</button>
        <button class="btn" id="btnCopia">Copia elenco per chat</button>
        <button class="btn" id="btnCSV">Esporta CSV</button>
      </div>

      <div id="bannerOK" class="banner ok"></div>
      <div id="bannerWARN" class="banner warn"></div>

      <div class="kpi" id="kpi" style="display:none">
        <div class="pill"><div class="small">Totale capitale</div><strong id="kCap"></strong></div>
        <div class="pill"><div class="small">Totale interessi</div><strong id="kInt"></strong></div>
        <div class="pill"><div class="small">Totale complessivo</div><strong id="kTot"></strong></div>
      </div>

      <div id="out" style="display:none">
        <table id="tbl">
          <thead>
            <tr>
              <th>Rata</th>
              <th>Scadenza</th>
              <th>Residuo prima rata (€)</th>
              <th>Interessi (€)</th>
              <th>Quota capitale (€)</th>
              <th>Totale rata (€)</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="3">Totali</td>
              <td id="tfInt">0,00</td>
              <td id="tfCap">0,00</td>
              <td id="tfTot">0,00</td>
            </tr>
          </tfoot>
        </table>
        <div class="small">Quote capitale uguali (l’ultima è aggiustata per chiudere i centesimi). Interessi calcolati sul residuo prima della rata.</div>
      </div>
    </section>
  </div>

  <script>
    // --- utils ---
    const fmt = new Intl.NumberFormat('it-IT',{minimumFractionDigits:2,maximumFractionDigits:2});
    const euro = n => fmt.format(n);
    function parseEuro(s){ if(typeof s!=='string') return Number(s)||0; s=s.replace(/\./g,'').replace(',','.'); const n=Number(s); return isNaN(n)?0:n; }
    function addMonths(d,m){ const x=new Date(d.getTime()); const day=x.getDate(); x.setMonth(x.getMonth()+m); if(x.getDate()!==day) x.setDate(0); return x; }
    function addDays(d,days){ const x=new Date(d.getTime()); x.setDate(x.getDate()+days); return x; }
    function itDate(d){ return String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear(); }
    function round2(n){ return Math.round((n+Number.EPSILON)*100)/100; }
    // mesi trascorsi (floor) tra scadenza originaria e data rata
    function monthsElapsed(from,to){
      let m=(to.getFullYear()-from.getFullYear())*12 + (to.getMonth()-from.getMonth());
      if(to.getDate()<from.getDate()) m-=1; // se non si è ancora raggiunto il "giorno"
      return Math.max(0,m);
    }

    // --- dom ---
    const elImporto=document.getElementById('importo');
    const elRate=document.getElementById('rate');
    const elTasso=document.getElementById('tasso');
    const elScadOrig=document.getElementById('scadOrig');
    const elPrimaData=document.getElementById('primaData');
    const btnCalcola=document.getElementById('btnCalcola');
    const btnCopia=document.getElementById('btnCopia');
    const btnCSV=document.getElementById('btnCSV');
    const btnReset=document.getElementById('btnReset');
    const bannerOK=document.getElementById('bannerOK');
    const bannerWARN=document.getElementById('bannerWARN');
    const tbody=document.querySelector('#tbl tbody');
    const tfInt=document.getElementById('tfInt');
    const tfCap=document.getElementById('tfCap');
    const tfTot=document.getElementById('tfTot');
    const kpi=document.getElementById('kpi');
    const kCap=document.getElementById('kCap');
    const kInt=document.getElementById('kInt');
    const kTot=document.getElementById('kTot');
    const outWrap=document.getElementById('out');

    // stato
    function saveState(){
      localStorage.setItem('enpapSimState_v3', JSON.stringify({
        importo:elImporto.value, rate:elRate.value, tasso:elTasso.value,
        scadOrig:elScadOrig.value, primaData:elPrimaData.value
      }));
    }
    (function loadState(){
      const raw=localStorage.getItem('enpapSimState_v3'); if(!raw) return;
      try{ const s=JSON.parse(raw);
        if(s.importo!=null) elImporto.value=s.importo;
        if(s.rate!=null) elRate.value=s.rate;
        if(s.tasso!=null) elTasso.value=s.tasso;
        if(s.scadOrig) elScadOrig.value=s.scadOrig;
        if(s.primaData) elPrimaData.value=s.primaData;
      }catch{}
    })();

    function calcola(){
      const capitale=parseEuro(elImporto.value);
      const n=Math.max(1, Math.min(120, parseInt(elRate.value||'1',10)));
      const tasso=(parseEuro(elTasso.value)||0)/100;
      const scadOrig=new Date((elScadOrig.value||'2025-10-01')+'T00:00:00');
      const primaData=new Date((elPrimaData.value||'2025-10-01')+'T00:00:00');
      const limite150=addDays(scadOrig,150);

      if(!(capitale>0)){ alert('Inserisci un importo valido.'); return; }

      // quote capitale uguali, ultima aggiustata
      const base=Math.floor((capitale/n)*100)/100;
      const quote=Array.from({length:n},()=>base);
      const diff=round2(capitale - round2(base*n));
      quote[n-1]=round2(quote[n-1]+diff);

      let residuo=round2(capitale);
      const righe=[];
      for(let k=0;k<n;k++){
        const data = addMonths(primaData,k);
        const mesi = monthsElapsed(scadOrig, data); // <-- qui: mesi già trascorsi
        const interessi = round2(residuo * tasso * mesi);
        const cap = quote[k];
        const totale = round2(cap + interessi);
        righe.push({k:k+1, data, residuo, interessi, cap, totale});
        residuo = round2(residuo - cap);
      }
      render(righe, limite150);
      saveState();
    }

    function render(rows, limite150){
      tbody.innerHTML='';
      let ti=0, tc=0, tt=0;
      rows.forEach(r=>{
        ti+=r.interessi; tc+=r.cap; tt+=r.totale;
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${r.k}ª</td>
          <td>${itDate(r.data)}</td>
          <td>${euro(r.residuo)}</td>
          <td>${euro(r.interessi)}</td>
          <td>${euro(r.cap)}</td>
          <td><strong>${euro(r.totale)}</strong></td>`;
        tbody.appendChild(tr);
      });
      tfInt.textContent=euro(round2(ti));
      tfCap.textContent=euro(round2(tc));
      tfTot.textContent=euro(round2(tt));
      kInt.textContent=tfInt.textContent;
      kCap.textContent=tfCap.textContent;
      kTot.textContent=tfTot.textContent;
      kpi.style.display='flex';
      outWrap.style.display='block';

      // limite 150 giorni
      bannerOK.style.display='none'; bannerWARN.style.display='none';
      if(rows.length){
        const last=rows[rows.length-1].data;
        const over = last.getTime() - limite150.getTime();
        const lim = itDate(limite150), lastStr = itDate(last);
        if(over>0){
          const days = Math.ceil(over/86400000);
          bannerWARN.textContent = `⚠️ Attenzione: l’ultima rata (${lastStr}) supera il limite ENPAP di 150 giorni dalla scadenza originaria (limite: ${lim}). Sfori di ${days} giorno/i.`;
          bannerWARN.style.display='block';
        }else{
          bannerOK.textContent = `✅ OK: piano entro 150 giorni dalla scadenza originaria (limite: ${lim}). Ultima rata: ${lastStr}.`;
          bannerOK.style.display='block';
        }
      }
    }

    function copiaChat(){
      const rows=[...tbody.querySelectorAll('tr')].map(tr=>{
        const t=tr.querySelectorAll('td');
        return `- ${t[0].textContent.trim()} rata: ${t[5].textContent.trim()} (interessi ${t[3].textContent.trim()}) — entro ${t[1].textContent.trim()}`;
      });
      if(!rows.length){ alert('Calcola prima il piano.'); return; }
      navigator.clipboard.writeText(rows.join('\n')).then(()=>alert('Elenco copiato ✅'),()=>alert('Copia non riuscita'));
    }
    function exportCSV(){
      const head=['Rata','Scadenza','Residuo prima rata (€)','Interessi (€)','Quota capitale (€)','Totale rata (€)'];
      const rows=[...tbody.querySelectorAll('tr')].map(tr=>[...tr.querySelectorAll('td')].slice(0,6).map(td=>td.textContent.trim()));
      if(!rows.length){ alert('Calcola prima il piano.'); return; }
      const csv=[head,...rows].map(r=>r.map(c=>`"${c.replace(/"/g,'""')}"`).join(';')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='piano-rate-enpap.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function resetAll(){
      localStorage.removeItem('enpapSimState_v3');
      elImporto.value=''; elRate.value='5'; elTasso.value='0,375'; elScadOrig.value='2025-10-01'; elPrimaData.value='2025-10-01';
      document.getElementById('bannerOK').style.display='none'; document.getElementById('bannerWARN').style.display='none';
      tbody.innerHTML=''; document.getElementById('kpi').style.display='none'; document.getElementById('out').style.display='none';
    }

    btnCalcola.addEventListener('click',calcola);
    btnCopia.addEventListener('click',copiaChat);
    btnCSV.addEventListener('click',exportCSV);
    btnReset.addEventListener('click',resetAll);

    // Enter calcola
    document.addEventListener('keydown',e=>{ if(e.key==='Enter' && e.target.tagName==='INPUT'){ e.preventDefault(); calcola(); } });
  </script>
</body>
</html>
