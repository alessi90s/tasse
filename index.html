<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulatore Forfettario ‚Ä¢ Gestione Separata 2025</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#ecf2fc; --card:#fff; --text:#0f172a; --muted:#64748b; --border:#e6e6eb;
  --accent:#7586fe; --accent-dark:#5e6ff4; --ink:#fe795b;
  --pill:#ffd791; --pill-border:#f1c364; --pill-active:#f6c96a;
  --c1:#7586fe; --c2:#b491ff; --c3:#ffd791; --c4:#ff9696; --c5:#fe795b;
  --radius:14px; --shadow:0 14px 28px rgba(2,6,23,.08);
}
*{box-sizing:border-box}
html{font-size:17px}
body{
  margin:0;color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;background:var(--bg);
}
.wrap{max-width:860px;margin:32px auto;padding:0 14px}

/* Header */
header{text-align:center;margin-bottom:16px}
h1{margin:0;font-size:2rem;font-weight:900;letter-spacing:-.01em;line-height:1.2}
.hl{background:transparent;border:none;text-decoration:underline;text-decoration-thickness:2px;text-underline-offset:3px}

/* Cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
.pad{padding:20px}

/* Form */
.form-vertical{display:flex;flex-direction:column;row-gap:22px}
.field{width:100%}
label{display:block;margin:0 0 6px;font-weight:800}
input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:1rem}
input:disabled{background:#f8fafc;color:#334155}
input:focus,select:focus,.chip:focus-visible,.pill:focus-visible,.btn:focus-visible{outline:none;border-color:#c7d2fe;box-shadow:0 0 0 3px #e0e7ff}

/* Chips uniformi */
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.chip{height:40px;padding:0 14px;display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:9999px;background:#fff;cursor:pointer;font-weight:900}
.chip:hover{border-color:#bcd0ff}
.chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.coeff-wrap{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.coeff-input{width:86px}

/* Pulsanti */
.actions{display:flex;flex-direction:column;gap:10px;align-items:center;margin-top:8px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:0;border-radius:10px;font-weight:900;cursor:pointer;transition:transform .05s}
.btn:active{transform:translateY(1px)}
.btn.primary{background:var(--accent);color:#fff;height:46px;padding:0 18px;max-width:380px;width:100%}
.btn.primary:hover{background:var(--accent-dark)}
.sub-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.btn.print{background:#fff;border:1px solid var(--border);color:#111827;height:38px;padding:0 12px}
.btn.secondary{background:#fff;border:1px solid var(--border);height:38px;padding:0 12px}

/* Opzioni avanzate */
details.adv{display:block;width:100%}
details.adv>summary{cursor:pointer;list-style:none;padding:10px 14px;border:1px solid var(--border);border-radius:12px;font-weight:900;background:#fff;display:flex;align-items:center;gap:10px}
details.adv>summary::before{content:"";width:10px;height:10px;border:2px solid #111827;border-left:0;border-top:0;transform:rotate(45deg);transition:.2s}
details.adv[open]>summary::before{transform:rotate(-135deg)}
details.adv[open]>summary{background:#111827;color:#fff;border-color:#111827}
.adv-panel{display:none;margin-top:12px;width:100%;background:#fff;border:1px solid #E6E6E6;border-radius:16px;box-shadow:0 12px 24px rgba(2,6,23,.06);padding:16px}
details.adv[open] .adv-panel{display:block}
.adv-grid{display:grid;row-gap:20px}
.subgrid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.ibox{background:#fff;border:1px solid #E6E6E6;border-radius:12px;padding:16px;box-shadow:0 6px 16px rgba(2,6,23,.04)}
.ibox .bar{display:flex;align-items:center;gap:8px;margin:-4px -4px 12px;padding:8px 10px;border-radius:8px;color:#fff;font-weight:900}
.bar.theme-1{background:var(--c1)}
.bar.theme-2{background:var(--c2)}
.bar.theme-3{background:var(--c4)}
.bar.theme-4{background:var(--c5)}
.desc{font-size:12px;color:#6b7280;margin-top:6px}

/* Toggle pill Manuale/Stima */
.pill-toggle{display:flex;justify-content:center;gap:8px;margin:8px 0 14px}
.pill{height:34px;padding:0 14px;border-radius:9999px;border:1px solid var(--border);background:#fff;font-weight:900;cursor:pointer}
.pill.active{background:var(--c2);color:#fff;border-color:var(--c2)}

/* Tabs ‚Äì menu pieno */
.tabbar-wrap{padding:10px 12px}
.tab-bar{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.tab-btn{border:1px solid var(--pill-border);background:var(--pill);border-radius:10px;padding:10px 12px;height:40px;cursor:pointer;font-weight:900;white-space:nowrap;text-align:center;box-shadow:inset 0 -2px 0 rgba(0,0,0,0)}
.tab-btn.active{background:var(--pill-active);box-shadow:inset 0 -2px 0 var(--ink);border-color:var(--pill-border)}
.inkbar{display:none}
.tab{display:none}.tab.active{display:block}

/* Vista (spostata sotto a destra) */
.viewctrl{display:flex;align-items:center;gap:8px;justify-content:flex-end;padding:0 12px 12px}
#viewLabel{font-weight:800;color:#475569}
.switch{position:relative;display:inline-block;width:44px;height:24px}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#e5e7eb;border-radius:999px;transition:.2s}
.slider:before{content:"";position:absolute;height:18px;width:18px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 2px rgba(0,0,0,.3)}
.switch input:checked + .slider{background:var(--c2)}
.switch input:checked + .slider:before{transform:translateX(20px)}

/* KPI & tabelle */
.kpis{display:grid;gap:12px;margin-top:8px}
@media(min-width:640px){.kpis{grid-template-columns:repeat(2,1fr)}}
@media(min-width:860px){.kpis{grid-template-columns:repeat(3,1fr)}}
.kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;box-shadow:0 6px 16px rgba(2,6,23,.04);display:flex;flex-direction:column;justify-content:center;min-height:120px}
.kpi h3{margin:0 0 6px;font-size:.78rem;color:#64748b;text-transform:uppercase;font-weight:800}
.kpi .big{font-size:1.35rem;font-weight:900;font-variant-numeric:tabular-nums}
table{width:100%;border-collapse:collapse;margin-top:6px;font-size:.98rem;background:#fff;border:1px solid var(--border);box-shadow:0 6px 16px rgba(2,6,23,.04);page-break-inside:avoid}
th,td{border:1px solid var(--border);padding:12px 8px}
th{background:#f7f7fb;color:#475569;font-weight:800}
tr:hover{background:#f8faff}
tfoot tr th{background:#f1f5f9;font-weight:800}
#tblScadenze td:nth-child(2),#rateBody td:nth-child(3),#rateBody td:nth-child(5),#rateBody td:nth-child(6),#scadTot{text-align:right;font-variant-numeric:tabular-nums}
.badge-month{display:inline-block;padding:2px 8px;border-radius:9999px;background:var(--pill);border:1px solid var(--pill-border);font-weight:800;font-size:.85em}

/* Sezioni spiegazione + Copy */
.section{position:relative;border-left:4px solid #e5e7eb;padding:14px;margin:12px 0 8px;border-radius:10px;background:#fff;border:1px solid var(--border);box-shadow:0 6px 16px rgba(2,6,23,.04)}
.section.inps{border-left-color:var(--c1)}
.section.imp{border-left-color:#16a34a}
.section h3{margin:0 0 6px;font-size:1.05rem;font-weight:800}
.copy-btn{position:absolute;right:-10px;top:-10px;padding:6px 10px;font-size:.75rem;font-weight:900;border:0;border-radius:999px;background:var(--c4);color:#fff;box-shadow:0 6px 14px rgba(2,6,23,.18);cursor:pointer;opacity:0;transition:opacity .15s,transform .15s;transform:translateY(2px)}
.section:hover .copy-btn{opacity:1;transform:none}
@media (max-width:900px){.copy-btn{display:none}}
.explanation{max-width:820px;margin:0 auto;text-align:left}
.explanation .line{line-height:30px;margin:0;font-weight:500}
.muted{color:var(--muted)}
.mono{font-variant-numeric:tabular-nums}
.error{margin-top:10px;padding:10px;border-left:4px solid #ef4444;background:#fdecec;border-radius:10px;color:#7f1d1d}

/* Accordion rate */
details.rates>summary{list-style:none;cursor:pointer;display:flex;align-items:center;gap:8px;font-weight:900;color:#111827;padding:8px 0}
details.rates>summary::before{content:"";width:8px;height:8px;border:2px solid #111827;border-left:0;border-top:0;transform:rotate(45deg);transition:.2s}
details.rates[open]>summary::before{transform:rotate(-135deg)}

/* ARIA only */
.sr-only{position:absolute!important;width:1px!important;height:1px!important;padding:0!important;margin:-1px!important;overflow:hidden!important;clip:rect(0,0,0,0)!important;white-space:nowrap;border:0!important}

/* Print */
@media print{
  body{background:#fff}
  header,#inputCard,.viewctrl,.copy-btn{display:none!important}
  .wrap{max-width:1000px;margin:0;padding:0}
  #resultsBox{margin-top:0!important;border:none;box-shadow:none}
  .print-head{display:block !important; border-bottom:1px solid #ddd; padding:6px 0; margin-bottom:8px}
  .print-title{display:block !important; font-size:1.15rem; font-weight:800; margin:6px 0}
  .tab{display:block !important; page-break-inside:avoid}
  table,tr,td,th{page-break-inside:avoid}
  @page{size:A4;margin:12mm}
}
.print-head,.print-title{display:none}
</style>
</head>
<body>
<div class="wrap">
  <!-- TITOLO -->
  <header>
    <h1>Simulatore Forfettario per<br><u><span class="hl">Gestione Separata 2025</span></u></h1>
  </header>

  <!-- FORM -->
  <section class="card" id="inputCard" style="margin-top:14px">
    <div class="pad">
      <div class="form-vertical" style="max-width:720px;margin:0 auto">

        <div class="field">
          <label for="anno">Anno di riferimento <span class="hl">2025</span></label>
          <input id="anno" type="text" value="2025" disabled aria-disabled="true"/>
        </div>

        <div class="field">
          <label for="incassato">Incassato annuo (‚Ç¨) <span class="hl">importo incassato dell‚Äôanno</span></label>
          <input id="incassato" type="text" inputmode="numeric" placeholder="es. 50000" value="">
          <div class="chips" id="incChips" aria-label="Importi rapidi">
            <button class="chip" data-val="10.000" data-val-num="10000">10.000</button>
            <button class="chip" data-val="20.000" data-val-num="20000">20.000</button>
            <button class="chip" data-val="30.000" data-val-num="30000">30.000</button>
            <button class="chip" data-val="50.000" data-val-num="50000">50.000</button>
            <button class="chip" data-val="65.000" data-val-num="65000">65.000</button>
            <button class="chip" data-val="85.000" data-val-num="85000">85.000</button>
          </div>
        </div>

        <div class="field">
          <label>Coefficiente di <span class="hl">redditivit√†</span></label>
          <div class="coeff-wrap">
            <div class="chips" id="coeffChips">
              <button class="chip active" data-coeff="78">78%</button>
              <button class="chip" data-coeff="86">86%</button>
              <button class="chip" data-coeff="67">67%</button>
            </div>
            <input id="coeffCustom" class="coeff-input" maxlength="2" inputmode="numeric" pattern="[0-9]*" placeholder="%" title="2 cifre"/>
            <span class="muted" style="font-size:.9rem">personalizzato</span>
          </div>
        </div>

        <div class="field">
          <label for="imposta">Percentuale <span class="hl">Imposta sostitutiva</span></label>
          <select id="imposta">
            <option value="0.05" selected>5% (primi 5 anni)</option>
            <option value="0.15">15% (ordinaria)</option>
          </select>
        </div>

        <!-- Opzioni avanzate -->
        <details class="adv" style="margin-top:4px" id="advBox">
          <summary>‚öôÔ∏è Opzioni avanzate</summary>
          <div class="adv-panel">
            <div class="adv-grid">

              <div class="ibox">
                <div class="bar theme-1">Parametri INPS & acconti</div>
                <div class="subgrid">
                  <div><label>Aliquota INPS (%)</label><input id="aliqInps" type="text" inputmode="decimal" value="26,07"></div>
                </div>
                <div class="desc">Acconti fissi (metodo storico): <b>Imposta 100%</b> (50%+50%), <b>INPS 80%</b> (40%+40%).</div>
              </div>

              <div class="ibox">
                <div class="bar theme-2">Acconti versati l‚Äôanno precedente</div>
                <div class="pill-toggle" role="tablist" aria-label="Modalit√† inserimento acconti">
                  <button type="button" class="pill active" id="pillManuale" aria-pressed="true">Manuale</button>
                  <button type="button" class="pill" id="pillStima" aria-pressed="false">Stima automatica da incasso 2024</button>
                </div>

                <div class="subgrid" id="accManual">
                  <div><label>Acconti IMPOSTA versati (‚Ç¨)</label><input id="accImpPrev" type="text" inputmode="decimal" value="0"></div>
                  <div><label>Acconti INPS versati (‚Ç¨)</label><input id="accInpsPrev" type="text" inputmode="decimal" value="0"></div>
                </div>

                <div id="accStima" style="display:none">
                  <div class="subgrid">
                    <div><label>Incassato 2024 (‚Ç¨)</label><input id="incasso2024" type="text" inputmode="decimal" value="0"></div>
                    <div><label>Imposta 2024</label>
                      <select id="imp2024"><option value="0.05" selected>5%</option><option value="0.15">15%</option></select>
                    </div>
                    <div><label>Coeff. 2024 (%)</label><input id="coeff2024" type="text" class="coeff-input" maxlength="2" inputmode="numeric" pattern="[0-9]*" value="78"></div>
                    <div><label>Aliquota INPS 2024 (%)</label><input id="inps2024" type="text" inputmode="decimal" value="26,07"></div>
                  </div>
                  <div class="desc">Stima veloce: nessuna deduzione; acconti ‚âà imposta√ó100% e INPS√ó80%.</div>
                </div>
              </div>

              <div class="ibox">
                <div class="bar theme-3">Contributi deducibili (per l‚Äôimposta)</div>
                <div class="subgrid">
                  <div style="grid-column:1/-1">
                    <label for="deducibili">Contributi previdenziali gi√† versati nell‚Äôanno (‚Ç¨) ‚Äî deducibili solo per l‚Äôimposta</label>
                    <input id="deducibili" type="text" inputmode="decimal" value="0"/>
                  </div>
                </div>
              </div>

              <!-- Calcolo inverso -->
              <div class="ibox">
                <div class="bar theme-4">Calcolo inverso (netto desiderato ‚Üí incassato)</div>
                <div class="subgrid" style="align-items:end">
                  <div>
                    <label for="nettoTarget">Netto annuo desiderato (‚Ç¨)</label>
                    <input id="nettoTarget" type="text" inputmode="decimal" placeholder="es. 20000" value="">
                  </div>
                  <div>
                    <!-- stesso colore del bottone Calcola -->
                    <button type="button" id="btnInverti" class="btn primary" style="width:100%">Calcola incassato necessario</button>
                  </div>
                </div>
                <div id="invOut" class="desc" style="margin-top:8px"></div>
                <div class="desc">Il lordo calcolato copre <b>saldi + acconti</b> (non solo i saldi).</div>
              </div>

            </div>
          </div>
        </details>

        <div class="actions">
          <button class="btn primary" id="btnCalc">Calcola</button>
          <div class="sub-actions">
            <button class="btn print" id="btnPrint">Stampa PDF</button>
            <button class="btn secondary" id="btnReset">Reset</button>
          </div>
        </div>

      </div>

      <div id="err" class="error" style="display:none"></div>
      <div id="liveResult" class="sr-only" aria-live="polite"></div>
    </div>
  </section>

  <!-- RISULTATI -->
  <section id="resultsBox" class="card" style="margin-top:14px;display:none" aria-live="polite">
    <div class="print-head" id="printHead"></div>

    <div class="tabbar-wrap">
      <div class="tab-bar" id="tabBar">
        <button class="tab-btn active" data-tab="tab1">Come si calcolano</button>
        <button class="tab-btn" data-tab="tab2">Risultati Tasse da pagare</button>
        <button class="tab-btn" data-tab="tab3">Scadenze da pagare</button>
        <span class="inkbar" id="inkbar"></span>
      </div>
    </div>

    <!-- Vista spostata sotto, a destra -->
    <div class="viewctrl">
      <span id="viewLabel">Vista Dettagliata</span>
      <label class="switch" title="Cambia vista">
        <input type="checkbox" id="simpToggle"><span class="slider"></span>
      </label>
    </div>

    <div id="tab1" class="tab active">
      <h2 class="print-title">Come si calcolano</h2>
      <div class="pad"><div id="explanation" class="explanation"></div></div>
    </div>

    <div id="tab2" class="tab">
      <h2 class="print-title">Risultati Tasse da pagare</h2>
      <div class="pad">
        <div class="kpis">
          <div class="kpi"><h3>Reddito imponibile</h3><div class="big" id="outImponibile">‚Ç¨ 0</div><div class="muted" style="font-size:.85rem">Incassato √ó coefficiente</div></div>
          <div class="kpi"><h3>Contributi INPS</h3><div class="big" id="outInps">‚Ç¨ 0</div><div class="muted" style="font-size:.85rem">Aliquota su imponibile</div></div>
          <div class="kpi"><h3>Imposta sostitutiva</h3><div class="big" id="outImposta">‚Ç¨ 0</div><div class="muted" style="font-size:.85rem">Su (imponibile ‚àí deducibili)</div></div>
        </div>
        <div class="kpis" style="margin-top:6px">
          <div class="kpi"><h3>Saldo da versare ora</h3><div class="big" id="outSaldo">‚Ç¨ 0</div></div>
          <div class="kpi"><h3>Acconti netti</h3><div class="big" id="outAcconti">‚Ç¨ 0</div></div>
          <div class="kpi"><h3>Totale anno</h3><div class="big" id="outTotale">‚Ç¨ 0</div></div>
        </div>
        <div class="hr" style="height:1px;background:var(--border);margin:14px 0"></div>
        <div id="warnings" style="text-align:center"></div>
        <h3 style="margin:6px 0">Dettaglio</h3>
        <table><tbody id="tblDettaglio"></tbody><tfoot><tr><th style="text-align:right" colspan="1">Totale</th><th id="detTot" style="text-align:center"></th></tr></tfoot></table>
      </div>
    </div>

    <div id="tab3" class="tab">
      <h2 class="print-title">Scadenze da pagare</h2>
      <div class="pad">
        <h3 style="margin:0 0 6px">Scadenze sintetiche</h3>
        <table><tbody id="tblScadenze"></tbody><tfoot><tr><th style="text-align:right" colspan="1">Totale anno</th><th id="scadTot" style="text-align:right"></th></tr></tfoot></table>

        <details class="rates" id="ratesAcc" style="margin-top:12px" open>
          <summary>Mostra dettaglio rate di giugno (5 rate con interessi) + riga di novembre</summary>
          <div id="rateBlock" style="margin-top:8px">
            <table>
              <thead><tr><th>#</th><th>Scadenza</th><th>Quota capitale</th><th>Interessi %</th><th>Interessi ‚Ç¨</th><th>Rata</th></tr></thead>
              <tbody id="rateBody"></tbody>
              <tfoot>
                <tr><th colspan="4" style="text-align:right">Totale interessi giugno</th><th id="rateIntTot">‚Ç¨ 0</th><th id="rateTot">‚Ç¨ 0</th></tr>
                <tr><th colspan="5" style="text-align:right">Totale complessivo (giugno + novembre)</th><th id="rateTotAll">‚Ç¨ 0</th></tr>
              </tfoot>
            </table>
          </div>
        </details>

        <div class="desc" style="margin-top:10px">
          <b>Avvertenza:</b> le <b>percentuali</b> (aliquote e interessi di rateazione) possono variare di anno in anno.
          Anche la possibilit√† di <b>rateizzare i secondi acconti</b> pu√≤ cambiare in base alla normativa vigente.
        </div>
      </div>
    </div>
  </section>
</div>

<script>
(function(){
  /* --- Utils --- */
  function euro(n){
    const r = Math.round(n || 0);
    try{
      return new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR',minimumFractionDigits:0,maximumFractionDigits:0}).format(r);
    }catch(e){
      return '‚Ç¨ ' + r.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');
    }
  }
  function parseNum(s){
    if(s==null) return 0;
    let t = String(s).trim().replace(/\s+/g,'');
    t = t.replace(/\./g,'').replace(',', '.');
    const n = parseFloat(t);
    return isNaN(n) ? 0 : n;
  }
  function val(id){return parseNum(document.getElementById(id).value)}
  function setHTML(id,html){const el=document.getElementById(id);if(el)el.innerHTML=html}
  function tr(a,b,right=false){return '<tr><td>'+a+'</td><td style="text-align:'+(right?'right':'center')+';font-variant-numeric:tabular-nums">'+b+'</td></tr>'}
  function perc(n,b){return b>0?(Math.round((n/b*100))+'%'):'0%'}
  function nowIt(){return new Intl.DateTimeFormat('it-IT',{dateStyle:'medium',timeStyle:'short'}).format(new Date())}

  /* --- Stato --- */
  let coeffFromChips=78,lastState=null,cacheGiugno=0,cacheNov=0;

  /* --- Tab change --- */
  document.addEventListener('click',e=>{
    const b=e.target.closest('.tab-btn'); if(!b) return;
    document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active'); document.getElementById(b.dataset.tab).classList.add('active');
  });

  /* --- Input Incassato --- */
  const incInput=document.getElementById('incassato');
  const incChips=document.getElementById('incChips');

  incInput.addEventListener('input', () => {
    incChips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  });

  incChips.addEventListener('click', (e) => {
    const chip=e.target.closest('.chip'); if(!chip) return;
    incChips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    const raw = chip.dataset.valNum || chip.dataset.val || chip.textContent;
    const clean = String(raw).replace(/\./g,'').replace(/\s/g,'');
    incInput.value = clean;
    incInput.focus();
    try{incInput.setSelectionRange(incInput.value.length,incInput.value.length);}catch{}
  });

  /* --- Coefficiente --- */
  document.getElementById('coeffChips').addEventListener('click',e=>{
    const c=e.target.closest('.chip'); if(!c) return;
    document.querySelectorAll('#coeffChips .chip').forEach(x=>x.classList.remove('active'));
    c.classList.add('active'); coeffFromChips=parseInt(c.dataset.coeff,10)||78;
    document.getElementById('coeffCustom').value='';
  });
  document.getElementById('coeffCustom').addEventListener('input',function(){
    this.value=this.value.replace(/\D/g,'').slice(0,2);
    document.querySelectorAll('#coeffChips .chip').forEach(x=>x.classList.remove('active'));
  });

  /* --- Opzioni avanzate: pill toggle --- */
  function refreshAccMode(){
    const man=document.getElementById('pillManuale'), sti=document.getElementById('pillStima');
    const manual=man.classList.contains('active');
    document.getElementById('accManual').style.display=manual?'grid':'none';
    document.getElementById('accStima').style.display=manual?'none':'block';
    man.setAttribute('aria-pressed',manual?'true':'false');
    sti.setAttribute('aria-pressed',manual?'false':'true');
  }
  document.getElementById('pillManuale').addEventListener('click',function(){this.classList.add('active');document.getElementById('pillStima').classList.remove('active');refreshAccMode();});
  document.getElementById('pillStima').addEventListener('click',function(){this.classList.add('active');document.getElementById('pillManuale').classList.remove('active');refreshAccMode();});

  /* --- Vista dettagliata/semplificata --- */
  const simp=document.getElementById('simpToggle'), viewLabel=document.getElementById('viewLabel');
  simp.addEventListener('change',()=>{viewLabel.textContent = simp.checked ? 'Vista Semplificata' : 'Vista Dettagliata'; if(document.getElementById('resultsBox').style.display!=='none') buildExplanation();});

  /* --- Copy singolo blocco --- */
  document.addEventListener('click',async e=>{
    const btn=e.target.closest('.copy-btn'); if(!btn) return;
    const box=btn.closest('.section'); const payload=(box.querySelector('.copy-content')||box).innerText.trim();
    try{await navigator.clipboard.writeText(payload);const t=btn.textContent;btn.textContent='Copiato!';setTimeout(()=>btn.textContent=t,1200);}catch{const t=btn.textContent;btn.textContent='Errore';setTimeout(()=>btn.textContent=t,1200);}
  });

  /* --- Calcolo --- */
  function compute(){
    const incassato=val('incassato');
    let coeffPerc=document.getElementById('coeffCustom').value?parseInt(document.getElementById('coeffCustom').value,10):coeffFromChips;
    if(!coeffPerc||coeffPerc<=0) coeffPerc=78;
    const coeff=coeffPerc/100;

    const impRate=parseFloat(document.getElementById('imposta').value)||0.05;
    const aliqInps=parseNum(document.getElementById('aliqInps').value)/100||0.2607;
    const deducibili=val('deducibili');

    // Acconti fissi: 100% imposta, 80% INPS
    const ACC_IMP_PERC = 1.00;
    const ACC_INPS_PERC = 0.80;

    let accImpPrev=0, accInpsPrev=0;
    const manual=document.getElementById('pillManuale').classList.contains('active');
    if(manual){
      accImpPrev=val('accImpPrev'); accInpsPrev=val('accInpsPrev');
    }else{
      const inc24=val('incasso2024');
      const coeff24=(parseNum(document.getElementById('coeff2024').value)||78)/100;
      const imp24rate=parseFloat(document.getElementById('imp2024').value)||0.05;
      const inps24rate=parseNum(document.getElementById('inps2024').value)/100||0.2607;
      const impon24=inc24*coeff24;
      const inps24=impon24*inps24rate;
      const imp24=impon24*imp24rate;
      accImpPrev=imp24*ACC_IMP_PERC; accInpsPrev=inps24*ACC_INPS_PERC;
    }

    const err=document.getElementById('err');
    if(incassato<=0){err.style.display='block';err.textContent='Inserisci un incassato annuo valido (> 0) o usa il calcolo inverso nelle Opzioni avanzate.';document.getElementById('resultsBox').style.display='none';return}
    err.style.display='none';

    const imponibileForf=incassato*coeff;
    const inps=imponibileForf*aliqInps;

    const imponibileFisc=Math.max(0,imponibileForf-Math.max(0,deducibili));
    const imposta=imponibileFisc*impRate;

    let saldoImposta=Math.max(0,imposta-Math.max(0,accImpPrev));
    let saldoInps=Math.max(0,inps-Math.max(0,accInpsPrev));
    const saldoTotale=saldoImposta+saldoInps;

    const creditoImp=Math.max(0,accImpPrev-imposta);
    const creditoInps=Math.max(0,accInpsPrev-inps);

    const accImpBase=imposta*ACC_IMP_PERC;
    const accInpsBase=inps*ACC_INPS_PERC;

    const accImpTot=Math.max(0,accImpBase-creditoImp);
    const accInpsTot=Math.max(0,accInpsBase-creditoInps);

    const creditoImpResid=Math.max(0,creditoImp-accImpBase);
    const creditoInpsResid=Math.max(0,creditoInps-accInpsBase);

    const accImp1=accImpTot*0.50, accImp2=accImpTot*0.50;
    const accInps1=accInpsTot*0.50, accInps2=accInpsTot*0.50;

    const accontiTot=accImpTot+accInpsTot;
    const giugnoTot=saldoTotale+accImp1+accInps1;
    const novTot=accImp2+accInps2;
    const totale=saldoTotale+accontiTot;

    /* KPI */
    setHTML('outImponibile',euro(imponibileForf));
    setHTML('outInps',euro(inps));
    setHTML('outImposta',euro(imposta));
    setHTML('outSaldo',euro(saldoTotale));
    setHTML('outAcconti',euro(accontiTot));
    setHTML('outTotale',euro(totale));
    setHTML('liveResult',`Aggiornato. Saldo ${euro(saldoTotale)}, acconti ${euro(accontiTot)}, totale ${euro(totale)}.`);

    /* Note */
    let w=''; if(incassato>100000) w='<div class="muted"><b>Attenzione:</b> oltre 100.000‚Ç¨ ‚Üí uscita <b>immediata</b> dal forfettario.</div>';
    else if(incassato>85000) w='<div class="muted"><b>Nota:</b> oltre 85.000‚Ç¨ ‚Üí uscita dal forfettario <b>dall‚Äôanno successivo</b>.</div>';
    setHTML('warnings',w);

    /* Dettaglio (tab 2) */
    let det='';
    det+=tr('<b>Incassato</b>',euro(incassato));
    det+=tr('Coefficiente',Math.round(coeff*100)+'%');
    det+=tr('<b>Imponibile</b>',euro(imponibileForf));
    det+=tr('Deducibili per imposta','‚àí '+euro(deducibili));
    det+=tr('Base per imposta',euro(imponibileFisc));
    det+=tr('Aliquota imposta',Math.round(impRate*100)+'%');
    det+=tr('<b>Imposta calcolata</b>',euro(imposta));
    det+=tr('Acconti imposta anno precedente','‚àí '+euro(accImpPrev));
    det+=tr('<b>Saldo imposta</b>','<b>'+euro(saldoImposta)+'</b>');
    if(creditoImp>0) det+=tr('Credito imposta utilizzato','‚àí '+euro(Math.min(creditoImp, accImpBase)));
    if(creditoImpResid>0) det+=tr('Credito imposta residuo',euro(creditoImpResid));
    det+=tr('Contributi INPS ('+(aliqInps*100).toFixed(2)+'%)',euro(inps));
    det+=tr('Acconti INPS anno precedente','‚àí '+euro(accInpsPrev));
    det+=tr('<b>Saldo INPS</b>','<b>'+euro(saldoInps)+'</b>');
    if(creditoInps>0) det+=tr('Credito INPS utilizzato','‚àí '+euro(Math.min(creditoInps, accInpsBase)));
    if(creditoInpsResid>0) det+=tr('Credito INPS residuo',euro(creditoInpsResid));
    det+=tr('<b>Saldo totale</b>','<b>'+euro(saldoTotale)+'</b>');
    det+='<tr><th colspan="2">Acconti per l‚Äôanno prossimo (netti dei crediti)</th></tr>';
    det+=tr('Imposta ‚Äì totale acconti',euro(accImpTot));
    det+=tr('INPS ‚Äì totale acconti',euro(accInpsTot));
    det+=tr('Imposta ‚Äì 1¬∞ acconto (50%)',euro(accImp1));
    det+=tr('Imposta ‚Äì 2¬∞ acconto (50%)',euro(accImp2));
    det+=tr('INPS ‚Äì 1¬∞ acconto (40%)',euro(accInps1));
    det+=tr('INPS ‚Äì 2¬∞ acconto (40%)',euro(accInps2));
    setHTML('tblDettaglio',det); setHTML('detTot','');

    /* Scadenze (tab 3) */
    cacheGiugno=giugnoTot; cacheNov=novTot;
    let sc=''; sc+=tr('<span class="badge-month">Giugno</span> ‚Äî Saldo (imp.+INPS) + 1¬∞ acconti',euro(giugnoTot),true);
    sc+=tr('<span class="badge-month">Novembre</span> ‚Äî 2¬∞ acconti',euro(novTot),true);
    setHTML('tblScadenze',sc); setHTML('scadTot',euro(giugnoTot+novTot));

    document.getElementById('ratesAcc').open=true; // mostra subito il dettaglio rate
    buildRate();

    lastState={
      incassato,coeffPerc,coeff,impRate,aliqInps,imponibileForf,inps,deducibili,imponibileFisc,imposta,
      accImpPrev,accInpsPrev,saldoImposta,saldoInps,saldoTotale,accImpTot,accInpsTot,accImp1,accImp2,accInps1,accInps2,
      giugnoTot,novTot,totale,creditoImp,creditoInps,creditoImpResid,creditoInpsResid
    };
    buildExplanation();

    document.getElementById('resultsBox').style.display='';
  }

  function P(t){return `<p class="line">${t}</p>`}
  function wrapSection(title,inner,cls){return `<div class="section ${cls||''}">
    <button type="button" class="copy-btn" title="Copia" aria-label="Copia">Copia</button>
    <div class="copy-content">${title?`<h3>${title}</h3>`:''}${inner}</div></div>`}

  function buildExplanation(){
    if(!lastState) return;
    const s=lastState, simple=document.getElementById('simpToggle').checked;
    document.getElementById('viewLabel').textContent = simple ? 'Vista Semplificata' : 'Vista Dettagliata';

    const inc=euro(s.incassato), impForf=euro(s.imponibileForf), inps=euro(s.inps), imposta=euro(s.imposta),
          baseImp=euro(s.imponibileFisc), saldoINPS=euro(s.saldoInps), saldoIMP=euro(s.saldoImposta),
          saldoTot=euro(s.saldoTotale), giu=euro(s.giugnoTot), nov=euro(s.novTot), tot=euro(s.totale),
          accINPStot=euro(s.accInpsTot), accIMPtot=euro(s.accImpTot),
          accINPS1=euro(s.accInps1), accIMP1=euro(s.accImp1);

    const credImp=s.creditoImp, credInps=s.creditoInps, credImpRes=s.creditoImpResid, credInpsRes=s.creditoInpsResid;

    let html='';
    if(!simple){
      html+=wrapSection('Imponibile',
        P(`Hai incassato <u><b>${inc}</b></u>. Con coefficiente <u><b>${s.coeffPerc}%</b></u> il reddito imponibile diventa:`) +
        P(`<span class="mono">${inc} √ó ${s.coeffPerc}% = ${impForf}</span>`),'');

      let inpsTxt=P(`INPS al <b>${(s.aliqInps*100).toFixed(2)}%</b> sull‚Äôimponibile: <span class="mono">${impForf} √ó ${(s.aliqInps*100).toFixed(2)}% = ${inps}</span>.`);
      if(s.accInpsPrev>0){
        if(credInps>0){
          inpsTxt+=P(`Acconti INPS gi√† versati: <b>${euro(s.accInpsPrev)}</b> > dovuto ‚Üí <b>saldo 0 ‚Ç¨</b> e <b>credito ${euro(credInps)}</b> che riduce i nuovi acconti (eventuale residuo: ${euro(credInpsRes)}).`);
        }else{
          inpsTxt+=P(`Acconti INPS versati: <b>${euro(s.accInpsPrev)}</b>. Saldo ora: <span class="mono">${inps} ‚àí ${euro(s.accInpsPrev)} = ${saldoINPS}</span>.`);
        }
      }
      inpsTxt+=P(`üëâ <b>Saldo INPS</b> da versare ora: <b>${saldoINPS}</b>.`);
      html+=wrapSection('Contributi INPS', inpsTxt,'inps');

      let impTxt=(s.deducibili>0)
        ? P(`Prima togliamo i <b>contributi deducibili</b> (${euro(s.deducibili)}): <span class="mono">${impForf} ‚àí ${euro(s.deducibili)} = ${baseImp}</span>.`)
        : P(`Base imposta: <b>${baseImp}</b> (nessuna deduzione).`);
      impTxt+=P(`Aliquota <b>${Math.round(s.impRate*100)}%</b>: <span class="mono">${baseImp} √ó ${Math.round(s.impRate*100)}% = ${imposta}</span>.`);
      if(s.accImpPrev>0){
        if(credImp>0){
          impTxt+=P(`Acconti imposta gi√† versati: <b>${euro(s.accImpPrev)}</b> > dovuto ‚Üí <b>saldo 0 ‚Ç¨</b> e <b>credito ${euro(credImp)}</b> (riduce i nuovi acconti, residuo: ${euro(credImpRes)}).`);
        }else{
          impTxt+=P(`Acconti imposta versati: <b>${euro(s.accImpPrev)}</b>. Saldo ora: <span class="mono">${imposta} ‚àí ${euro(s.accImpPrev)} = ${saldoIMP}</span>.`);
        }
      }
      impTxt+=P(`üëâ <b>Saldo imposta</b> da versare ora: <b>${saldoIMP}</b>.`);
      html+=wrapSection('Imposta sostitutiva', impTxt,'imp');

      html+=wrapSection('Totale saldi ora',
        P(`<span class="mono"><b>${saldoINPS}</b> (INPS) + <b>${saldoIMP}</b> (imposta) = <b>${saldoTot}</b></span>.`),'');

      let accTxt=P(`Calcolati sul dovuto di quest‚Äôanno e <b>gi√† ridotti dei crediti</b> (se presenti).`) +
                  P(`<b>Imposta</b>: ${accIMPtot} (50% giugno, 50% novembre).`) +
                  P(`<b>INPS</b>: ${accINPStot} (40% giugno, 40% novembre).`);
      if(credImp>0||credInps>0){
        accTxt+=P(`I crediti hanno ridotto gli acconti. ${credImp>0?`Imposta ‚àí${euro(Math.min(credImp, s.imposta))}. `:''}${credInps>0?`INPS ‚àí${euro(Math.min(credInps, s.inps))}.`:''}`);
        if(credImpRes>0||credInpsRes>0) accTxt+=P(`Residui da riportare: imposta ${euro(credImpRes)}, INPS ${euro(credInpsRes)}.`);
      }
      html+=wrapSection('Acconti per l‚Äôanno successivo', accTxt,'');

      html+=wrapSection('Scadenze',
        P(`<b>Giugno</b> = saldi (<b>${saldoINPS}</b> + <b>${saldoIMP}</b>) + primi acconti (<b>${accIMP1}</b> imposta + <b>${euro(s.accInps1)}</b> INPS) = <b>${giu}</b>.`) +
        P(`<b>Novembre</b> = secondi acconti = <b>${nov}</b>.`),'');

      html+=wrapSection('Totale anno e incidenza',
        P(`<span class="mono">${giu} + ${nov} = ${tot}</span>. Incidenza: saldi <b>${perc(s.saldoTotale,s.incassato)}</b>; acconti <b>${perc(s.accImpTot+s.accInpsTot,s.incassato)}</b>; totale <b>${perc(s.totale,s.incassato)}</b>.`),'');

    }else{
      html+=wrapSection('Imponibile',
        P(`Incassato <b>${inc}</b> ‚Üí con coefficiente <b>${s.coeffPerc}%</b> l‚Äôimponibile √® <b>${impForf}</b>.`),'');

      let inpsS=P(`INPS su imponibile: <span class="mono">${impForf} √ó ${(s.aliqInps*100).toFixed(2)}% = ${inps}</span>.`);
      if(s.creditoInps>0) inpsS+=P(`Acconti superiori al dovuto: <b>saldo 0 ‚Ç¨</b>, credito <b>${euro(s.creditoInps)}</b> che riduce i nuovi acconti${s.creditoInpsResid>0?`, residuo ${euro(s.creditoInpsResid)}`:''}.`);
      else if(s.accInpsPrev>0) inpsS+=P(`Acconti scalati ‚áí saldo INPS: <b>${saldoINPS}</b>.`);
      else inpsS+=P(`Saldo INPS: <b>${saldoINPS}</b>.`);
      html+=wrapSection('Contributi INPS', inpsS,'inps');

      let impS=P(`Base per imposta: <b>${baseImp}</b>. Calcolo: <span class="mono">${baseImp} √ó ${Math.round(s.impRate*100)}% = ${imposta}</span>.`);
      if(s.creditoImp>0) impS+=P(`Acconti superiori al dovuto: <b>saldo 0 ‚Ç¨</b>, credito <b>${euro(s.creditoImp)}</b> che riduce i nuovi acconti${s.creditoImpResid>0?`, residuo ${euro(s.creditoImpResid)}`:''}.`);
      else if(s.accImpPrev>0) impS+=P(`Acconti scalati ‚áí saldo imposta: <b>${saldoIMP}</b>.`);
      else impS+=P(`Saldo imposta: <b>${saldoIMP}</b>.`);
      html+=wrapSection('Imposta sostitutiva', impS,'imp');

      html+=wrapSection('Scadenze',
        P(`<b>Giugno</b>: saldi + primi acconti = <b>${giu}</b>. ‚Ä¢ <b>Novembre</b>: secondi acconti = <b>${nov}</b>. Totale anno: <b>${tot}</b>.`),'');

    }
    setHTML('explanation',html);
  }

  function buildRate(){
    const totGiu=cacheGiugno, quota=totGiu/5;
    let tbody='',sumInt=0,sumTotGiu=0;
    const RATE_PERC=[0.00,0.18,0.51,0.84,1.17];
    const RATE_DATE=["30 giugno","16 luglio","20 agosto","16 settembre","16 ottobre"];
    for(let i=0;i<5;i++){
      const p=RATE_PERC[i]/100, interesse=totGiu*p, rata=quota+interesse;
      sumInt+=interesse; sumTotGiu+=rata;
      tbody+=`<tr><td>${i+1}</td><td>${RATE_DATE[i]}</td><td>${euro(quota)}</td><td>${RATE_PERC[i].toFixed(2)}%</td><td>${euro(interesse)}</td><td><b>${euro(rata)}</b></td></tr>`;
    }
    tbody+=`<tr><td>6</td><td><b>Novembre ‚Äî 2¬∞ acconti</b></td><td>${euro(cacheNov)}</td><td>‚Äî</td><td>‚Äî</td><td><b>${euro(cacheNov)}</b></td></tr>`;
    setHTML('rateBody',tbody); setHTML('rateIntTot',euro(sumInt)); setHTML('rateTot',euro(sumTotGiu)); setHTML('rateTotAll',euro(sumTotGiu+cacheNov));
  }

  /* Netto dopo saldi + acconti ‚Äî per calcolo inverso */
  function netAfterTotale(inc){
    const coeffPerc=document.getElementById('coeffCustom').value?parseInt(document.getElementById('coeffCustom').value,10):coeffFromChips;
    const coeff=(coeffPerc>0?coeffPerc:78)/100;
    const impRate=parseFloat(document.getElementById('imposta').value)||0.05;
    const aliqInps=parseNum(document.getElementById('aliqInps').value)/100||0.2607;
    const deducibili=val('deducibili');

    const ACC_IMP_PERC=1.00, ACC_INPS_PERC=0.80;

    let accImpPrev=0, accInpsPrev=0;
    if(document.getElementById('pillManuale').classList.contains('active')){
      accImpPrev=val('accImpPrev'); accInpsPrev=val('accInpsPrev');
    }else{
      const inc24=val('incasso2024');
      const coeff24=(parseNum(document.getElementById('coeff2024').value)||78)/100;
      const imp24rate=parseFloat(document.getElementById('imp2024').value)||0.05;
      const inps24rate=parseNum(document.getElementById('inps2024').value)/100||0.2607;
      const impon24=inc24*coeff24;
      const inps24=impon24*inps24rate;
      const imp24=impon24*imp24rate;
      accImpPrev=imp24*ACC_IMP_PERC; accInpsPrev=inps24*ACC_INPS_PERC;
    }

    const impon=inc*coeff;
    const inps=impon*aliqInps;
    const imposta=Math.max(0,impon-deducibili)*impRate;

    const saldoINPS=Math.max(0,inps-accInpsPrev);
    const saldoIMP=Math.max(0,imposta-accImpPrev);

    const creditoImp=Math.max(0,accImpPrev-imposta);
    const creditoInps=Math.max(0,accInpsPrev-inps);
    const accImpBase=imposta*ACC_IMP_PERC;
    const accInpsBase=inps*ACC_INPS_PERC;
    const accImpTot=Math.max(0,accImpBase-creditoImp);
    const accInpsTot=Math.max(0,accInpsBase-creditoInps);

    const costoTot = saldoINPS + saldoIMP + accImpTot + accInpsTot;
    return inc - costoTot;
  }

  /* Ricerca binaria: netto target -> incassato (dopo saldi + acconti) */
  function findIncassatoForNet(target){
    target=Math.max(0,target||0);
    let lo=0, hi=Math.max(20000, target*3+10000);
    for(let i=0;i<40 && netAfterTotale(hi)<target;i++) hi*=1.6;
    for(let k=0;k<64;k++){
      const mid=(lo+hi)/2;
      if(netAfterTotale(mid)>=target) hi=mid; else lo=mid;
    }
    return Math.round(hi);
  }

  /* Stampa */
  document.getElementById('btnPrint').addEventListener('click',()=>{
    const vis=document.getElementById('resultsBox').style.display!=='none';
    if(!vis){alert('Prima clicca su CALCOLA per generare i risultati da stampare.');return;}
    window.print();
  });

  /* Inverti */
  document.getElementById('btnInverti').addEventListener('click',()=>{
    const target=val('nettoTarget');
    if(target<=0){setHTML('invOut','Inserisci un netto desiderato valido.');return;}
    const inc=findIncassatoForNet(target);
    const incInput=document.getElementById('incassato');
    incInput.value=String(inc);
    [...document.getElementById('incChips').querySelectorAll('.chip')].forEach(c=>c.classList.remove('active'));
    setHTML('invOut',`Per avere circa <b>${euro(target)}</b> netti <u>dopo saldi + acconti</u>, ti servono circa <b>${euro(inc)}</b> di incassato.`);
    compute();
    window.scrollTo({top:0,behavior:'smooth'});
  });

  /* Calcola / Reset / Init */
  document.getElementById('btnCalc').addEventListener('click',compute);

  document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('coeffChips').querySelector('.chip[data-coeff="78"]').classList.add('active');
    ['incassato','deducibili','accImpPrev','accInpsPrev','incasso2024','coeff2024','aliqInps','nettoTarget']
      .forEach(id=>{const el=document.getElementById(id);if(!el)return;el.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();id==='nettoTarget'?document.getElementById('btnInverti').click():compute();}})});

    document.getElementById('btnReset').addEventListener('click',()=>{
      ['incassato','deducibili','accImpPrev','accInpsPrev','incasso2024','nettoTarget'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
      document.getElementById('coeffCustom').value='';
      document.querySelectorAll('#coeffChips .chip').forEach(x=>x.classList.remove('active'));
      document.querySelector('#coeffChips .chip[data-coeff="78"]').classList.add('active'); coeffFromChips=78;
      document.getElementById('imposta').value='0.05';
      document.getElementById('aliqInps').value='26,07';
      document.getElementById('ratesAcc').open=true;
      document.getElementById('simpToggle').checked=false; document.getElementById('viewLabel').textContent='Vista Dettagliata';
      document.getElementById('resultsBox').style.display='none'; window.scrollTo({top:0,behavior:'smooth'});
      setHTML('invOut',''); setHTML('warnings','');
      const tb=document.querySelector('.tab-btn[data-tab="tab1"]'); if(tb) tb.click();
    });
  });
})();
</script>
</body>
</html>
