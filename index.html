<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Simulatore Forfettario • Gestione Separata 2025</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f7f9fc;--card:#fff;--text:#0f172a;--muted:#64748b;--border:#e6e6eb;
  --accent:#2563eb;--accent-2:#0ea5e9;--ok:#16a34a;--warn:#f59e0b;--bad:#ef4444;
  --hl:#fff8c8;--shadow:0 14px 28px rgba(2,6,23,.08);--r:14px;--dots:26px;
}
*{box-sizing:border-box}
html{font-size:17px}
body{
  margin:0;color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:radial-gradient(rgba(2,6,23,.08) 1px, transparent 1px) 0 0/ var(--dots) var(--dots),#f7f9fc;
  -webkit-font-smoothing:antialiased;
}
.wrap{max-width:940px;margin:26px auto;padding:0 14px}
header{text-align:center;margin-bottom:10px}
h1{margin:0;font-size:2rem;line-height:1.2;font-weight:900}
.hl{background:var(--hl);padding:.05em .35em;border-radius:.45em;border:1px solid #f3e89a}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow)}
.pad{padding:20px}
label{font-weight:900;display:block;margin:0 0 6px}
input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:1rem}
input:disabled{background:#f3f4f6;color:#334155}
input:focus,select:focus,.chip:focus-visible,.btn:focus-visible{outline:none;border-color:#c7d2fe;box-shadow:0 0 0 3px #e0e7ff}
.form{display:flex;flex-direction:column;gap:18px}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.chip{height:40px;padding:0 14px;border:1px solid var(--border);border-radius:999px;background:#fff;font-weight:900;cursor:pointer}
.chip:hover{border-color:#bfd3ff}
.chip.active{background:#111827;color:#fff;border-color:#111827}
.inline-flag{display:flex;gap:10px;align-items:center;margin-top:8px;font-weight:800}
#exBox{display:none;margin-top:8px}
details.adv>summary{
  list-style:none;cursor:pointer;font-weight:900;display:flex;align-items:center;gap:10px;
  padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:#fff
}
details.adv>summary::before{content:"";width:10px;height:10px;border:2px solid #111827;border-left:0;border-top:0;transform:rotate(45deg);transition:.2s}
details.adv[open]>summary::before{transform:rotate(-135deg)}
.adv-panel{display:none;margin-top:12px;border:1px solid var(--border);border-radius:16px;background:#fff;box-shadow:0 12px 24px rgba(2,6,23,.06)}
details.adv[open] .adv-panel{display:block}
.adv-grid{display:grid;gap:16px;padding:16px}
.ibox{border:1px solid var(--border);border-radius:12px;padding:14px}
.ibox .bar{margin:-6px -6px 10px;padding:8px 10px;border-radius:8px;background:#111827;color:#fff;font-weight:900}
.subgrid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.desc{font-size:12px;color:var(--muted)}
.actions{display:flex;flex-direction:column;gap:10px;align-items:center;margin-top:6px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:0;border-radius:10px;font-weight:900;cursor:pointer;transition:.05s}
.btn.primary{background:var(--accent);color:#fff;height:46px;max-width:420px;width:100%}
.btn.dark{background:#111827;color:#fff;height:38px;padding:0 12px}
.btn.secondary{background:#fff;border:1px solid var(--border);height:38px;padding:0 12px}
.sub-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.error{margin-top:8px;padding:10px;border-left:4px solid var(--bad);background:#fdecec;border-radius:10px;color:#7f1d1d}
.tabbar{display:flex;gap:8px;overflow:auto hidden;padding:10px 12px}
.tabbtn{border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 12px;height:34px;cursor:pointer;font-weight:900;white-space:nowrap}
.tabbtn.active{background:#e8f0ff;border-color:#c7d2fe}
.tab{display:none;padding:0 12px 16px}
.tab.active{display:block}
.viewctrl{display:flex;justify-content:flex-end;padding:0 12px 8px;gap:10px;align-items:center}
.viewctrl small{font-weight:900;color:#334155}
.switch{position:relative;display:inline-block;width:44px;height:24px}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#e5e7eb;border-radius:999px;transition:.2s}
.slider:before{content:"";position:absolute;height:18px;width:18px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 2px rgba(0,0,0,.3)}
.switch input:checked + .slider{background:#60a5fa}
.switch input:checked + .slider:before{transform:translateX(20px)}
.section{position:relative;border-left:4px solid #e5e7eb;padding:14px;margin:12px 0 8px;border-radius:10px;background:#fff;border:1px solid var(--border);box-shadow:0 6px 16px rgba(2,6,23,.04)}
.section.inps{border-left-color:#2563eb}
.section.imp{border-left-color:#16a34a}
.section.ex{border-left-color:#f59e0b}
.section h3{margin:0 0 6px;font-size:1.05rem;font-weight:900}
.kv{margin:4px 0}
.kv b{background:var(--hl);padding:.05em .25em;border-radius:.35em;border:1px solid #f3e89a}
.mono{font-variant-numeric:tabular-nums}
.copy-btn{position:absolute;right:-10px;top:-10px;padding:6px 10px;font-size:.75rem;font-weight:900;border:0;border-radius:999px;background:#111827;color:#fff;box-shadow:0 6px 14px rgba(2,6,23,.18);cursor:pointer;opacity:0;transition:opacity .15s,transform .15s;transform:translateY(2px)}
.section:hover .copy-btn{opacity:1;transform:none}
@media (max-width:900px){.copy-btn{display:none}}
table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border:1px solid var(--border)}
th,td{border:1px solid var(--border);padding:10px}
th{background:#f7f7fb;color:#475569;font-weight:900}
td:last-child,th:last-child{text-align:right;font-variant-numeric:tabular-nums}
tfoot th{background:#f1f5f9}
.badge{display:inline-block;padding:2px 8px;border:1px solid #c7d2fe;border-radius:9999px;background:#eef2ff;font-weight:800;font-size:.85em}
details.rates>summary{list-style:none;cursor:pointer;display:flex;align-items:center;gap:8px;font-weight:900;color:#111827;padding:10px 0}
details.rates[open]>summary{border-bottom:1px dashed #e5e7eb}
details.rates>summary::before{content:"";width:8px;height:8px;border:2px solid #111827;border-left:0;border-top:0;transform:rotate(45deg);transition:.2s}
details.rates[open]>summary::before{transform:rotate(-135deg)}
/* PRINT: solo risultati */
@media print{
  header,#formCard,.tabbar .tabbtn:not(.active),.viewctrl,.copy-btn{display:none!important}
  .wrap{max-width:1000px;padding:0;margin:0}
  .tab{display:block!important;padding:0}
  .card{border:none;box-shadow:none}
  @page{size:A4;margin:12mm}
}
</style>
</head>
<body>
<div class="wrap">
  <header><h1>Simulatore Forfettario per <u><span class="hl">Gestione Separata 2025</span></u></h1></header>

  <!-- FORM -->
  <section id="formCard" class="card pad" style="margin-bottom:16px">
    <div class="form" style="max-width:780px;margin:0 auto">
      <div>
        <label>Anno di riferimento <span class="hl">2025</span></label>
        <input value="2025" disabled/>
      </div>

      <div>
        <label for="incassato">Incassato annuo (€) <span class="hl">importo incassato dell’anno (GS + Ex-Enpals)</span></label>
        <input id="incassato" type="text" inputmode="numeric" placeholder="es. 50.000"/>
        <div id="chipsInc" class="chips">
          <button class="chip" data-val="10000">10.000</button>
          <button class="chip" data-val="20000">20.000</button>
          <button class="chip" data-val="30000">30.000</button>
          <button class="chip" data-val="50000">50.000</button>
          <button class="chip" data-val="65000">65.000</button>
          <button class="chip" data-val="85000">85.000</button>
        </div>

        <div class="inline-flag">
          <input type="checkbox" id="exFlag">
          <label for="exFlag" style="margin:0">Hai fatto prestazione con <span class="hl">Ex-Enpals</span>?</label>
        </div>
        <div id="exBox">
          <label for="incEx">Incassato Ex-Enpals (€) <span class="muted">(non può superare l’incassato annuo)</span></label>
          <input id="incEx" type="text" inputmode="numeric" placeholder="es. 12.000"/>
        </div>
      </div>

      <div>
        <label>Coefficiente di <span class="hl">redditività</span></label>
        <div id="chipsCoeff" class="chips">
          <button class="chip active" data-coeff="78">78%</button>
          <button class="chip" data-coeff="86">86%</button>
          <button class="chip" data-coeff="67">67%</button>
        </div>
      </div>

      <div>
        <label for="impSel">Percentuale <span class="hl">Imposta sostitutiva</span></label>
        <select id="impSel">
          <option value="0.05" selected>5% (primi 5 anni)</option>
          <option value="0.15">15% (ordinaria)</option>
        </select>
      </div>

      <details class="adv">
        <summary>Opzioni avanzate</summary>
        <div class="adv-panel">
          <div class="adv-grid">

            <div class="ibox">
              <div class="bar">Parametri INPS & acconti</div>
              <div class="subgrid">
                <div><label>Aliquota INPS GS (%)</label><input id="aliqInps" type="text" inputmode="decimal" value="26,07"></div>
                <div><label>Acconti imposta (%)</label><input id="accImpPerc" type="text" inputmode="numeric" value="100"></div>
                <div><label>Acconti INPS (%)</label><input id="accInpsPerc" type="text" inputmode="numeric" value="80"></div>
              </div>
              <div class="desc">Metodo storico: imposta 100% (50%+50%), INPS 80% (40%+40%).</div>
            </div>

            <div class="ibox">
              <div class="bar">Prestazioni Ex-Enpals</div>
              <div class="subgrid">
                <div>
                  <label>Aliquota Ex-Enpals</label>
                  <select id="aliqEx">
                    <option value="0.0919" selected>9,19%</option>
                    <option value="0.0989">9,89%</option>
                  </select>
                </div>
              </div>
              <div class="desc">Il contributo Ex-Enpals è trattenuto alla fonte e non rientra nelle scadenze.</div>
            </div>

            <div class="ibox">
              <div class="bar">Come impostare gli acconti dell’anno precedente</div>
              <div class="subgrid">
                <div><label>Acconti IMPOSTA versati (€)</label><input id="accImpPrev" type="text" inputmode="numeric" value="0"></div>
                <div><label>Acconti INPS versati (€)</label><input id="accInpsPrev" type="text" inputmode="numeric" value="0"></div>
              </div>
              <div class="desc">Se i tuoi acconti superano i saldi, l’eccedenza riduce i nuovi acconti da versare.</div>
            </div>

            <div class="ibox">
              <div class="bar">Contributi deducibili (per l’imposta)</div>
              <div class="subgrid">
                <div style="grid-column:1/-1">
                  <label>Contributi previdenziali già versati nell’anno (€) — deducibili solo per l’imposta</label>
                  <input id="deducibili" type="text" inputmode="numeric" value="0">
                </div>
              </div>
            </div>

          </div>
        </div>
      </details>

      <div class="actions">
        <button id="btnCalcola" class="btn primary">Calcola</button>
        <div class="sub-actions">
          <button id="btnStampa" class="btn dark">Stampa PDF</button>
          <button id="btnReset" class="btn secondary">Reset</button>
        </div>
      </div>

      <div id="err" class="error" style="display:none"></div>
    </div>
  </section>

  <!-- RISULTATI -->
  <section id="results" class="card" style="display:none">
    <div class="tabbar">
      <button class="tabbtn active" data-tab="t1">Come si calcolano</button>
      <button class="tabbtn" data-tab="t2">Risultati Tasse da pagare</button>
      <button class="tabbtn" data-tab="t3">Scadenze da pagare</button>
    </div>
    <div class="viewctrl">
      <small>Vista:</small>
      <label class="switch"><input id="vDett" type="checkbox" checked><span class="slider"></span></label>
      <small id="viewTxt">Dettagliata</small>
    </div>

    <!-- Come si calcolano -->
    <div id="t1" class="tab active">
      <div class="section" id="sec-intro">
        <button class="copy-btn" data-copy="#sec-intro">Copia</button>
        <h3>Quanto pago di tasse?</h3>
        <p class="kv" id="p1"></p>
        <p class="kv" id="p2"></p>
      </div>

      <div id="exBlock" class="section ex" style="display:none">
        <button class="copy-btn" data-copy="#exBlock">Copia</button>
        <h3>Prestazioni Ex-Enpals</h3>
        <p class="kv" id="ex-raw"></p>
        <p class="kv" id="ex-contrib"></p>
        <p class="kv" id="ex-netto"></p>
      </div>

      <div class="section inps" id="sec-inps">
        <button class="copy-btn" data-copy="#sec-inps">Copia</button>
        <h3>Contributi INPS – Gestione Separata</h3>
        <p class="kv" id="inps-base"></p>
        <p class="kv" id="inps-saldi"></p>
      </div>

      <div class="section imp" id="sec-imp">
        <button class="copy-btn" data-copy="#sec-imp">Copia</button>
        <h3>Imposta sostitutiva</h3>
        <p class="kv" id="imp-base"></p>
        <p class="kv" id="imp-saldi"></p>
      </div>

      <div class="section" id="sec-tot">
        <button class="copy-btn" data-copy="#sec-tot">Copia</button>
        <h3>Totale saldi da versare adesso</h3>
        <p class="kv" id="tot-saldi"></p>
      </div>
    </div>

    <!-- Risultati -->
    <div id="t2" class="tab">
      <table>
        <thead><tr><th>Voce</th><th>Importo</th></tr></thead>
        <tbody id="tbl-righe"></tbody>
        <tfoot>
          <tr><th>Totale saldi (imposta + INPS)</th><th id="tbl-tot"></th></tr>
          <tr><th>Primi acconti di giugno (50% imposta, 40% INPS)</th><th id="tbl-accGiu"></th></tr>
          <tr><th>Secondi acconti di novembre (50% imposta, 40% INPS)</th><th id="tbl-accNov"></th></tr>
          <tr><th>Totale anno (saldi + acconti)</th><th id="tbl-anno"></th></tr>
        </tfoot>
      </table>
    </div>

    <!-- Scadenze -->
    <div id="t3" class="tab">
      <table id="tblScadenze">
        <thead><tr><th>Scadenza</th><th>Importo</th></tr></thead>
        <tbody id="scadBody"></tbody>
        <tfoot><tr><th>Totale anno</th><th id="scadTot"></th></tr></tfoot>
      </table>

      <details class="rates" open>
        <summary>Mostra dettaglio rate di giugno in 5 rate (con interessi) + riga di novembre</summary>
        <table>
          <thead>
            <tr><th>#</th><th>Scadenza</th><th>Quota capitale</th><th>Interessi %</th><th>Interessi €</th><th>Rata da pagare</th></tr>
          </thead>
          <tbody id="rateBody"></tbody>
          <tfoot>
            <tr><th colspan="4">Totale interessi giugno</th><th id="rateInt"></th><th id="rateTot"></th></tr>
          </tfoot>
        </table>
      </details>
      <div class="desc" style="margin-top:8px">Il contributo <b>Ex-Enpals</b> non appare qui perché già trattenuto alla fonte.</div>
    </div>
  </section>
</div>

<script>
/* ==== util ==== */
const $ = s => document.querySelector(s);
const el = id => document.getElementById(id);
const fmt = n => (isFinite(n)? n.toLocaleString('it-IT') : '0');
const euro = n => fmt(Math.round(n));
const parseEuro = s => {
  if (typeof s!=='string') s = String(s??'');
  s = s.replace(/\./g,'').replace(',', '.').trim();
  const v = parseFloat(s);
  return isNaN(v)?0:v;
};
const parsePercTxt = s => parseEuro(s)/100;

/* Base INPS corretta: prima tolgo l'Ex-Enpals dal totale, poi applico il coefficiente */
function baseInpsCorretta(incTot, incEx, coeff){
  const baseLordo = Math.max(0, incTot - incEx);
  return baseLordo * (coeff/100);
}

/* ==== elementi ==== */
const incI=el('incassato'), chipsInc=el('chipsInc');
const exFlag=el('exFlag'), exBox=el('exBox'), incExI=el('incEx');
const chipsCoeff=el('chipsCoeff'); let coeff=78;
const impSel=el('impSel'), aliqInpsI=el('aliqInps'), aliqExSel=el('aliqEx');
const accImpPrevI=el('accImpPrev'), accInpsPrevI=el('accInpsPrev');
const accImpPercI=el('accImpPerc'), accInpsPercI=el('accInpsPerc');
const dedI=el('deducibili');
const err=el('err');
const res=el('results');

/* ==== ui events ==== */
chipsInc.addEventListener('click',e=>{
  const b=e.target.closest('.chip'); if(!b) return;
  incI.value=fmt(Number(b.dataset.val||0));
});
exFlag.addEventListener('change',()=>{exBox.style.display=exFlag.checked?'block':'none';});
chipsCoeff.addEventListener('click',e=>{
  const b=e.target.closest('.chip'); if(!b) return;
  chipsCoeff.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); coeff=Number(b.dataset.coeff||78);
});
document.querySelectorAll('.tabbtn').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.tabbtn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.getElementById(b.dataset.tab).classList.add('active');
  });
});
el('vDett').addEventListener('change',()=>{el('viewTxt').textContent=el('vDett').checked?'Dettagliata':'Semplificata';renderTexts();});
document.addEventListener('click',e=>{
  const btn=e.target.closest('.copy-btn'); if(!btn) return;
  const sel=btn.getAttribute('data-copy'); const n=document.querySelector(sel);
  if(!n) return;
  const txt=n.innerText.replace(/\n{2,}/g,'\n');
  navigator.clipboard.writeText(txt);
  btn.textContent='Copiato!'; setTimeout(()=>btn.textContent='Copia',900);
});
el('btnReset').addEventListener('click',()=>{
  incI.value=''; incExI.value=''; exFlag.checked=false; exBox.style.display='none';
  coeff=78; chipsCoeff.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
  chipsCoeff.querySelector('[data-coeff="78"]').classList.add('active');
  impSel.value='0.05'; aliqInpsI.value='26,07'; aliqExSel.value='0.0919';
  accImpPrevI.value='0'; accInpsPrevI.value='0'; accImpPercI.value='100'; accInpsPercI.value='80';
  dedI.value='0'; err.style.display='none'; res.style.display='none';
});
el('btnStampa').addEventListener('click',()=>window.print());

/* format on blur */
[incI,incExI,accImpPrevI,accInpsPrevI,dedI,aliqInpsI].forEach(inp=>{
  inp.addEventListener('blur',()=>{
    if(inp===aliqInpsI){ let v=inp.value.trim().replace('.',','); if(!v)v='26,07'; inp.value=v; return; }
    const v=parseEuro(inp.value); inp.value=v?fmt(v):'';
  });
});

/* ==== core calc ==== */
let state=null;
el('btnCalcola').addEventListener('click',()=>{
  err.style.display='none'; err.textContent='';
  const incTot = parseEuro(incI.value);
  const incEx  = exFlag.checked ? parseEuro(incExI.value) : 0;
  if(exFlag.checked && incEx>incTot){ err.style.display='block'; err.textContent='Errore: l’incassato Ex-Enpals non può superare l’incassato annuo.'; return; }

  const aliqInps = parsePercTxt(aliqInpsI.value||'26,07');
  const aliqImp  = parseFloat(impSel.value||'0.05');
  const aliqEx   = parseFloat(aliqExSel.value||'0.0919');
  const accImpPrev = parseEuro(accImpPrevI.value||'0');
  const accInpsPrev= parseEuro(accInpsPrevI.value||'0');
  const accImpPerc = Math.max(0,Math.min(100,parseEuro(accImpPercI.value||'100')))/100;
  const accInpsPerc= Math.max(0,Math.min(100,parseEuro(accInpsPercI.value||'80')))/100;
  const ded = parseEuro(dedI.value||'0');

  const imponibile = incTot*(coeff/100);               // imponibile per IMPOSTA
  const exContrib = incEx*aliqEx;                      // informativo
  const baseInps  = baseInpsCorretta(incTot,incEx,coeff);   // <<< LOGICA CORRETTA
  const inpsDov   = baseInps*aliqInps;
  const impBase   = Math.max(0,imponibile-ded);
  const impDov    = impBase*aliqImp;

  // saldi netti
  let saldoImp = Math.max(0, impDov - accImpPrev);
  let saldoInps= Math.max(0, inpsDov - accInpsPrev);
  const credImp = Math.max(0, accImpPrev - impDov);
  const credInps= Math.max(0, accInpsPrev - inpsDov);

  // nuovi acconti (storico) + riduzione per crediti
  let accImpTot = impDov*accImpPerc;
  let accInpsTot= inpsDov*accInpsPerc;
  accImpTot = Math.max(0, accImpTot - credImp);
  accInpsTot= Math.max(0, accInpsTot - credInps);

  // split
  const accImpG = accImpTot/2,  accImpN = accImpTot/2;
  const accInpsG= accInpsTot*0.40, accInpsN= accInpsTot*0.40;

  const giugno = saldoImp+saldoInps+accImpG+accInpsG;
  const novembre = accImpN+accInpsN;
  const totAnno = giugno+novembre;

  state = {incTot,incEx,coeff,aliqImp,aliqInps,aliqEx,imponibile,exContrib,baseInps,inpsDov,impBase,impDov,
           saldoImp,saldoInps,accImpTot,accInpsTot,accImpG,accImpN,accInpsG,accInpsN,giugno,novembre,totAnno, ded,
           accImpPrev,accInpsPrev,credImp,credInps};

  renderTexts();
  renderTables();
  renderScadenze();
  res.style.display='block';
});

/* ==== render ==== */
function renderTexts(){
  if(!state) return;
  const s=state, det=el('vDett').checked;

  const r1 = `Nel forfettario non tassi tutto l’incassato ma l’<b>imponibile</b> (= Incassato × Coefficiente).`;
  const r2 = `Con i tuoi dati: <b>${fmt(s.incTot)} € × ${s.coeff}% = ${fmt(s.imponibile)} €</b>.`;
  el('p1').innerHTML = det ? r1+' '+r2 : `Imponibile stimato: <b>${fmt(s.imponibile)} €</b> (da ${fmt(s.incTot)} € × ${s.coeff}%).`;
  el('p2').innerHTML = det
    ? `Paghi <b>INPS GS</b> al ${(s.aliqInps*100).toFixed(2)}% e <b>Imposta sostitutiva</b> al ${(s.aliqImp*100).toFixed(0)}%.`
    : `Aliquote: INPS ${(s.aliqInps*100).toFixed(2)}% • Imposta ${(s.aliqImp*100).toFixed(0)}%.`;

  if(s.incEx>0){
    el('exBlock').style.display='block';
    el('ex-raw').innerHTML = `Incasso Ex-Enpals: <b>${fmt(s.incEx)} €</b> (aliquota ${(s.aliqEx*100).toFixed(2)}%).`;
    el('ex-contrib').innerHTML = `Contributo trattenuto alla fonte: <b>${fmt(s.exContrib)} €</b>.`;
    el('ex-netto').innerHTML = `Netto effettivamente incassato su queste prestazioni: <b>${fmt(s.incEx - s.exContrib)} €</b>.`;
  }else{
    el('exBlock').style.display='none';
  }

  el('inps-base').innerHTML =
    `Base INPS = max(0, (${fmt(s.incTot)} € − ${fmt(s.incEx)} €) × ${s.coeff}%) → <b>${fmt(s.baseInps)} €</b>.`;
  el('inps-saldi').innerHTML = `Contributi dovuti: <b>${fmt(s.inpsDov)} €</b> − acconti versati <b>${fmt(s.accInpsPrev)} €</b> → <b>saldo INPS ${fmt(s.saldoInps)} €</b>.`;

  el('imp-base').innerHTML = `Base imposta = max(0, ${fmt(s.imponibile)} € − deducibili <b>${fmt(s.ded)} €</b>) → <b>${fmt(s.impBase)} €</b>.`;
  el('imp-saldi').innerHTML = `Imposta dovuta: <b>${fmt(s.impDov)} €</b> − acconti versati <b>${fmt(s.accImpPrev)} €</b> → <b>saldo imposta ${fmt(s.saldoImp)} €</b>.`;
  el('tot-saldi').innerHTML = `Totale saldi ora: <b>${fmt(s.saldoInps)} €</b> (INPS) + <b>${fmt(s.saldoImp)} €</b> (imposta) = <b>${fmt(s.saldoInps+s.saldoImp)} €</b>.`;
}

function renderTables(){
  const s=state, tb=el('tbl-righe'); tb.innerHTML='';
  const add=(k,v)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${k}</td><td class="mono">${euro(v)} €</td>`;tb.appendChild(tr);};
  add('Saldo INPS (dopo acconti versati)', s.saldoInps);
  add('Saldo imposta (dopo acconti versati)', s.saldoImp);
  el('tbl-tot').textContent = euro(s.saldoInps+s.saldoImp)+' €';
  el('tbl-accGiu').textContent = euro(s.accInpsG + s.accImpG)+' €';
  el('tbl-accNov').textContent = euro(s.accInpsN + s.accImpN)+' €';
  el('tbl-anno').textContent = euro(s.totAnno)+' €';
}

function renderScadenze(){
  const s=state, tbody=el('scadBody'); tbody.innerHTML='';
  const r1=document.createElement('tr'); r1.innerHTML=`<td><span class="badge">Giugno</span> — Saldi (imp.+INPS) + 1° acconti</td><td class="mono">${euro(s.giugno)} €</td>`;
  const r2=document.createElement('tr'); r2.innerHTML=`<td><span class="badge">Novembre</span> — 2° acconti</td><td class="mono">${euro(s.novembre)} €</td>`;
  const r3=document.createElement('tr'); r3.innerHTML=`<td style="font-weight:900">Totale anno</td><td class="mono" style="font-weight:900">${euro(s.totAnno)} €</td>`;
  tbody.appendChild(r1);tbody.appendChild(r2);
  el('scadTot').textContent=euro(s.totAnno)+' €';

  // rate giugno in 5
  const base = s.giugno;
  const quota = base/5;
  const perc = [0,0.18,0.51,0.84,1.17];
  const date = ['30 giugno','16 luglio','20 agosto','16 settembre','16 ottobre'];
  const rb = el('rateBody'); rb.innerHTML='';
  let totInt=0, totR=0;
  for(let i=0;i<5;i++){
    const int = quota*perc[i]/100;
    totInt+=int; const rata=quota+int; totR+=rata;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${date[i]}</td><td class="mono">${euro(quota)} €</td><td>${perc[i].toFixed(2)}%</td><td class="mono">${euro(int)} €</td><td class="mono"><b>${euro(rata)} €</b></td>`;
    rb.appendChild(tr);
  }
  const trN=document.createElement('tr');
  trN.innerHTML=`<td colspan="5" style="text-align:left"><span class="badge">Novembre</span> — secondi acconti</td><td class="mono"><b>${euro(s.novembre)} €</b></td>`;
  rb.appendChild(trN);
  el('rateInt').textContent=euro(totInt)+' €';
  el('rateTot').textContent=euro(totR)+' €';
}

/* stampa */
el('btnStampa').addEventListener('click',()=>window.print());
</script>
</body>
</html>
